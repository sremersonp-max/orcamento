<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Sistema de Or√ßamentos - Esquadrias</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            background: #34495e;
            border-bottom: 1px solid #2c3e50;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            text-align: center;
            background: #34495e;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: #3d566e;
        }

        .tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }

        /* Content Areas */
        .tab-content {
            display: none;
            padding: 0;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        /* Or√ßamento Section */
        .orcamento-section {
            padding: 25px 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cliente-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .produto-orcamento-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .produto-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }

        .resumo-orcamento {
            background: #2c3e50;
            color: white;
            padding: 25px 30px;
            margin-top: 20px;
            border-radius: 10px;
        }

        .resumo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .total-geral {
            font-size: 28px;
            font-weight: bold;
            color: #27ae60;
        }

        .acoes-orcamento {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .produto-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid #27ae60;
        }

        .preco-produto {
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
            text-align: center;
            margin-top: 10px;
        }

        /* Lista de Or√ßamentos */
        .lista-orcamentos-section {
            padding: 25px 30px;
            background: #f8f9fa;
        }

        .orcamentos-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .orcamento-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .orcamento-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .orcamento-header-card {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .orcamento-acoes {
            display: flex;
            gap: 10px;
            flex-direction: column; /* MODIFICADO para empilhar bot√µes */
            align-items: flex-end; /* MODIFICADO para alinhar bot√µes */
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-rascunho {
            background: #fff3cd;
            color: #856404;
        }

        .status-finalizado {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-aprovado {
            background: #d4edda;
            color: #155724;
        }

        /* Search Box */
        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        /* Sistema de Substitui√ß√£o */
        .substituivel-section {
            background: #e8f5e8;
            border: 2px dashed #28a745;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .opcao-substituivel {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #ddd;
        }
        
        .opcao-substituivel:hover {
            background: #f0f9f0;
            transform: translateX(5px);
            border-color: #28a745;
        }
        
        .opcao-substituivel.selecionada {
            background: #d4edda;
            border-left: 4px solid #155724;
            border-color: #155724;
        }
        
        .badge-substituivel {
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: bold;
        }

        .subtitulo-substituivel {
            color: #28a745;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Tabela de Itens no Resumo */
        .tabela-resumo {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .tabela-resumo th {
            background: rgba(52, 73, 94, 0.8);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #34495e;
        }

        .tabela-resumo td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .tabela-resumo tr:last-child td {
            border-bottom: none;
        }

        .tabela-resumo tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .valor-unitario {
            color: #27ae60;
            font-weight: bold;
        }

        .subtotal {
            color: #e67e22;
            font-weight: bold;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .cliente-info, .produto-header {
                grid-template-columns: 1fr;
            }
            
            .acoes-orcamento {
                flex-direction: column;
            }

            .orcamento-acoes {
                 flex-direction: row; /* Manter bot√µes de a√ß√£o do card em linha */
                 flex-wrap: wrap;
                 align-items: flex-start;
            }
            
            .orcamento-header-card {
                flex-direction: column;
                gap: 15px;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .produto-header {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .tabela-resumo {
                font-size: 12px;
            }

            .tabela-resumo th,
            .tabela-resumo td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Sistema de Or√ßamentos - Esquadrias</h1>
            <p>Sistema completo para gest√£o de or√ßamentos</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="openTab('orcamentos', event)">
                üìã Or√ßamentos
            </button>
            <button class="tab" onclick="openTab('produtos', event)">
                üßÆ Produtos
            </button>
            <button class="tab" onclick="openTab('estoque', event)">
                üì¶ Estoque
            </button>
        </div>

        <div id="orcamentos" class="tab-content active">
            <div class="orcamento-section">
                <h2 class="section-title">üìù Novo Or√ßamento</h2>
                <div class="cliente-info">
                    <div class="form-group">
                        <label for="nomeCliente">Nome do Cliente *</label>
                        <input type="text" id="nomeCliente" placeholder="Digite o nome do cliente">
                    </div>
                    <div class="form-group">
                        <label for="telefoneCliente">Telefone</label>
                        <input type="text" id="telefoneCliente" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group">
                        <label for="dataOrcamento">Data do Or√ßamento</label>
                        <input type="text" id="dataOrcamento" readonly>
                    </div>
                </div>
                <div class="cliente-info">
                    <div class="form-group">
                        <label for="localizacaoObra">Localiza√ß√£o da Obra</label>
                        <input type="text" id="localizacaoObra" placeholder="Endere√ßo da obra">
                    </div>
                    <div class="form-group">
                        <label for="observacoes">Observa√ß√µes</label>
                        <textarea id="observacoes" placeholder="Observa√ß√µes adicionais..." rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="statusOrcamento">Status</label>
                        <select id="statusOrcamento">
                            <option value="rascunho">Rascunho</option>
                            <option value="finalizado">Finalizado</option>
                            <option value="aprovado">Aprovado</option>
                        </select>
                    </div>
                </div>

                <h3 class="section-title">üõí Produtos do Or√ßamento</h3>
                
                <div id="listaProdutosOrcamento">
                    <div class="loading" id="loadingProdutos">Nenhum produto adicionado ao or√ßamento</div>
                </div>

                <button class="btn btn-primary" onclick="adicionarProdutoOrcamento()">
                    ‚ûï Adicionar Produto
                </button>

                <div class="resumo-orcamento">
                    <div class="resumo-header">
                        <h3 style="color: white; margin: 0;">üí∞ Resumo do Or√ßamento</h3>
                        <div class="total-geral" id="totalGeral">R$ 0,00</div>
                    </div>
                    
                    <div id="tabelaItensResumo">
                        <table class="tabela-resumo">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Vidro</th>
                                    <th>Valor Unit√°rio</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="corpoTabelaResumo">
                                </tbody>
                        </table>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; color: #bdc3c7; margin-top: 15px;">
                        <div>Total de Produtos: <span id="totalProdutos">0</span></div>
                        <div>Itens no Or√ßamento: <span id="totalItens">0</span></div>
                    </div>

                    <div class="acoes-orcamento">
                        <button class="btn btn-secondary" onclick="salvarOrcamento()">
                            üíæ Salvar Or√ßamento
                        </button>
                        <button class="btn btn-success" onclick="gerarPDF()">
                            üìÑ Gerar PDF
                        </button>
                        <button class="btn btn-primary" onclick="novoOr√ßamento()">
                            üÜï Novo Or√ßamento
                        </button>
                    </div>
                </div>
                </div>

            <div class="lista-orcamentos-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 class="section-title">üìã Or√ßamentos Cadastrados</h2>
                    <div class="search-box">
                        <input type="text" id="pesquisaOrcamentos" placeholder="üîç Pesquisar por cliente, localiza√ß√£o..." onkeyup="filtrarOrcamentos()">
                        <select id="filtroStatus" onchange="filtrarOrcamentos()">
                            <option value="">Todos os status</option>
                            <option value="rascunho">Rascunho</option>
                            <option value="finalizado">Finalizado</option>
                            <option value="aprovado">Aprovado</option>
                        </select>
                        <button class="btn btn-secondary" onclick="limparFiltros()">üîÑ Limpar</button>
                    </div>
                </div>
                
                <div id="listaOrcamentos" class="orcamentos-grid">
                    <div class="loading">Carregando or√ßamentos...</div>
                </div>
            </div>
        </div>

        <div id="produtos" class="tab-content">
            <div style="padding: 25px 30px;">
                <div class="header">
                    <h2 class="section-title">üßÆ Gest√£o de Produtos</h2>
                    <button class="btn btn-success" onclick="abrirProdutosExterno()">
                        üìã Abrir em Nova Aba
                    </button>
                </div>
                
                <div class="card">
                    <h3>üìä Resumo dos Produtos</h3>
                    <div id="resumoProdutos" class="loading">
                        Carregando resumo de produtos...
                    </div>
                </div>

                <div class="card">
                    <h3>üöÄ A√ß√µes R√°pidas</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="abrirProdutosExterno()">
                            üßÆ Gerenciar Produtos
                        </button>
                        <button class="btn btn-info" onclick="carregarResumoProdutos()">
                            üîÑ Atualizar Resumo
                        </button>
                        <button class="btn btn-success" onclick="criarProdutoRapido()">
                            ‚ö° Criar Produto R√°pido
                        </button>
                        <button class="btn btn-warning" onclick="verProdutosComSubstituiveis()">
                            üîç Ver Produtos com Substitu√≠veis
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>üìã Lista de Produtos</h3>
                    <div class="search-box">
                        <input type="text" id="pesquisaProdutosInterna" placeholder="üîç Pesquisar produtos..." onkeyup="filtrarProdutosInterna()">
                        <select id="filtroCategoriaProduto" onchange="filtrarProdutosInterna()">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>
                    <div id="listaProdutosInterna" class="orcamentos-grid">
                        <div class="loading">Carregando produtos...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="estoque" class="tab-content">
            <div style="padding: 25px 30px;">
                <div class="header">
                    <h2 class="section-title">üì¶ Gest√£o de Estoque</h2>
                    <button class="btn btn-success" onclick="abrirEstoqueExterno()">
                        üìã Abrir em Nova Aba
                    </button>
                </div>
                
                <div class="card">
                    <h3>üìä Resumo do Estoque</h3>
                    <div id="resumoEstoque">
                        <div class="loading">Carregando resumo do estoque...</div>
                    </div>
                </div>

                <div class="card">
                    <h‚ö†Ô∏è Alertas de Estoque</h3>
                    <div id="alertasEstoqueInterno">
                        <div class="loading">Verificando alertas...</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üöÄ A√ß√µes R√°pidas</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="abrirEstoqueExterno()">
                            üì¶ Gerenciar Estoque
                        </button>
                        <button class="btn btn-info" onclick="carregarResumoEstoque()">
                            üîÑ Atualizar Estoque
                        </button>
                        <button class="btn btn-success" onclick="adicionarItemRapido()">
                            ‚ö° Adicionar Item
                        </button>
                        <button class="btn btn-warning" onclick="verItensBaixoEstoque()">
                            üìâ Itens com Estoque Baixo
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>üìã Itens em Estoque</h3>
                    <div class="search-box">
                        <input type="text" id="pesquisaEstoqueInterno" placeholder="üîç Pesquisar itens..." onkeyup="filtrarEstoqueInterno()">
                        <select id="filtroCategoriaEstoque" onchange="filtrarEstoqueInterno()">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>
                    <div id="listaEstoqueInterno" class="orcamentos-grid">
                        <div class="loading">Carregando itens do estoque...</div>
                    </div>
                </div>
            </div>
        </div>

    <div class="modal" id="modalVisualizar">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitulo">Detalhes do Or√ßamento</h3>
                <button class="btn btn-danger btn-small" onclick="fecharModal()">‚úï Fechar</button>
            </div>
            <div id="modalConteudo">
                </div>
        </div>
    </div>

    <script src="config.js"></script>
    
    <script>
        // Vari√°veis globais
        let produtosCadastrados = [];
        let itensEstoque = [];
        let produtosOrcamento = [];
        let orcamentosCadastrados = [];
        let orcamentoAtual = {
            id: null,
            cliente: '',
            telefone: '',
            localizacao: '',
            observacoes: '',
            data: '',
            status: 'rascunho',
            produtos: [],
            total: 0
        };
        let editandoOrcamentoId = null;

        // =============================================================================
        // FUN√á√ïES PARA INTEGRA√á√ÉO COM PRODUTOS E ESTOQUE
        // =============================================================================

        // IN√çCIO abrirProdutosExterno
        function abrirProdutosExterno() {
            window.open('produtos.html', '_blank');
        }
        // FIM abrirProdutosExterno

        // IN√çCIO abrirEstoqueExterno
        function abrirEstoqueExterno() {
            window.open('estoque.html', '_blank');
        }
        // FIM abrirEstoqueExterno

        // IN√çCIO carregarResumoProdutos
        async function carregarResumoProdutos() {
            try {
                const { data: produtos, error } = await supabase
                    .from('produtos')
                    .select('id, nome, produto_categorias(nome)')
                    .eq('ativo', true);

                if (error) throw error;

                const totalProdutos = produtos.length;
                const categorias = [...new Set(produtos.map(p => p.produto_categorias.nome))];
                const produtosComSubstituiveis = produtos.filter(p => 
                    p.itens_composicao?.some(item => item.substituivel)
                ).length;

                document.getElementById('resumoProdutos').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${totalProdutos}</div>
                            <div>Total de Produtos</div>
                        </div>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${categorias.length}</div>
                            <div>Categorias</div>
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${produtosComSubstituiveis}</div>
                            <div>Com Itens Substitu√≠veis</div>
                        </div>
                    </div>
                `;

                await carregarListaProdutosInterna();
            } catch (error) {
                console.error('Erro ao carregar resumo de produtos:', error);
                document.getElementById('resumoProdutos').innerHTML = '<div class="error">Erro ao carregar produtos</div>';
            }
        }
        // FIM carregarResumoProdutos

        // IN√çCIO carregarListaProdutosInterna
        async function carregarListaProdutosInterna() {
            try {
                const { data: produtos, error } = await supabase
                    .from('produtos')
                    .select('id, nome, produto_categorias(nome), itens_composicao')
                    .eq('ativo', true)
                    .order('nome');

                if (error) throw error;

                // Atualizar filtro de categorias
                const categorias = [...new Set(produtos.map(p => p.produto_categorias.nome))];
                const filtroSelect = document.getElementById('filtroCategoriaProduto');
                filtroSelect.innerHTML = '<option value="">Todas as categorias</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    filtroSelect.appendChild(option);
                });

                // Exibir produtos
                exibirProdutosInterna(produtos);
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                document.getElementById('listaProdutosInterna').innerHTML = '<div class="error">Erro ao carregar produtos</div>';
            }
        }
        // FIM carregarListaProdutosInterna

        // IN√çCIO exibirProdutosInterna
        function exibirProdutosInterna(produtos) {
            const lista = document.getElementById('listaProdutosInterna');
            
            if (produtos.length === 0) {
                lista.innerHTML = '<div class="loading">Nenhum produto encontrado</div>';
                return;
            }

            lista.innerHTML = produtos.map(produto => {
                const itensSubstituiveis = produto.itens_composicao?.filter(item => item.substituivel).length || 0;
                const badgeSubstituivel = itensSubstituiveis > 0 ? 
                    `<span class="badge-substituivel">${itensSubstituiveis} substitu√≠vel(is)</span>` : '';

                return `
                    <div class="orcamento-card">
                        <div class="orcamento-header-card">
                            <div>
                                <strong style="font-size: 16px;">${produto.nome}</strong>
                                <span class="categoria-badge">${produto.produto_categorias.nome}</span>
                                ${badgeSubstituivel}
                                <div style="margin-top: 5px; color: #666; font-size: 14px;">
                                    ${produto.itens_composicao?.length || 0} itens na composi√ß√£o
                                </div>
                            </div>
                            <div class="orcamento-acoes">
                                <button class="btn btn-view btn-small" onclick="visualizarProdutoInterno(${produto.id})">
                                    üëÅÔ∏è Ver
                                </button>
                                <button class="btn btn-primary btn-small" onclick="usarProdutoNoOrcamento(${produto.id})">
                                    ‚ûï Usar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        // FIM exibirProdutosInterna

        // IN√çCIO filtrarProdutosInterna
        function filtrarProdutosInterna() {
            const termo = document.getElementById('pesquisaProdutosInterna').value.toLowerCase();
            const categoria = document.getElementById('filtroCategoriaProduto').value;
            
            // Recarregar e filtrar (em uma implementa√ß√£o real, faria uma nova consulta)
            carregarListaProdutosInterna().then(() => {
                const cards = document.querySelectorAll('#listaProdutosInterna .orcamento-card');
                cards.forEach(card => {
                    const texto = card.textContent.toLowerCase();
                    const categoriaCard = card.querySelector('.categoria-badge')?.textContent || '';
                    
                    const matchTermo = texto.includes(termo);
                    const matchCategoria = !categoria || categoriaCard === categoria;
                    
                    card.style.display = (matchTermo && matchCategoria) ? 'block' : 'none';
                });
            });
        }
        // FIM filtrarProdutosInterna

        // IN√çCIO visualizarProdutoInterno
        function visualizarProdutoInterno(id) {
            const produto = produtosCadastrados.find(p => p.id === id);
            if (!produto) return;

            let conteudo = `
                <div style="margin-bottom: 20px;">
                    <strong>Nome:</strong> ${produto.nome}<br>
                    <strong>Categoria:</strong> ${produto.produto_categorias.nome}<br>
                    <strong>Itens na Composi√ß√£o:</strong> ${produto.itens_composicao?.length || 0}
                </div>
                
                <div style="margin-bottom: 20px;">
                    <strong>Itens da Composi√ß√£o:</strong>
                    <div style="margin-top: 15px;">
            `;

            (produto.itens_composicao || []).forEach((item, index) => {
                const badgeSubstituivel = item.substituivel ? '<span class="badge-substituivel">SUBSTITU√çVEL</span>' : '';
                conteudo += `
                    <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 6px;">
                        <strong>${index + 1}. ${item.item_nome}</strong> ${badgeSubstituivel}
                        <div style="font-size: 12px; color: #666;">
                            <strong>F√≥rmula:</strong> ${item.formula} | 
                            <strong>Unidade:</strong> ${item.item_unidade}
                            ${item.substituivel ? '| <strong>Pode ser substitu√≠do</strong>' : ''}
                        </div>
                    </div>
                `;
            });

            conteudo += `
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="usarProdutoNoOrcamento(${produto.id}); fecharModal();">
                        ‚ûï Usar no Or√ßamento
                    </button>
                </div>
            `;

            document.getElementById('modalTitulo').textContent = `üßÆ ${produto.nome}`;
            document.getElementById('modalConteudo').innerHTML = conteudo;
            document.getElementById('modalVisualizar').style.display = 'flex';
        }
        // FIM visualizarProdutoInterno

        // IN√çCIO usarProdutoNoOrcamento
        function usarProdutoNoOrcamento(produtoId) {
            // Fechar modal se estiver aberto
            fecharModal();
            
            // Voltar para aba de or√ßamentos
            openTab('orcamentos');
            
            // Adicionar produto ao or√ßamento ap√≥s um pequeno delay
            setTimeout(() => {
                adicionarProdutoOrcamento();
                
                // Selecionar o produto no select (ap√≥s o DOM ser atualizado)
                setTimeout(() => {
                    const ultimoProduto = produtosOrcamento[produtosOrcamento.length - 1];
                    if (ultimoProduto) {
                        const select = document.querySelector(`#${ultimoProduto.id} select`);
                        if (select) {
                            select.value = produtoId;
                            atualizarProdutoOrcamento(ultimoProduto.id, produtoId);
                        }
                    }
                }, 100);
            }, 300);
        }
        // FIM usarProdutoNoOrcamento

        // IN√çCIO carregarResumoEstoque
        async function carregarResumoEstoque() {
            try {
                const { data: itens, error } = await supabase
                    .from('itens')
                    .select('id, nome, quantidade_estoque, quantidade_minima, unidade_medida, preco_venda, categorias(nome)')
                    .eq('ativo', true);

                if (error) throw error;

                const totalItens = itens.length;
                const categorias = [...new Set(itens.map(i => i.categorias.nome))];
                const itensBaixoEstoque = itens.filter(item => 
                    item.quantidade_estoque <= item.quantidade_minima
                ).length;

                document.getElementById('resumoEstoque').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${totalItens}</div>
                            <div>Total de Itens</div>
                        </div>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${categorias.length}</div>
                            <div>Categorias</div>
                        </div>
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #d32f2f;">${itensBaixoEstoque}</div>
                            <div>Estoque Baixo</div>
                        </div>
                    </div>
                `;

                await carregarAlertasEstoque();
                await carregarListaEstoqueInterno();
            } catch (error) {
                console.error('Erro ao carregar resumo do estoque:', error);
                document.getElementById('resumoEstoque').innerHTML = '<div class="error">Erro ao carregar estoque</div>';
            }
        }
        // FIM carregarResumoEstoque

        // IN√çCIO carregarAlertasEstoque
        async function carregarAlertasEstoque() {
            try {
                const { data: itens, error } = await supabase
                    .from('itens')
                    .select('nome, quantidade_estoque, quantidade_minima, unidade_medida')
                    .eq('ativo', true);

                if (error) throw error;

                const itensComAlerta = itens.filter(item => 
                    item.quantidade_estoque <= item.quantidade_minima
                );

                const alertasDiv = document.getElementById('alertasEstoqueInterno');
                
                if (itensComAlerta.length > 0) {
                    alertasDiv.innerHTML = `
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px;">
                            <strong>‚ö†Ô∏è Alertas de Estoque Baixo:</strong>
                            ${itensComAlerta.map(item => `
                                <div style="margin-top: 8px;">
                                    ${item.nome} - Estoque: ${item.quantidade_estoque} ${item.unidade_medida} 
                                    (M√≠nimo: ${item.quantidade_minima})
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    alertasDiv.innerHTML = `
                        <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 15px; border-radius: 4px;">
                            ‚úÖ Todos os itens est√£o com estoque adequado
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
                document.getElementById('alertasEstoqueInterno').innerHTML = '<div class="error">Erro ao carregar alertas</div>';
            }
        }
        // FIM carregarAlertasEstoque

        // IN√çCIO carregarListaEstoqueInterno
        async function carregarListaEstoqueInterno() {
            try {
                const { data: itens, error } = await supabase
                    .from('itens')
                    .select('id, nome, quantidade_estoque, quantidade_minima, unidade_medida, preco_venda, categorias(nome)')
                    .eq('ativo', true)
                    .order('nome');

                if (error) throw error;

                // Atualizar filtro de categorias
                const categorias = [...new Set(itens.map(i => i.categorias.nome))];
                const filtroSelect = document.getElementById('filtroCategoriaEstoque');
                filtroSelect.innerHTML = '<option value="">Todas as categorias</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    filtroSelect.appendChild(option);
                });

                // Exibir itens
                exibirEstoqueInterno(itens);
            } catch (error) {
                console.error('Erro ao carregar estoque:', error);
                document.getElementById('listaEstoqueInterno').innerHTML = '<div class="error">Erro ao carregar estoque</div>';
            }
        }
        // FIM carregarListaEstoqueInterno

        // IN√çCIO exibirEstoqueInterno
        function exibirEstoqueInterno(itens) {
            const lista = document.getElementById('listaEstoqueInterno');
            
            if (itens.length === 0) {
                lista.innerHTML = '<div class="loading">Nenhum item encontrado</div>';
                return;
            }

            lista.innerHTML = itens.map(item => {
                const estoqueBaixo = item.quantidade_estoque <= item.quantidade_minima;
                const statusClass = estoqueBaixo ? 'estoque-baixo' : 'estoque-ok';
                const statusIcon = estoqueBaixo ? '‚ö†Ô∏è' : '‚úÖ';

                return `
                    <div class="orcamento-card ${statusClass}">
                        <div class="orcamento-header-card">
                            <div>
                                <strong style="font-size: 16px;">${item.nome}</strong>
                                <span class="categoria-badge">${item.categorias.nome}</span>
                                <div style="margin-top: 5px; color: #666; font-size: 14px;">
                                    ${statusIcon} Estoque: ${item.quantidade_estoque} ${item.unidade_medida} 
                                    (M√≠nimo: ${item.quantidade_minima})
                                </div>
                                <div style="color: #333; font-size: 14px;">
                                    <strong>Pre√ßo: R$ ${(item.preco_venda || 0).toFixed(2)}</strong>
                                </div>
                            </div>
                            <div class="orcamento-acoes">
                                <button class="btn btn-view btn-small" onclick="visualizarItemEstoque(${item.id})">
                                    üëÅÔ∏è Ver
                                </button>
                                <button class="btn btn-info btn-small" onclick="abrirEstoqueExterno()">
                                    ‚úèÔ∏è Editar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        // FIM exibirEstoqueInterno

        // IN√çCIO filtrarEstoqueInterno
        function filtrarEstoqueInterno() {
            const termo = document.getElementById('pesquisaEstoqueInterno').value.toLowerCase();
            const categoria = document.getElementById('filtroCategoriaEstoque').value;
            
            // Recarregar e filtrar
            carregarListaEstoqueInterno().then(() => {
                const cards = document.querySelectorAll('#listaEstoqueInterno .orcamento-card');
                cards.forEach(card => {
                    const texto = card.textContent.toLowerCase();
                    const categoriaCard = card.querySelector('.categoria-badge')?.textContent || '';
                    
                    const matchTermo = texto.includes(termo);
                    const matchCategoria = !categoria || categoriaCard === categoria;
                    
                    card.style.display = (matchTermo && matchCategoria) ? 'block' : 'none';
                });
            });
        }
        // FIM filtrarEstoqueInterno

        // IN√çCIO visualizarItemEstoque
        function visualizarItemEstoque(itemId) {
            const item = itensEstoque.find(i => i.id === itemId);
            if (!item) return;

            const estoqueBaixo = item.quantidade_estoque <= item.quantidade_minima;
            const statusText = estoqueBaixo ? '‚ö†Ô∏è ESTOQUE BAIXO' : '‚úÖ ESTOQUE OK';

            let conteudo = `
                <div style="margin-bottom: 20px;">
                    <strong>Nome:</strong> ${item.nome}<br>
                    <strong>Categoria:</strong> ${item.categorias?.nome || 'N√£o informada'}<br>
                    <strong>Status:</strong> <span style="color: ${estoqueBaixo ? '#dc3545' : '#28a745'}">${statusText}</span><br>
                    <strong>Estoque Atual:</strong> ${item.quantidade_estoque} ${item.unidade_medida}<br>
                    <strong>Estoque M√≠nimo:</strong> ${item.quantidade_minima} ${item.unidade_medida}<br>
                    <strong>Pre√ßo de Venda:</strong> R$ ${(item.preco_venda || 0).toFixed(2)}<br>
                    ${item.descricao ? `<strong>Descri√ß√£o:</strong> ${item.descricao}<br>` : ''}
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-warning" onclick="abrirEstoqueExterno()">
                        ‚úèÔ∏è Editar no Estoque
                    </button>
                </div>
            `;

            document.getElementById('modalTitulo').textContent = `üì¶ ${item.nome}`;
            document.getElementById('modalConteudo').innerHTML = conteudo;
            document.getElementById('modalVisualizar').style.display = 'flex';
        }
        // FIM visualizarItemEstoque

        // IN√çCIO criarProdutoRapido
        function criarProdutoRapido() {
            abrirProdutosExterno();
        }
        // FIM criarProdutoRapido

        // IN√çCIO verProdutosComSubstituiveis
        function verProdutosComSubstituiveis() {
            document.getElementById('filtroCategoriaProduto').value = '';
            document.getElementById('pesquisaProdutosInterna').value = 'substitu√≠vel';
            filtrarProdutosInterna();
        }
        // FIM verProdutosComSubstituiveis

        // IN√çCIO adicionarItemRapido
        function adicionarItemRapido() {
            abrirEstoqueExterno();
        }
        // FIM adicionarItemRapido

        // IN√çCIO verItensBaixoEstoque
        function verItensBaixoEstoque() {
            const cards = document.querySelectorAll('#listaEstoqueInterno .orcamento-card');
            cards.forEach(card => {
                const isBaixoEstoque = card.classList.contains('estoque-baixo');
                card.style.display = isBaixoEstoque ? 'block' : 'none';
            });
        }
        // FIM verItensBaixoEstoque

        // =============================================================================
        // INICIALIZA√á√ÉO DAS ABAS
        // =============================================================================

        // IN√çCIO openTab
        function openTab(tabName, event) {
            // Esconder todas as abas
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remover active de todos os bot√µes
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Mostrar aba selecionada
            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Ativar bot√£o da aba (s√≥ se foi chamado por clique)
            if (event) {
                event.currentTarget.classList.add('active');
            } else {
                // Se foi chamado programaticamente, encontrar o bot√£o correto
                const activeTab = document.querySelector(`.tab[onclick*="openTab('${tabName}')"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            }
            
            // Carregar dados se necess√°rio
            if (tabName === 'orcamentos') {
                carregarOrcamentos();
            } else if (tabName === 'produtos') {
                setTimeout(() => {
                    carregarResumoProdutos();
                }, 100);
            } else if (tabName === 'estoque') {
                setTimeout(() => {
                    carregarResumoEstoque();
                }, 100);
            }
        }
        // FIM openTab

        // =============================================================================
        // FUN√á√ïES DE INICIALIZA√á√ÉO
        // =============================================================================

        // IN√çCIO atualizarData
        function atualizarData() {
            const now = new Date();
            const dataFormatada = now.toLocaleDateString('pt-BR');
            const dataInput = document.getElementById('dataOrcamento');
            if (dataInput) {
                dataInput.value = dataFormatada;
            }
            orcamentoAtual.data = dataFormatada;
        }
        // FIM atualizarData

        // IN√çCIO carregarProdutos
        async function carregarProdutos() {
            try {
                const { data, error } = await supabase
                    .from('produtos')
                    .select(`*, produto_categorias(nome)`)
                    .eq('ativo', true)
                    .order('nome');
                
                if (error) throw error;
                
                produtosCadastrados = data || [];
                console.log('‚úÖ Produtos carregados:', produtosCadastrados.length);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                produtosCadastrados = [];
            }
        }
        // FIM carregarProdutos

        // IN√çCIO carregarItensEstoque
        async function carregarItensEstoque() {
            try {
                const { data, error } = await supabase
                    .from('itens')
                    .select('id, nome, preco_venda, unidade_medida, variacoes, categorias(nome)')
                    .eq('ativo', true);
                
                if (error) throw error;
                
                itensEstoque = data || [];
                console.log('‚úÖ Itens carregados:', itensEstoque.length);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar itens:', error);
                itensEstoque = [];
            }
        }
        // FIM carregarItensEstoque

        // =============================================================================
        // FUN√á√ïES DO OR√áAMENTO - COM SISTEMA SUBSTITU√çVEL
        // =============================================================================

        // IN√çCIO adicionarProdutoOrcamento
        function adicionarProdutoOrcamento() {
            const produtoId = 'produto_' + Date.now();
            
            const produtoHTML = `
                <div class="produto-orcamento-card" id="${produtoId}">
                    <div class="produto-header">
                        <div class="form-group">
                            <label>Produto</label>
                            <select onchange="atualizarProdutoOrcamento('${produtoId}', this.value)">
                                <option value="">Selecione um produto...</option>
                                ${produtosCadastrados.map(produto => `
                                    <option value="${produto.id}">${produto.nome} (${produto.produto_categorias?.nome || 'Sem categoria'})</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Largura (m)</label>
                            <input type="number" placeholder="1.20" min="0.1" step="0.01" 
                                   onchange="calcularProdutoOrcamento('${produtoId}')" 
                                   id="${produtoId}_largura">
                        </div>
                        
                        <div class="form-group">
                            <label>Altura (m)</label>
                            <input type="number" placeholder="2.00" min="0.1" step="0.01" 
                                   onchange="calcularProdutoOrcamento('${produtoId}')" 
                                   id="${produtoId}_altura">
                        </div>
                        
                        <div class="form-group">
                            <label>Quantidade</label>
                            <input type="number" placeholder="1" min="1" value="1" 
                                   onchange="calcularProdutoOrcamento('${produtoId}')" 
                                   id="${produtoId}_quantidade">
                        </div>
                        
                        <button class="btn btn-danger btn-small" onclick="removerProdutoOrcamento('${produtoId}')">
                            üóëÔ∏è
                        </button>
                    </div>

                    <div id="${produtoId}_substituiveis" class="hidden">
                        </div>
                    
                    <div id="${produtoId}_info" class="produto-info hidden">
                        </div>
                    
                    <div id="${produtoId}_preco" class="preco-produto hidden">
                        R$ 0,00
                    </div>
                </div>
            `;
            
            const loadingElement = document.getElementById('loadingProdutos');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
            
            const listaElement = document.getElementById('listaProdutosOrcamento');
            if (listaElement) {
                listaElement.insertAdjacentHTML('beforeend', produtoHTML);
            }
            
            // Adicionar ao array de produtos
            produtosOrcamento.push({
                id: produtoId,
                produtoId: '',
                largura: 0,
                altura: 0,
                quantidade: 1,
                substituicoes: {}, // Armazena as escolhas de itens substitu√≠veis
                preco: 0,
                detalhes: []
            });
            
            atualizarResumoOrcamento();
        }
        // FIM adicionarProdutoOrcamento

        // IN√çCIO atualizarProdutoOrcamento
        function atualizarProdutoOrcamento(produtoDivId, produtoId) {
            const produtoIndex = produtosOrcamento.findIndex(p => p.id === produtoDivId);
            if (produtoIndex !== -1) {
                produtosOrcamento[produtoIndex].produtoId = produtoId;
                
                // Verificar se o produto tem itens substitu√≠veis
                const produto = produtosCadastrados.find(p => p.id == produtoId);
                if (produto && produto.itens_composicao) {
                    const itensSubstituiveis = produto.itens_composicao.filter(item => item.substituivel);
                    if (itensSubstituiveis.length > 0) {
                        mostrarOpcoesSubstituiveis(produtoDivId, produto, itensSubstituiveis);
                    } else {
                        // Esconder se√ß√£o de substitu√≠veis se n√£o houver
                        const container = document.getElementById(`${produtoDivId}_substituiveis`);
                        if (container) {
                            container.classList.add('hidden');
                        }
                    }
                }
                
                calcularProdutoOrcamento(produtoDivId);
            }
        }
        // FIM atualizarProdutoOrcamento

        // IN√çCIO mostrarOpcoesSubstituiveis
        function mostrarOpcoesSubstituiveis(produtoDivId, produto, itensSubstituiveis) {
            const container = document.getElementById(`${produtoDivId}_substituiveis`);
            if (!container) return;

            let html = `<div class="substituivel-section">`;
            
            itensSubstituiveis.forEach(itemSubstituivel => {
                // Buscar itens do mesmo tipo (ex: vidros)
                const opcoesSubstituto = itensEstoque.filter(item => {
                    // Filtra por categoria "Vidros" ou por nome que contenha "vidro"
                    return item.categorias?.nome === 'Vidros' || 
                           item.nome.toLowerCase().includes('vidro') ||
                           (itemSubstituivel.tipo_item && item.categorias?.nome === itemSubstituivel.tipo_item);
                });
                
                if (opcoesSubstituto.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <div class="subtitulo-substituivel">
                                üîÑ ${itemSubstituivel.item_nome} - Escolha o tipo:
                            </div>
                            <div style="margin-top: 10px;">
                                ${opcoesSubstituto.map(substituto => `
                                    <div class="opcao-substituivel" 
                                         onclick="selecionarSubstituicao('${produtoDivId}', ${itemSubstituivel.item_id}, ${substituto.id})"
                                         id="${produtoDivId}_opcao_${itemSubstituivel.item_id}_${substituto.id}">
                                        <strong>${substituto.nome}</strong>
                                        <span class="badge-substituivel">R$ ${(substituto.preco_venda || 0).toFixed(2)}/${substituto.unidade_medida || 'UN'}</span>
                                        ${substituto.descricao ? `<br><small style="color: #666;">${substituto.descricao}</small>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            html += `</div>`;
            container.innerHTML = html;
            container.classList.remove('hidden');
        }
        // FIM mostrarOpcoesSubstituiveis

        // IN√çCIO selecionarSubstituicao
        function selecionarSubstituicao(produtoDivId, itemOriginalId, itemSubstitutoId) {
            const produtoIndex = produtosOrcamento.findIndex(p => p.id === produtoDivId);
            if (produtoIndex === -1) return;

            // Remover sele√ß√£o anterior para este item
            const opcoes = document.querySelectorAll(`[id^="${produtoDivId}_opcao_${itemOriginalId}_"]`);
            opcoes.forEach(opcao => opcao.classList.remove('selecionada'));

            // Marcar op√ß√£o selecionada
            const opcaoSelecionada = document.getElementById(`${produtoDivId}_opcao_${itemOriginalId}_${itemSubstitutoId}`);
            if (opcaoSelecionada) {
                opcaoSelecionada.classList.add('selecionada');
            }

            // Salvar a substitui√ß√£o
            if (!produtosOrcamento[produtoIndex].substituicoes) {
                produtosOrcamento[produtoIndex].substituicoes = {};
            }
            produtosOrcamento[produtoIndex].substituicoes[itemOriginalId] = itemSubstitutoId;

            // Recalcular
            calcularProdutoOrcamento(produtoDivId);
        }
        // FIM selecionarSubstituicao

        // IN√çCIO calcularProdutoOrcamento
        function calcularProdutoOrcamento(produtoDivId) {
            const produtoIndex = produtosOrcamento.findIndex(p => p.id === produtoDivId);
            if (produtoIndex === -1) return;

            const produtoOrcamento = produtosOrcamento[produtoIndex];
            const produto = produtosCadastrados.find(p => p.id == produtoOrcamento.produtoId);
            
            if (!produto) return;

            // Obter valores dos inputs
            const larguraElement = document.getElementById(`${produtoDivId}_largura`);
            const alturaElement = document.getElementById(`${produtoDivId}_altura`);
            const quantidadeElement = document.getElementById(`${produtoDivId}_quantidade`);
            
            const largura = larguraElement ? parseFloat(larguraElement.value) || 0 : 0;
            const altura = alturaElement ? parseFloat(alturaElement.value) || 0 : 0;
            const quantidade = quantidadeElement ? parseInt(quantidadeElement.value) || 1 : 1;

            // Atualizar objeto
            produtoOrcamento.largura = largura;
            produtoOrcamento.altura = altura;
            produtoOrcamento.quantidade = quantidade;

            // Calcular pre√ßo com substitui√ß√µes
            const resultado = calcularPrecoProdutoComSubstituicoes(produto, largura, altura, quantidade, produtoOrcamento.substituicoes);
            produtoOrcamento.preco = resultado.precoTotal;
            produtoOrcamento.detalhes = resultado.detalhes;

            // Atualizar interface
            atualizarInterfaceProduto(produtoDivId, produtoOrcamento, produto.nome);
            atualizarResumoOrcamento();
        }
        // FIM calcularProdutoOrcamento

        // IN√çCIO calcularPrecoProdutoComSubstituicoes
        function calcularPrecoProdutoComSubstituicoes(produto, largura, altura, quantidade, substituicoes = {}) {
            const itensComposicao = produto.itens_composicao || [];
            let precoTotal = 0;
            const detalhes = [];

            const L = largura;
            const A = altura;

            // Calcular para cada item da composi√ß√£o
            itensComposicao.forEach(item => {
                let itemCalculado = item;
                
                // Verificar se √© substitu√≠vel e foi substitu√≠do
                if (item.substituivel && substituicoes[item.item_id]) {
                    const itemSubstituto = itensEstoque.find(i => i.id == substituicoes[item.item_id]);
                    if (itemSubstituto) {
                        itemCalculado = {
                            ...item,
                            item_id: itemSubstituto.id,
                            item_nome: itemSubstituto.nome,
                            item_preco: itemSubstituto.preco_venda,
                            item_unidade: itemSubstituto.unidade_medida,
                            substituido: true,
                            original_nome: item.item_nome
                        };
                    }
                }

                const itemEstoque = itensEstoque.find(i => i.id == itemCalculado.item_id);
                const precoBase = itemCalculado.item_preco || itemEstoque?.preco_venda || 0;
                
                let quantidadeCalculada = 0;
                let precoItem = 0;

                // Calcular quantidade baseada na f√≥rmula
                try {
                    quantidadeCalculada = calcularQuantidadeFormula(itemCalculado.formula, L, A);
                    precoItem = quantidadeCalculada * precoBase;
                    precoTotal += precoItem;

                    // Adicionar aos detalhes
                    detalhes.push({
                        nome: itemCalculado.substituido ? 
                            `üîÑ ${itemCalculado.item_nome} (substituiu ${itemCalculado.original_nome})` : 
                            itemCalculado.item_nome,
                        formula: itemCalculado.formula,
                        quantidade: quantidadeCalculada,
                        precoUnitario: precoBase,
                        precoTotal: precoItem,
                        unidade: itemCalculado.item_unidade || itemEstoque?.unidade_medida || 'UN',
                        substituido: itemCalculado.substituido || false
                    });

                } catch (error) {
                    detalhes.push({
                        nome: itemCalculado.item_nome,
                        formula: itemCalculado.formula,
                        erro: `Erro no c√°lculo: ${error.message}`
                    });
                }
            });

            // Aplicar quantidade (m√∫ltiplas unidades)
            precoTotal *= quantidade;

            return {
                precoTotal: precoTotal,
                detalhes: detalhes,
                quantidade: quantidade,
                dimensoes: { largura, altura }
            };
        }
        // FIM calcularPrecoProdutoComSubstituicoes

        // IN√çCIO calcularQuantidadeFormula
        function calcularQuantidadeFormula(formula, L, A) {
            if (!formula || formula.trim() === '') return 1;
            
            const formulaLower = formula.toLowerCase().trim();
            
            // Substituir vari√°veis
            let expressao = formulaLower
                .replace(/l/g, L.toString())
                .replace(/a/g, A.toString());
            
            try {
                // Avaliar a express√£o matem√°tica
                const resultado = eval(expressao);
                return parseFloat(resultado) || 0;
            } catch (error) {
                throw new Error(`F√≥rmula inv√°lida: "${formula}"`);
            }
        }
        // FIM calcularQuantidadeFormula

        // IN√çCIO atualizarInterfaceProduto
        function atualizarInterfaceProduto(produtoDivId, produtoOrcamento, nomeProduto) {
            const infoDiv = document.getElementById(`${produtoDivId}_info`);
            const precoDiv = document.getElementById(`${produtoDivId}_preco`);
            
            if (infoDiv && precoDiv) {
                if (produtoOrcamento.preco > 0) {
                    // Mostrar detalhes
                    let detalhesHTML = `
                        <strong>${nomeProduto}</strong><br>
                        <small>Dimens√µes: ${produtoOrcamento.largura}m √ó ${produtoOrcamento.altura}m | Quantidade: ${produtoOrcamento.quantidade}</small>
                        <div style="margin-top: 10px; font-size: 12px;">
                            <strong>Detalhes do c√°lculo:</strong>
                    `;
                    
                    produtoOrcamento.detalhes.forEach(detalhe => {
                        if (detalhe.erro) {
                            detalhesHTML += `
                                <div class="item-calc" style="color: #e74c3c;">
                                    ‚ùå ${detalhe.nome}<br>
                                    <small>${detalhe.erro}</small>
                                </div>
                            `;
                        } else {
                            const icone = detalhe.substituido ? 'üîÑ' : '‚úÖ';
                            detalhesHTML += `
                                <div class="item-calc">
                                    ${icone} ${detalhe.nome}<br>
                                    <small>${detalhe.quantidade.toFixed(2)} ${detalhe.unidade} √ó R$ ${detalhe.precoUnitario.toFixed(2)} = R$ ${detalhe.precoTotal.toFixed(2)}</small>
                                </div>
                            `;
                        }
                    });
                    
                    detalhesHTML += `</div>`;
                    infoDiv.innerHTML = detalhesHTML;
                    infoDiv.classList.remove('hidden');
                    
                    // Atualizar pre√ßo
                    precoDiv.textContent = `R$ ${produtoOrcamento.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    precoDiv.classList.remove('hidden');
                } else {
                    infoDiv.classList.add('hidden');
                    precoDiv.classList.add('hidden');
                }
            }
        }
        // FIM atualizarInterfaceProduto

        // IN√çCIO removerProdutoOrcamento
        function removerProdutoOrcamento(produtoDivId) {
            if (confirm('Tem certeza que deseja remover este produto do or√ßamento?')) {
                // Remover do array
                produtosOrcamento = produtosOrcamento.filter(p => p.id !== produtoDivId);
                
                // Remover do DOM
                const produtoElement = document.getElementById(produtoDivId);
                if (produtoElement) {
                    produtoElement.remove();
                }
                
                // Atualizar resumo
                atualizarResumoOrcamento();
                
                // Mostrar mensagem se n√£o houver produtos
                if (produtosOrcamento.length === 0) {
                    const loadingElement = document.getElementById('loadingProdutos');
                    if (loadingElement) {
                        loadingElement.classList.remove('hidden');
                    }
                }
            }
        }
        // FIM removerProdutoOrcamento

        // IN√çCIO atualizarResumoOrcamento
        function atualizarResumoOrcamento() {
            const totalGeral = produtosOrcamento.reduce((sum, produto) => sum + produto.preco, 0);
            const totalItens = produtosOrcamento.reduce((sum, produto) => sum + produto.quantidade, 0);
            
            const totalGeralElement = document.getElementById('totalGeral');
            const totalProdutosElement = document.getElementById('totalProdutos');
            const totalItensElement = document.getElementById('totalItens');
            
            if (totalGeralElement) {
                totalGeralElement.textContent = `R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            if (totalProdutosElement) {
                totalProdutosElement.textContent = produtosOrcamento.length;
            }
            if (totalItensElement) {
                totalItensElement.textContent = totalItens;
            }
            
            // Atualizar objeto do or√ßamento
            orcamentoAtual.produtos = produtosOrcamento;
            orcamentoAtual.total = totalGeral;

            // IN√çCIO ATUALIZA√á√ÉO DA TABELA NO RESUMO
            const corpoTabela = document.getElementById('corpoTabelaResumo');
            if (corpoTabela) {
                // Limpar tabela
                corpoTabela.innerHTML = '';
                
                // Adicionar cada produto √† tabela
                produtosOrcamento.forEach(produto => {
                    if (produto.preco > 0 && produto.produtoId) {
                        const produtoCadastrado = produtosCadastrados.find(p => p.id == produto.produtoId);
                        const nomeProduto = produtoCadastrado ? produtoCadastrado.nome : 'Produto n√£o encontrado';
                        
                        // Determinar o vidro usado
                        let vidroUsado = 'Padr√£o';
                        if (produto.substituicoes && Object.keys(produto.substituicoes).length > 0) {
                            const primeiroSubstitutoId = Object.values(produto.substituicoes)[0];
                            const itemSubstituto = itensEstoque.find(i => i.id == primeiroSubstitutoId);
                            vidroUsado = itemSubstituto ? itemSubstituto.nome : 'Substitu√≠do';
                        }
                        
                        const valorUnitario = produto.preco / produto.quantidade;
                        
                        const linha = document.createElement('tr');
                        linha.innerHTML = `
                            <td>${nomeProduto}</td>
                            <td>${vidroUsado}</td>
                            <td class="valor-unitario">R$ ${valorUnitario.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td class="subtotal">R$ ${produto.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        `;
                        corpoTabela.appendChild(linha);
                    }
                });
            }
            // FIM ATUALIZA√á√ÉO DA TABELA NO RESUMO
        }
        // FIM atualizarResumoOrcamento

        // =============================================================================
        // CRUD OR√áAMENTOS - BANCO DE DADOS
        // =============================================================================

        // IN√çCIO criarTabelaOrcamentos
        async function criarTabelaOrcamentos() {
            try {
                const { error } = await supabase
                    .from('orcamentos')
                    .select('id')
                    .limit(1);
                
                if (error && error.code === '42P01') {
                    console.log('üìã Criando tabela orcamentos...');
                    // A tabela ser√° criada automaticamente pelo Supabase quando inserirmos o primeiro registro
                }
            } catch (error) {
                console.error('Erro ao verificar tabela:', error);
            }
        }
        // FIM criarTabelaOrcamentos

// IN√çCIO salvarOrcamento
async function salvarOrcamento() {
    const nomeClienteElement = document.getElementById('nomeCliente');
    const localizacaoElement = document.getElementById('localizacaoObra');
    const observacoesElement = document.getElementById('observacoes');
    const statusElement = document.getElementById('statusOrcamento');
    
    const nomeCliente = nomeClienteElement ? nomeClienteElement.value.trim() : '';
    const localizacao = localizacaoElement ? localizacaoElement.value.trim() : '';
    const observacoes = observacoesElement ? observacoesElement.value.trim() : '';
    const status = statusElement ? statusElement.value : 'rascunho';
    
    if (!nomeCliente) {
        alert('‚ùå Digite o nome do cliente antes de salvar');
        return;
    }
    
    if (produtosOrcamento.length === 0) {
        alert('‚ùå Adicione pelo menos um produto ao or√ßamento');
        return;
    }
    
    // Atualizar objeto do or√ßamento
    orcamentoAtual.cliente = nomeCliente;
    const telefoneElement = document.getElementById('telefoneCliente');
    orcamentoAtual.telefone = telefoneElement ? telefoneElement.value : '';
    orcamentoAtual.localizacao = localizacao;
    orcamentoAtual.observacoes = observacoes;
    orcamentoAtual.status = status;
    const dataElement = document.getElementById('dataOrcamento');
    
    // CORRE√á√ÉO: Converter data do formato brasileiro para ISO
    let dataOrcamento = dataElement ? dataElement.value : new Date().toLocaleDateString('pt-BR');
    if (dataOrcamento) {
        // Converter de "DD/MM/AAAA" para "AAAA-MM-DD"
        const partes = dataOrcamento.split('/');
        if (partes.length === 3) {
            dataOrcamento = `${partes[2]}-${partes[1]}-${partes[0]}`;
        }
    }
    orcamentoAtual.data = dataOrcamento;

    try {
        let resultado;

        if (editandoOrcamentoId) {
            // Atualizar or√ßamento existente
            const { data, error } = await supabase
                .from('orcamentos')
                .update({
                    cliente: orcamentoAtual.cliente,
                    telefone: orcamentoAtual.telefone,
                    localizacao: orcamentoAtual.localizacao,
                    observacoes: orcamentoAtual.observacoes,
                    data: orcamentoAtual.data,
                    status: orcamentoAtual.status,
                    produtos: orcamentoAtual.produtos,
                    total: orcamentoAtual.total,
                    data_atualizacao: new Date().toISOString()
                    // N√ÉO mexer no 'estoque_baixado' aqui, pois √© controle manual
                })
                .eq('id', editandoOrcamentoId)
                .select();
            
            if (error) throw error;
            resultado = data ? data[0] : null;
        } else {
            // Criar novo or√ßamento
            const { data, error } = await supabase
                .from('orcamentos')
                .insert([{
                    cliente: orcamentoAtual.cliente,
                    telefone: orcamentoAtual.telefone,
                    localizacao: orcamentoAtual.localizacao,
                    observacoes: orcamentoAtual.observacoes,
                    data: orcamentoAtual.data,
                    status: orcamentoAtual.status,
                    produtos: orcamentoAtual.produtos,
                    total: orcamentoAtual.total,
                    estoque_baixado: false // NOVO CAMPO: Definir como falso ao criar
                }])
                .select();
            
            if (error) throw error;
            resultado = data ? data[0] : null;
        }

        alert('‚úÖ Or√ßamento salvo com sucesso!');
        await carregarOrcamentos();
        novoOr√ßamento();
        
    } catch (error) {
        console.error('‚ùå Erro ao salvar or√ßamento:', error);
        alert('‚ùå Erro ao salvar or√ßamento: ' + error.message);
    }
}
// FIM salvarOrcamento

        // IN√çCIO carregarOrcamentos
        async function carregarOrcamentos() {
            try {
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('*') // O '*' deve incluir a nova coluna 'estoque_baixado'
                    .order('data_criacao', { ascending: false });
                
                if (error) throw error;
                
                orcamentosCadastrados = data || [];
                atualizarListaOrcamentos();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar or√ßamentos:', error);
                orcamentosCadastrados = [];
                atualizarListaOrcamentos();
            }
        }
        // FIM carregarOrcamentos

       // IN√çCIO atualizarListaOrcamentos
function atualizarListaOrcamentos() {
    const lista = document.getElementById('listaOrcamentos');
    if (!lista) return;
    
    if (orcamentosCadastrados.length === 0) {
        lista.innerHTML = '<div class="loading">Nenhum or√ßamento cadastrado</div>';
        return;
    }

    lista.innerHTML = orcamentosCadastrados.map(orcamento => {
        const statusClass = `status-${orcamento.status}`;
        
        // CORRE√á√ÉO: Converter data do formato ISO para brasileiro
        let dataFormatada = 'Data n√£o informada';
        if (orcamento.data) {
            if (orcamento.data.includes('/')) {
                // J√° est√° no formato brasileiro
                dataFormatada = orcamento.data;
            } else {
                // Converter de "AAAA-MM-DD" para "DD/MM/AAAA"
                const partes = orcamento.data.split('-');
                if (partes.length === 3) {
                    dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }
        }

        // ====== IN√çCIO DA L√ìGICA DOS BOT√ïES DE ESTOQUE ======
        let botoesEstoqueHTML = '';
        if (orcamento.status === 'aprovado') {
            if (orcamento.estoque_baixado) {
                // Se o estoque j√° foi baixado, mostrar bot√£o para reverter
                botoesEstoqueHTML = `
                    <button class="btn btn-secondary btn-small" style="width: 100%;" onclick="event.stopPropagation(); reverterBaixaEstoque(${orcamento.id})">
                        üîÑ Reverter Baixa
                    </button>`;
            } else {
                // Se o estoque N√ÉO foi baixado, mostrar bot√£o para dar baixa
                botoesEstoqueHTML = `
                    <button class="btn btn-success btn-small" style="width: 100%;" onclick="event.stopPropagation(); darBaixaEstoque(${orcamento.id})">
                        ‚¨áÔ∏è Dar Baixa Estoque
                    </button>`;
            }
        }
        // ====== FIM DA L√ìGICA DOS BOT√ïES DE ESTOQUE ======
        
        return `
            <div class="orcamento-card">
                <div class="orcamento-header-card">
                    <div>
                        <strong style="font-size: 18px;">${orcamento.cliente || 'Cliente n√£o informado'}</strong>
                        <span class="status-badge ${statusClass}">${orcamento.status}</span>
                        <div style="margin-top: 8px; color: #666;">
                            üìÖ ${dataFormatada} 
                            ${orcamento.telefone ? `‚Ä¢ üìû ${orcamento.telefone}` : ''}
                            ${orcamento.localizacao ? `‚Ä¢ üìç ${orcamento.localizacao}` : ''}
                        </div>
                        <div style="margin-top: 5px; font-size: 14px;">
                            <strong>R$ ${(orcamento.total || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                            ‚Ä¢ ${(orcamento.produtos || []).length} produto(s)
                        </div>
                        ${orcamento.observacoes ? `<div style="margin-top: 5px; font-size: 13px; color: #888;">${orcamento.observacoes}</div>` : ''}
                    </div>
                    <div class="orcamento-acoes">
                        ${botoesEstoqueHTML}

                        <div style="display: flex; gap: 10px; width: 100%; justify-content: flex-end; margin-top: 10px;">
                            <button class="btn btn-view btn-small" onclick="event.stopPropagation(); visualizarOrcamento(${orcamento.id})">üëÅÔ∏è Ver</button>
                            <button class="btn btn-warning btn-small" onclick="event.stopPropagation(); editarOrcamento(${orcamento.id})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); excluirOrcamento(${orcamento.id})">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
// FIM atualizarListaOrcamentos

       // IN√çCIO visualizarOrcamento
async function visualizarOrcamento(id) {
    try {
        const { data, error } = await supabase
            .from('orcamentos')
            .select('*')
            .eq('id', id)
            .single();
        
        if (error) throw error;
        
        if (!data) {
            alert('‚ùå Or√ßamento n√£o encontrado');
            return;
        }

        // CORRE√á√ÉO: Converter data do formato ISO para brasileiro
        let dataFormatada = 'N√£o informada';
        if (data.data) {
            if (data.data.includes('/')) {
                dataFormatada = data.data;
            } else {
                const partes = data.data.split('-');
                if (partes.length === 3) {
                    dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }
        }

        // L√≥gica de status do estoque (NOVO)
        let statusEstoque = '';
        if (data.status === 'aprovado') {
            statusEstoque = data.estoque_baixado ? 
                '<strong style="color: #27ae60;">(Estoque Baixado)</strong>' : 
                '<strong style="color: #f39c12;">(Aguardando Baixa)</strong>';
        }

        let conteudo = `
            <div style="margin-bottom: 20px;">
                <strong>Cliente:</strong> ${data.cliente || 'N√£o informado'}<br>
                <strong>Telefone:</strong> ${data.telefone || 'N√£o informado'}<br>
                <strong>Localiza√ß√£o:</strong> ${data.localizacao || 'N√£o informada'}<br>
                <strong>Data:</strong> ${dataFormatada}<br>
                <strong>Status:</strong> <span class="status-badge status-${data.status}">${data.status}</span> ${statusEstoque}<br>
                ${data.observacoes ? `<strong>Observa√ß√µes:</strong> ${data.observacoes}<br>` : ''}
                <strong>Total:</strong> R$ ${(data.total || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </div>
            
            <div style="margin-bottom: 20px;">
                <strong>Produtos:</strong>
                <div style="margin-top: 15px;">
        `;
        
        // O restante desta fun√ß√£o (loop de produtos) permanece o mesmo
        // ...
        
        // (Vou copiar o resto da sua fun√ß√£o para garantir)
        (data.produtos || []).forEach((produto, index) => {
            const produtoCadastrado = produtosCadastrados.find(p => p.id == produto.produtoId);
            const nomeProduto = produtoCadastrado ? produtoCadastrado.nome : 'Produto n√£o encontrado';
            
            conteudo += `
                <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 6px;">
                    <strong>${index + 1}. ${nomeProduto}</strong>
                    <div style="font-size: 12px; color: #666;">
                        Dimens√µes: ${produto.largura || 0}m √ó ${produto.altura || 0}m | 
                        Quantidade: ${produto.quantidade || 1} | 
                        Pre√ßo: R$ ${(produto.preco || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                </div>
            `;
        });

        conteudo += `
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="gerarPDFOrcamento(${data.id})">
                    üìÑ Gerar PDF
                </button>
            </div>
        `;
        
        document.getElementById('modalTitulo').textContent = `Detalhes do Or√ßamento #${data.id}`;
        document.getElementById('modalConteudo').innerHTML = conteudo;
        document.getElementById('modalVisualizar').style.display = 'flex';

    } catch (error) {
        console.error('Erro ao carregar or√ßamento:', error);
        alert('‚ùå Erro ao carregar or√ßamento: ' + error.message);
    }
}
// FIM visualizarOrcamento

       // IN√çCIO editarOrcamento
async function editarOrcamento(id) {
    try {
        const { data, error } = await supabase
            .from('orcamentos')
            .select('*')
            .eq('id', id)
            .single();
        
        if (error) throw error;
        
        if (!data) {
            alert('‚ùå Or√ßamento n√£o encontrado');
            return;
        }

        // Preencher formul√°rio
        const nomeClienteElement = document.getElementById('nomeCliente');
        const telefoneElement = document.getElementById('telefoneCliente');
        const localizacaoElement = document.getElementById('localizacaoObra');
        const observacoesElement = document.getElementById('observacoes');
        const statusElement = document.getElementById('statusOrcamento');
        const dataElement = document.getElementById('dataOrcamento');
        
        if (nomeClienteElement) nomeClienteElement.value = data.cliente || '';
        if (telefoneElement) telefoneElement.value = data.telefone || '';
        if (localizacaoElement) localizacaoElement.value = data.localizacao || '';
        if (observacoesElement) observacoesElement.value = data.observacoes || '';
        if (statusElement) statusElement.value = data.status || 'rascunho';
        
        // CORRE√á√ÉO: Converter data do formato ISO para brasileiro ao editar
        if (dataElement && data.data) {
            if (data.data.includes('/')) {
                // J√° est√° no formato brasileiro
                dataElement.value = data.data;
            } else {
                // Converter de "AAAA-MM-DD" para "DD/MM/AAAA"
                const partes = data.data.split('-');
                if (partes.length === 3) {
                    dataElement.value = `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
            }
        }

        // Preencher produtos
        produtosOrcamento = data.produtos || [];
        editandoOrcamentoId = id;

        // Atualizar interface dos produtos
        const listaElement = document.getElementById('listaProdutosOrcamento');
        if (listaElement) {
            listaElement.innerHTML = '';
        }
        produtosOrcamento.forEach(produto => {
            adicionarProdutoOrcamentoExistente(produto);
        });

        atualizarResumoOrcamento();
        
        // Rolagem suave para o topo
        const orcamentoSection = document.querySelector('.orcamento-section');
        if (orcamentoSection) {
            orcamentoSection.scrollIntoView({ behavior: 'smooth' });
        }

    } catch (error) {
        console.error('Erro ao carregar or√ßamento para edi√ß√£o:', error);
        alert('‚ùå Erro ao carregar or√ßamento: ' + error.message);
    }
}
// FIM editarOrcamento

        // IN√çCIO adicionarProdutoOrcamentoExistente
        function adicionarProdutoOrcamentoExistente(produtoExistente) {
            const produtoId = produtoExistente.id;
            
            const produtoHTML = `
                <div class="produto-orcamento-card" id="${produtoId}">
                    <div class="produto-header">
                        <div class="form-group">
                            <label>Produto</label>
                            <select onchange="atualizarProdutoOrcamento('${produtoId}', this.value)">
                                <option value="">Selecione um produto...</option>
                                ${produtosCadastrados.map(produto => `
                                    <option value="${produto.id}" ${produto.id == produtoExistente.produtoId ? 'selected' : ''}>
                                        ${produto.nome} (${produto.produto_categorias?.nome || 'Sem categoria'})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Largura (m)</label>
                            <input type="number" placeholder="1.20" min="0.1" step="0.01" 
                                   value="${produtoExistente.largura || ''}"
                                   onchange="calcularProdutoOrcamento('${produtoId}')" 
                                   id="${produtoId}_largura">
                        </div>
                        
                        <div class="form-group">
                            <label>Altura (m)</label>
                            <input type="number" placeholder="2.00" min="0.1" step="0.01" 
                                   value="${produtoExistente.altura || ''}"
                                   onchange="calcularProdutoOrcamento('${produtoId}')" 
                                   id="${produtoId}_altura">
                        </div>
                        
                        <div class="form-group">
                            <label>Quantidade</label>
                            <input type="number" placeholder="1" min="1" value="${produtoExistente.quantidade || 1}" 
                                   onchange="calcularProdutoOrcamento('${produtoId}')" 
                                   id="${produtoId}_quantidade">
                        </div>
                        
                        <button class="btn btn-danger btn-small" onclick="removerProdutoOrcamento('${produtoId}')">
                            üóëÔ∏è
                        </button>
                    </div>

                    <div id="${produtoId}_substituiveis" class="hidden">
                        </div>
                    
                    <div id="${produtoId}_info" class="produto-info">
                        </div>
                    
                    <div id="${produtoId}_preco" class="preco-produto">
                        R$ ${(produtoExistente.preco || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                </div>
            `;
            
            const loadingElement = document.getElementById('loadingProdutos');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
            
            const listaElement = document.getElementById('listaProdutosOrcamento');
            if (listaElement) {
                listaElement.insertAdjacentHTML('beforeend', produtoHTML);
            }
            
            // Carregar op√ß√µes substitu√≠veis se houver
            setTimeout(() => {
                const produto = produtosCadastrados.find(p => p.id == produtoExistente.produtoId);
                if (produto && produto.itens_composicao) {
                    const itensSubstituiveis = produto.itens_composicao.filter(item => item.substituivel);
                    if (itensSubstituiveis.length > 0) {
                        mostrarOpcoesSubstituiveis(produtoId, produto, itensSubstituiveis);
                        
                        // Restaurar sele√ß√µes anteriores
                        if (produtoExistente.substituicoes) {
                            Object.entries(produtoExistente.substituicoes).forEach(([originalId, substitutoId]) => {
                                setTimeout(() => {
                                    selecionarSubstituicao(produtoId, parseInt(originalId), substitutoId);
                                }, 200);
                            });
                        }
                    }
                }
                
                // Recalcular para atualizar detalhes
                calcularProdutoOrcamento(produtoId);
            }, 300);
        }
        // FIM adicionarProdutoOrcamentoExistente

        // IN√çCIO excluirOrcamento
        async function excluirOrcamento(id) {
            if (!confirm('Tem certeza que deseja excluir este or√ßamento? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('orcamentos')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('‚úÖ Or√ßamento exclu√≠do com sucesso!');
                await carregarOrcamentos();
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir or√ßamento:', error);
                alert('‚ùå Erro ao excluir or√ßamento: ' + error.message);
            }
        }
        // FIM excluirOrcamento

        // IN√çCIO filtrarOrcamentos
        function filtrarOrcamentos() {
            const termoElement = document.getElementById('pesquisaOrcamentos');
            const statusElement = document.getElementById('filtroStatus');
            
            const termo = termoElement ? termoElement.value.toLowerCase() : '';
            const statusFiltro = statusElement ? statusElement.value : '';
            
            const orcamentosFiltrados = orcamentosCadastrados.filter(orcamento => {
                const matchTermo = orcamento.cliente?.toLowerCase().includes(termo) ||
                                 (orcamento.localizacao && orcamento.localizacao.toLowerCase().includes(termo)) ||
                                 (orcamento.observacoes && orcamento.observacoes.toLowerCase().includes(termo));
                
                const matchStatus = !statusFiltro || orcamento.status === statusFiltro;
                
                return matchTermo && matchStatus;
            });
            
            const lista = document.getElementById('listaOrcamentos');
            if (!lista) return;
            
            if (orcamentosFiltrados.length === 0) {
                lista.innerHTML = '<div class="loading">Nenhum or√ßamento encontrado</div>';
                return;
            }

            // A fun√ß√£o atualizarListaOrcamentos() j√° √© chamada por carregarOrcamentos()
            // Para evitar duplicar a l√≥gica de renderiza√ß√£o, vamos apenas re-renderizar
            // com os dados filtrados.
            // (Re-copiando a l√≥gica de renderiza√ß√£o de atualizarListaOrcamentos para c√°)
            
            lista.innerHTML = orcamentosFiltrados.map(orcamento => {
                const statusClass = `status-${orcamento.status}`;
                
                let dataFormatada = 'Data n√£o informada';
                if (orcamento.data) {
                    if (orcamento.data.includes('/')) {
                        dataFormatada = orcamento.data;
                    } else {
                        const partes = orcamento.data.split('-');
                        if (partes.length === 3) {
                            dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                        }
                    }
                }

                // ====== IN√çCIO DA L√ìGICA DOS BOT√ïES DE ESTOQUE ======
                let botoesEstoqueHTML = '';
                if (orcamento.status === 'aprovado') {
                    if (orcamento.estoque_baixado) {
                        botoesEstoqueHTML = `
                            <button class="btn btn-secondary btn-small" style="width: 100%;" onclick="event.stopPropagation(); reverterBaixaEstoque(${orcamento.id})">
                                üîÑ Reverter Baixa
                            </button>`;
                    } else {
                        botoesEstoqueHTML = `
                            <button class="btn btn-success btn-small" style="width: 100%;" onclick="event.stopPropagation(); darBaixaEstoque(${orcamento.id})">
                                ‚¨áÔ∏è Dar Baixa Estoque
                            </button>`;
                    }
                }
                // ====== FIM DA L√ìGICA DOS BOT√ïES DE ESTOQUE ======
                
                return `
                    <div class="orcamento-card">
                        <div class="orcamento-header-card">
                            <div>
                                <strong style="font-size: 18px;">${orcamento.cliente || 'Cliente n√£o informado'}</strong>
                                <span class="status-badge ${statusClass}">${orcamento.status}</span>
                                <div style="margin-top: 8px; color: #666;">
                                    üìÖ ${dataFormatada} 
                                    ${orcamento.telefone ? `‚Ä¢ üìû ${orcamento.telefone}` : ''}
                                    ${orcamento.localizacao ? `‚Ä¢ üìç ${orcamento.localizacao}` : ''}
                                </div>
                                <div style="margin-top: 5px; font-size: 14px;">
                                    <strong>R$ ${(orcamento.total || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                    ‚Ä¢ ${(orcamento.produtos || []).length} produto(s)
                                </div>
                            </div>
                            <div class="orcamento-acoes">
                                ${botoesEstoqueHTML}
                                <div style="display: flex; gap: 10px; width: 100%; justify-content: flex-end; margin-top: 10px;">
                                    <button class="btn btn-view btn-small" onclick="event.stopPropagation(); visualizarOrcamento(${orcamento.id})">üëÅÔ∏è Ver</button>
                                    <button class="btn btn-warning btn-small" onclick="event.stopPropagation(); editarOrcamento(${orcamento.id})">‚úèÔ∏è Editar</button>
                                    <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); excluirOrcamento(${orcamento.id})">üóëÔ∏è Excluir</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        // FIM filtrarOrcamentos

        // IN√çCIO limparFiltros
        function limparFiltros() {
            const pesquisaElement = document.getElementById('pesquisaOrcamentos');
            const filtroElement = document.getElementById('filtroStatus');
            
            if (pesquisaElement) pesquisaElement.value = '';
            if (filtroElement) filtroElement.value = '';
            atualizarListaOrcamentos();
        }
        // FIM limparFiltros

        // IN√çCIO fecharModal
        function fecharModal() {
            const modal = document.getElementById('modalVisualizar');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        // FIM fecharModal

        // =============================================================================
        // FUN√á√ïES DE A√á√ÉO
        // =============================================================================

        // IN√çCIO gerarPDF
        function gerarPDF() {
            const nomeClienteElement = document.getElementById('nomeCliente');
            const nomeCliente = nomeClienteElement ? nomeClienteElement.value.trim() : '';
            
            if (!nomeCliente) {
                alert('‚ùå Digite o nome do cliente antes de gerar o PDF');
                return;
            }
            
            if (produtosOrcamento.length === 0) {
                alert('‚ùå Adicione pelo menos um produto ao or√ßamento');
                return;
            }
            
            gerarPDFOrcamento(null);
        }
        // FIM gerarPDF

      // IN√çCIO gerarPDFOrcamento
        function gerarPDFOrcamento(orcamentoId) {
            const orcamento = orcamentoId ? 
                orcamentosCadastrados.find(o => o.id === orcamentoId) : 
                orcamentoAtual;
            
            if (!orcamento) return;

            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('‚ùå Biblioteca jsPDF n√£o carregada');
                return;
            }

            const doc = new jsPDF();
            
            // =================================================================
            // NOVO: Defina sua margem aqui (1.5 = 50% de acr√©scimo)
            const margem = 1.5; 
            // =================================================================

            // Configura√ß√µes iniciais
            const marginLeft = 20;
            const marginTop = 20;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            let yPos = marginTop;

            // Cabe√ßalho
            doc.setFontSize(20);
            doc.setTextColor(44, 62, 80);
            doc.text('OR√áAMENTO - ESQUADRIAS', pageWidth / 2, yPos, { align: 'center' });
            yPos += 15;

            // Linha decorativa
            doc.setDrawColor(52, 152, 219);
            doc.setLineWidth(0.5);
            doc.line(marginLeft, yPos, pageWidth - marginLeft, yPos);
            yPos += 10;

            // Informa√ß√µes do cliente
            doc.setFontSize(12);
            doc.setTextColor(60, 60, 60);
            
            doc.setFont(undefined, 'bold');
            doc.text('INFORMA√á√ïES DO CLIENTE:', marginLeft, yPos);
            yPos += 8;
            
            doc.setFont(undefined, 'normal');
            doc.text(`Cliente: ${orcamento.cliente || 'N√£o informado'}`, marginLeft, yPos);
            yPos += 6;
            doc.text(`Telefone: ${orcamento.telefone || 'N√£o informado'}`, marginLeft, yPos);
            yPos += 6;
            doc.text(`Localiza√ß√£o: ${orcamento.localizacao || 'N√£o informada'}`, marginLeft, yPos);
            yPos += 6;
            doc.text(`Data: ${orcamento.data || 'N√£o informada'}`, marginLeft, yPos);
            yPos += 6;
            doc.text(`Status: ${orcamento.status || 'rascunho'}`, marginLeft, yPos);
            yPos += 8;

            if (orcamento.observacoes) {
                doc.text(`Observa√ß√µes: ${orcamento.observacoes}`, marginLeft, yPos);
                yPos += 10;
            }

            // Tabela de produtos - Cabe√ßalho
            yPos += 5;
            doc.setFont(undefined, 'bold');
            doc.setTextColor(255, 255, 255);
            doc.setFillColor(52, 73, 94);
            doc.rect(marginLeft, yPos, pageWidth - 2 * marginLeft, 8, 'F');
            
            doc.text('Produto', marginLeft + 2, yPos + 5);
            doc.text('Vidro/Espessura', marginLeft + 70, yPos + 5);
            doc.text('Unit√°rio', marginLeft + 120, yPos + 5);
            doc.text('Subtotal', marginLeft + 150, yPos + 5);
            yPos += 10;

            // Produtos
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            
            (orcamento.produtos || []).forEach((produto, index) => {
                // Verificar se precisa de nova p√°gina
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = marginTop;
                }

                const produtoCadastrado = produtosCadastrados.find(p => p.id == produto.produtoId);
                const nomeProduto = produtoCadastrado ? produtoCadastrado.nome : 'Produto n√£o encontrado';
                
                // Determinar informa√ß√µes do vidro
                let infoVidro = 'Padr√£o';
                if (produto.substituicoes && Object.keys(produto.substituicoes).length > 0) {
                    const primeiroSubstitutoId = Object.values(produto.substituicoes)[0];
                    const itemSubstituto = itensEstoque.find(i => i.id == primeiroSubstitutoId);
                    if (itemSubstituto) {
                        infoVidro = itemSubstituto.nome;
                        // Extrair espessura se dispon√≠vel
                        if (itemSubstituto.descricao && itemSubstituto.descricao.match(/\d+mm/)) {
                            const espessura = itemSubstituto.descricao.match(/\d+mm/)[0];
                            infoVidro += ` (${espessura})`;
                        }
                    } else {
                        infoVidro = 'Substitu√≠do';
                    }
                }

                // =================================================================
                // MODIFICADO: Aplicando a margem nos valores
                const valorUnitarioOriginal = produto.quantidade > 0 ? produto.preco / produto.quantidade : 0;
                const subtotalOriginal = produto.preco || 0;

                const valorUnitario = valorUnitarioOriginal * margem;
                const subtotal = subtotalOriginal * margem;
                // =================================================================

                // Linha com fundo cinza claro para altern√¢ncia
                if (index % 2 === 0) {
                    doc.setFillColor(245, 245, 245);
                    doc.rect(marginLeft, yPos - 2, pageWidth - 2 * marginLeft, 8, 'F');
                }

                // Dados do produto
                doc.setTextColor(0, 0, 0);
                doc.text(nomeProduto, marginLeft + 2, yPos + 3);
                doc.text(infoVidro, marginLeft + 70, yPos + 3);
                
                // Valores
                doc.setTextColor(39, 174, 96); // Verde para valores
                // MODIFICADO: Usando os novos valores com margem
                doc.text(`R$ ${valorUnitario.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, marginLeft + 120, yPos + 3);
                doc.text(`R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, marginLeft + 150, yPos + 3);

                // Detalhes adicionais em fonte menor
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                const detalhes = `${produto.largura || 0}m x ${produto.altura || 0}m - Qtd: ${produto.quantidade || 1}`;
                doc.text(detalhes, marginLeft + 2, yPos + 7);
                
                doc.setFontSize(10);
                yPos += 12;
            });

            // Linha total
            yPos += 5;
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(marginLeft, yPos, pageWidth - marginLeft, yPos);
            yPos += 8;

            // =================================================================
            // MODIFICADO: Aplicando a margem ao total geral
            const totalGeralComMargem = (orcamento.total || 0) * margem;
            // =================================================================

            // Total geral
            doc.setFont(undefined, 'bold');
            doc.setTextColor(44, 62, 80);
            doc.text('TOTAL GERAL:', marginLeft + 120, yPos);
            doc.setTextColor(231, 76, 60); // Vermelho para total
            // MODIFICADO: Usando o novo total com margem
            doc.text(`R$ ${totalGeralComMargem.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, marginLeft + 150, yPos);

            // Rodap√©
            yPos = pageHeight - 20;
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('Or√ßamento gerado automaticamente pelo Sistema de Esquadrias', pageWidth / 2, yPos, { align: 'center' });
            doc.text(`Data de emiss√£o: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, pageWidth / 2, yPos + 5, { align: 'center' });

            // Salvar PDF
            const nomeArquivo = `Orcamento_${(orcamento.cliente || 'SemNome').replace(/\s+/g, '_')}_${(orcamento.data || '').replace(/\//g, '-') || 'SemData'}.pdf`;
            doc.save(nomeArquivo);
        }
        // FIM gerarPDFOrcamento

        // IN√çCIO novoOr√ßamento
        function novoOr√ßamento() {
            if (produtosOrcamento.length > 0 && !confirm('Tem certeza que deseja criar um novo or√ßamento? Os dados atuais ser√£o perdidos.')) {
                return;
            }

            // Limpar formul√°rio
            const nomeClienteElement = document.getElementById('nomeCliente');
            const telefoneElement = document.getElementById('telefoneCliente');
            const localizacaoElement = document.getElementById('localizacaoObra');
            const observacoesElement = document.getElementById('observacoes');
            const statusElement = document.getElementById('statusOrcamento');
            
            if (nomeClienteElement) nomeClienteElement.value = '';
            if (telefoneElement) telefoneElement.value = '';
            if (localizacaoElement) localizacaoElement.value = '';
            if (observacoesElement) observacoesElement.value = '';
            if (statusElement) statusElement.value = 'rascunho';
            
            atualizarData();
            
            // Limpar produtos
            produtosOrcamento = [];
            editandoOrcamentoId = null;
            const listaElement = document.getElementById('listaProdutosOrcamento');
            if (listaElement) {
                listaElement.innerHTML = '<div class="loading" id="loadingProdutos">Nenhum produto adicionado ao or√ßamento</div>';
            }
            
            atualizarResumoOrcamento();
            
            // Rolagem suave para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        // FIM novoOr√ßamento

        // =============================================================================
        // INICIALIZA√á√ÉO
        // =============================================================================

        // IN√çCIO inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando sistema de or√ßamentos...');
            atualizarData();
            await criarTabelaOrcamentos();
            await carregarProdutos();
            await carregarItensEstoque();
            await carregarOrcamentos();
            console.log('‚úÖ Sistema pronto!');
        });
        // FIM inicializa√ß√£o

        // IN√çCIO observadores de campos
        document.addEventListener('DOMContentLoaded', function() {
            const nomeClienteElement = document.getElementById('nomeCliente');
            const telefoneElement = document.getElementById('telefoneCliente');
            const localizacaoElement = document.getElementById('localizacaoObra');
            const observacoesElement = document.getElementById('observacoes');
            const statusElement = document.getElementById('statusOrcamento');
            
            if (nomeClienteElement) {
                nomeClienteElement.addEventListener('input', function() {
                    orcamentoAtual.cliente = this.value;
                });
            }
            
            if (telefoneElement) {
                telefoneElement.addEventListener('input', function() {
                    orcamentoAtual.telefone = this.value;
                });
            }
            
            if (localizacaoElement) {
                localizacaoElement.addEventListener('input', function() {
                    orcamentoAtual.localizacao = this.value;
                });
            }
            
            if (observacoesElement) {
                observacoesElement.addEventListener('input', function() {
                    orcamentoAtual.observacoes = this.value;
                });
            }
            
            if (statusElement) {
                statusElement.addEventListener('change', function() {
                    orcamentoAtual.status = this.value;
                });
            }
        });
        // FIM observadores de campos

        // IN√çCIO fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalVisualizar');
            if (event.target === modal) {
                fecharModal();
            }
        }
        // FIM fechar modal ao clicar fora

        // =============================================================================
        // NOVAS FUN√á√ïES - GEST√ÉO DE ESTOQUE MANUAL
        // =============================================================================

        // IN√çCIO darBaixaEstoque
        async function darBaixaEstoque(orcamentoId) {
            if (!confirm('Tem certeza que deseja dar baixa no estoque para este or√ßamento? Esta a√ß√£o diminuir√° as quantidades dos itens.')) return;

            try {
                // 1. Obter o or√ßamento
                const { data: orcamento, error } = await supabase
                    .from('orcamentos')
                    .select('produtos')
                    .eq('id', orcamentoId)
                    .single();
                
                if (error) throw error;
                if (!orcamento || !orcamento.produtos) {
                    alert('Erro: Or√ßamento ou produtos n√£o encontrados.');
                    return;
                }

                console.log('Calculando mudan√ßas de estoque para dar baixa...');
                const stockUpdates = await calcularMudancasEstoque(orcamento);
                
                // 2. Aplicar as mudan√ßas (subtrair)
                await aplicarMudancasEstoque(stockUpdates, 'subtrair');

                // 3. Marcar o or√ßamento como 'baixado'
                const { error: updateError } = await supabase
                    .from('orcamentos')
                    .update({ estoque_baixado: true })
                    .eq('id', orcamentoId);

                if (updateError) throw updateError;

                alert('‚úÖ Estoque atualizado com sucesso!');
                carregarOrcamentos(); // Recarregar a lista
                carregarResumoEstoque(); // Atualizar resumo do estoque se a aba estiver ativa

            } catch (error) {
                console.error('Erro ao dar baixa no estoque:', error);
                alert('‚ùå Erro ao dar baixa no estoque: ' + error.message);
            }
        }
        // FIM darBaixaEstoque

        // IN√çCIO reverterBaixaEstoque
        async function reverterBaixaEstoque(orcamentoId) {
            if (!confirm('Tem certeza que deseja reverter a baixa? Esta a√ß√£o DEVOLVER√Å os itens ao estoque.')) return;

            try {
                // 1. Obter o or√ßamento
                const { data: orcamento, error } = await supabase
                    .from('orcamentos')
                    .select('produtos')
                    .eq('id', orcamentoId)
                    .single();
                
                if (error) throw error;
                if (!orcamento || !orcamento.produtos) {
                    alert('Erro: Or√ßamento ou produtos n√£o encontrados.');
                    return;
                }

                console.log('Calculando mudan√ßas de estoque para reverter...');
                const stockUpdates = await calcularMudancasEstoque(orcamento);

                // 2. Aplicar as mudan√ßas (adicionar)
                await aplicarMudancasEstoque(stockUpdates, 'adicionar');

                // 3. Marcar o or√ßamento como 'n√£o baixado'
                const { error: updateError } = await supabase
                    .from('orcamentos')
                    .update({ estoque_baixado: false })
                    .eq('id', orcamentoId);

                if (updateError) throw updateError;

                alert('‚úÖ Baixa de estoque revertida com sucesso!');
                carregarOrcamentos(); // Recarregar a lista
                carregarResumoEstoque(); // Atualizar resumo do estoque se a aba estiver ativa

            } catch (error) {
                console.error('Erro ao reverter baixa de estoque:', error);
                alert('‚ùå Erro ao reverter baixa de estoque: ' + error.message);
            }
        }
        // FIM reverterBaixaEstoque

        // IN√çCIO calcularMudancasEstoque
        async function calcularMudancasEstoque(orcamento) {
            const stockUpdates = new Map();

            // Certificar que produtosCadastrados est√° carregado
            if (produtosCadastrados.length === 0) {
                console.log('Recarregando defini√ß√µes de produtos...');
                await carregarProdutos();
            }

            for (const prodOrcamento of orcamento.produtos) {
                const produtoDefinicao = produtosCadastrados.find(p => p.id == prodOrcamento.produtoId);

                if (!produtoDefinicao || !produtoDefinicao.itens_composicao) {
                    console.warn(`Defini√ß√£o do produto ID ${prodOrcamento.produtoId} n√£o encontrada ou sem composi√ß√£o.`);
                    continue;
                }

                const L = prodOrcamento.largura || 0;
                const A = prodOrcamento.altura || 0;
                const QtdUnidades = prodOrcamento.quantidade || 1;

                for (const itemComposicao of produtoDefinicao.itens_composicao) {
                    // 1. Descobrir qual item de estoque usar (original ou substituto)
                    let itemEstoqueId = itemComposicao.item_id;

                    if (itemComposicao.substituivel && prodOrcamento.substituicoes && prodOrcamento.substituicoes[itemComposicao.item_id]) {
                        itemEstoqueId = prodOrcamento.substituicoes[itemComposicao.item_id];
                        console.log(`Item ${itemComposicao.item_nome} foi substitu√≠do por ID ${itemEstoqueId}`);
                    }

                    // 2. Calcular a quantidade necess√°ria
                    let quantidadePorUnidade = 0;
                    try {
                        quantidadePorUnidade = calcularQuantidadeFormula(itemComposicao.formula, L, A);
                    } catch (e) {
                        console.error(`Erro ao calcular f√≥rmula '${itemComposicao.formula}' para o item ${itemComposicao.item_nome}`, e);
                        continue; // Pula este item se a f√≥rmula falhar
                    }

                    const quantidadeTotalParaItem = quantidadePorUnidade * QtdUnidades;

                    // 3. Adicionar ao mapa de atualiza√ß√µes
                    if (quantidadeTotalParaItem > 0) {
                        const quantidadeAtual = stockUpdates.get(itemEstoqueId) || 0;
                        stockUpdates.set(itemEstoqueId, quantidadeAtual + quantidadeTotalParaItem);
                    }
                }
            }
            
            console.log('Mapa de atualiza√ß√£o de estoque:', stockUpdates);
            return stockUpdates;
        }
        // FIM calcularMudancasEstoque

        // IN√çCIO aplicarMudancasEstoque
        async function aplicarMudancasEstoque(stockUpdates, operacao = 'subtrair') {
            // Esta fun√ß√£o deve ser transacional, mas o Supabase JS client n√£o suporta transa√ß√µes complexas.
            // Vamos fazer chamada por chamada.
            // Para um sistema robusto, isso deveria ser uma RPC (fun√ß√£o no Supabase).
            
            const promises = [];

            for (const [itemId, quantidade] of stockUpdates.entries()) {
                if (!itemId) {
                    console.warn('Item ID nulo ou indefinido encontrado no mapa de estoque. Pulando.');
                    continue;
                }
                
                // Usamos uma RPC para garantir que a atualiza√ß√£o seja at√¥mica (SELECT + UPDATE)
                // Isso evita que duas pessoas deem baixa ao mesmo tempo e corrompa o estoque.
                const rpcParams = {
                    item_id_in: itemId,
                    quantidade_in: quantidade,
                    operacao_in: operacao // 'subtrair' ou 'adicionar'
                };
                
                console.log(`Preparando RPC 'atualizar_item_estoque' com:`, rpcParams);

                // *** IMPORTANTE ***
                // Voc√™ precisa criar esta fun√ß√£o no seu Supabase
                // V√° para Database -> Functions -> Create Function
                // Nome: atualizar_item_estoque
                // Cole o c√≥digo SQL que vou fornecer ap√≥s este bloco de HTML.
                
                promises.push(
                    supabase.rpc('atualizar_item_estoque', rpcParams)
                );
            }

            // 4. Esperar todas as atualiza√ß√µes
            const results = await Promise.all(promises);
            console.log('Resultados da RPC:', results);

            const errors = results.filter(res => res.error);
            
            if (errors.length > 0) {
                console.error('Alguns itens falharam ao atualizar:', errors);
                throw new Error('Alguns itens falharam ao atualizar o estoque. Verifique o console.');
            }
        }
        // FIM aplicarMudancasEstoque

    </script>
</body>
</html>