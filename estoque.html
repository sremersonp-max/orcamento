<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Estoque - Esquadrias</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .item-pai-card {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 20px;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        .item-pai-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .item-pai-header h4 { margin: 0; }
        .item-pai-content {
            padding: 20px;
            display: none; /* Come√ßa fechado */
        }
        /* ALTERA√á√ÉO: Novo grid para incluir mais colunas (SKU e Unidade de Medida) */
        .variacao-linha {
            display: grid;
            grid-template-columns: 1fr 150px 100px 120px auto; /* 4 colunas de dados + A√ß√µes */
            gap: 15px;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .variacao-linha:last-child { border-bottom: none; }
        
        /* NOVOS ESTILOS PARA OS FILTROS */
        .filtros-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e1e5e9;
        }
        .filtros-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .filtros-acoes {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
    <h1>üè≠ Gest√£o de Estoque</h1>
    <div style="display: flex; gap: 10px;">
        <a href="index.html" class="btn btn-secondary">üè† In√≠cio</a>
        <a href="produtos.html" class="btn btn-primary">üßÆ Produtos</a>
        <a href="orcamento.html" class="btn btn-success">üìã Or√ßamentos</a>
        <a href="pedidos.html" class="btn btn-warning">üöö Pedidos</a> 
        <a href="relatorios_estoque.html" class="btn btn-info">üìä Relat√≥rios</a> 
    </div>
</div>
            </div>
        </div>

        <div class="card">
            <h2 id="formTituloItemPai">‚ûï Cadastrar Novo Item (Modelo)</h2>
            <form id="formItemPai" onsubmit="salvarItemPai(event)">
                <input type="hidden" id="itemId">
                <div class="grid grid-4">
                    <div class="form-group">
                        <label for="nome">Nome do Item *</label>
                        <input type="text" id="nome" required placeholder="Ex: Perfil de Alum√≠nio">
                    </div>
                    <div class="form-group">
                        <label for="categoria">Categoria *</label>
                        <select id="categoria" required></select>
                    </div>
                    <div class="form-group">
                        <label for="unidadeMedida">Unidade de Medida *</label>
                        <select id="unidadeMedida" required>
                            <option value="m">Metro (m)</option>
                            <option value="m¬≤">Metro Quadrado (m¬≤)</option>
                            <option value="un">Unidade (un)</option>
                            <option value="kg">Quilo (kg)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="linha">Linha / S√©rie</label>
                        <select id="linha"></select> 
                    </div>
                    <div class="form-group">
                        <label for="precoCusto">Pre√ßo de Custo (R$)</label>
                        <input type="number" step="0.01" id="precoCusto" placeholder="Pre√ßo do Item Pai">
                    </div>
                    <div class="form-group">
                        <label for="quantidadeMinima">Qtd. M√≠nima</label>
                        <input type="number" step="0.01" id="quantidadeMinima" placeholder="Alerta de estoque">
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label for="descricao">Descri√ß√£o Detalhada</label>
                    <textarea id="descricao" rows="2" placeholder="Ex: Perfil de alum√≠nio refor√ßado para janelas X10."></textarea>
                </div>

                <div class="acoes" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-success" id="btnSalvarItemPai">üíæ Salvar Item</button>
                    <button type="button" class="btn btn-secondary hidden" id="btnCancelarEdicao" onclick="limparFormularioItemPai()">Cancelar Edi√ß√£o</button>
                </div>
            </form>
        </div>

        <div class="card">
            <!-- NOVA SE√á√ÉO DE FILTROS -->
            <div class="filtros-container">
                <div class="filtros-header">
                    <h3 style="margin: 0;">üîç Filtros de Busca</h3>
                    <small class="text-muted">Filtre os itens por diferentes crit√©rios</small>
                </div>
                
                <div class="filtros-grid">
                    <div class="form-group">
                        <label for="filtroNome">Nome do Item</label>
                        <input type="text" id="filtroNome" placeholder="Pesquisar por nome..." onkeyup="aplicarFiltros()">
                    </div>
                    
                    <div class="form-group">
                        <label for="filtroCategoria">Categoria</label>
                        <select id="filtroCategoria" onchange="aplicarFiltros()">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filtroLinha">Linha / S√©rie</label>
                        <select id="filtroLinha" onchange="aplicarFiltros()">
                            <option value="">Todas as linhas</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="filtroUnidadeMedida">Unidade de Medida</label>
                        <select id="filtroUnidadeMedida" onchange="aplicarFiltros()">
                            <option value="">Todas as unidades</option>
                            <option value="m">Metro (m)</option>
                            <option value="m¬≤">Metro Quadrado (m¬≤)</option>
                            <option value="un">Unidade (un)</option>
                            <option value="kg">Quilo (kg)</option>
                        </select>
                    </div>
                </div>
                
                <div class="filtros-acoes">
                    <button class="btn btn-secondary btn-small" onclick="limparFiltros()">
                        üóëÔ∏è Limpar Filtros
                    </button>
                    <button class="btn btn-info btn-small" onclick="expandirTodos()">
                        üìÇ Expandir Todos
                    </button>
                    <button class="btn btn-info btn-small" onclick="recolherTodos()">
                        üìÅ Recolher Todos
                    </button>
                </div>
            </div>

            <div id="listaItens">
                <div class="loading">Carregando itens...</div>
            </div>
        </div>
    </div>

    <div class="modal" id="modalVariacao">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitulo">Adicionar Nova Varia√ß√£o</h3>
                <button class="btn btn-danger btn-small" onclick="fecharModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="formVariacao" onsubmit="salvarVariacao(event)">
                    <input type="hidden" id="variacaoId">
                    <input type="hidden" id="variacaoItemId">
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label for="cor">Cor *</label>
                            <select id="cor" required></select> </div>
                        <div class="form-group">
                            <label for="precoVenda">Pre√ßo de Venda (R$) *</label>
                            <input type="number" step="0.01" id="precoVenda" required>
                        </div>
                        <div class="form-group">
                            <label for="quantidadeEstoque">Qtd. em Estoque *</label>
                            <input type="number" step="0.01" id="quantidadeEstoque" required>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="sku">SKU / C√≥digo de Barras</label>
                        <input type="text" id="sku" placeholder="C√≥digo √∫nico da varia√ß√£o">
                    </div>
                    <div class="acoes" style="margin-top:20px;">
                        <button type="submit" class="btn btn-success">üíæ Salvar Varia√ß√£o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // Vari√°veis globais
        let editandoItemPaiId = null;
        let todosItens = []; // Armazena todos os itens para filtragem local

        // =============================================================================
        // INICIALIZA√á√ÉO
        // =============================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([
                popularSelectsPadrao(),
                popularSelectsFiltros(),
                carregarTodosItens()
            ]);
        });

        async function popularSelectsPadrao() {
            // Carrega em paralelo para otimizar
            const [categorias, cores, linhas] = await Promise.all([
                estoqueFunctions.carregarCategorias(),
                estoqueFunctions.carregarCores(),
                estoqueFunctions.carregarLinhas()
            ]);

            const selectCategoria = document.getElementById('categoria');
            selectCategoria.innerHTML = '<option value="">Selecione...</option>' + 
                categorias.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

            const selectCor = document.getElementById('cor');
            selectCor.innerHTML = '<option value="">Selecione...</option>' + 
                cores.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            
            const selectLinha = document.getElementById('linha');
            selectLinha.innerHTML = '<option value="">Nenhuma</option>' + 
                linhas.map(l => `<option value="${l.id}">${l.nome}</option>`).join('');
        }

        async function popularSelectsFiltros() {
            const [categorias, linhas] = await Promise.all([
                estoqueFunctions.carregarCategorias(),
                estoqueFunctions.carregarLinhas()
            ]);

            // Popular filtro de categorias
            const filtroCategoria = document.getElementById('filtroCategoria');
            filtroCategoria.innerHTML = '<option value="">Todas as categorias</option>' + 
                categorias.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

            // Popular filtro de linhas
            const filtroLinha = document.getElementById('filtroLinha');
            filtroLinha.innerHTML = '<option value="">Todas as linhas</option>' + 
                linhas.map(l => `<option value="${l.id}">${l.nome}</option>`).join('');
        }

        async function carregarTodosItens() {
            const lista = document.getElementById('listaItens');
            lista.innerHTML = '<div class="loading">Carregando...</div>';
            
            todosItens = await estoqueFunctions.carregarItensPai();
            aplicarFiltros();
        }

        function aplicarFiltros() {
            const filtroNome = document.getElementById('filtroNome').value.toLowerCase();
            const filtroCategoria = document.getElementById('filtroCategoria').value;
            const filtroLinha = document.getElementById('filtroLinha').value;
            const filtroUnidadeMedida = document.getElementById('filtroUnidadeMedida').value;

            const itensFiltrados = todosItens.filter(item => {
                // Filtro por nome
                if (filtroNome && !item.nome.toLowerCase().includes(filtroNome)) {
                    return false;
                }
                
                // Filtro por categoria
                if (filtroCategoria && item.categoria_id != filtroCategoria) {
                    return false;
                }
                
                // Filtro por linha
                if (filtroLinha && item.linha_id != filtroLinha) {
                    return false;
                }
                
                // Filtro por unidade de medida
                if (filtroUnidadeMedida && item.unidade_medida != filtroUnidadeMedida) {
                    return false;
                }
                
                return true;
            });

            exibirItensFiltrados(itensFiltrados);
        }

        async function exibirItensFiltrados(itens) {
            const lista = document.getElementById('listaItens');

            if (itens.length === 0) {
                lista.innerHTML = '<div class="muted">Nenhum item encontrado com os filtros aplicados.</div>';
                return;
            }

            let html = '';
            for (const item of itens) {
                const variacoes = await estoqueFunctions.carregarVariacoesDeItem(item.id);
                const nomeLinha = item.linhas ? item.linhas.nome : 'Sem linha';
                
                // Formata√ß√£o da data de cadastro para melhor visualiza√ß√£o
                const dataCadastro = item.data_cadastro ? new Date(item.data_cadastro).toLocaleDateString('pt-BR') : 'N/A';
                // Pre√ßo de Custo (Se existir, formatar)
                const precoCustoDisplay = item.preco_custo ? `R$ ${parseFloat(item.preco_custo).toFixed(2)}` : 'N/A';

                html += `
                <div class="item-pai-card" id="item-pai-${item.id}">
                    <div class="item-pai-header" onclick="toggleVariacoes(${item.id})">
                        <h4>${item.nome} <small class="text-muted">(${item.categorias.nome} / ${nomeLinha} / Unidade: ${item.unidade_medida})</small></h4>
                        <div class="acoes">
                            <button class="btn btn-warning btn-small" onclick="event.stopPropagation(); editarItemPai(${item.id})">‚úèÔ∏è Editar Modelo</button>
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); excluirItemPai(${item.id})">üóëÔ∏è Desativar</button>
                        </div>
                    </div>
                    <div class="item-pai-content" id="content-${item.id}">
                        <p><strong>Descri√ß√£o:</strong> ${item.descricao || 'Sem descri√ß√£o'}</p>
                        <p style="margin-top: 10px;">
                            <strong>Custo:</strong> ${precoCustoDisplay}
                            | <strong>Qtd. M√≠nima:</strong> ${item.quantidade_minima || 0} ${item.unidade_medida}
                            | <strong>Cadastrado em:</strong> ${dataCadastro}
                        </p>
                        <hr style="margin-top: 15px; margin-bottom: 15px;">

                        <div id="variacoes-lista-${item.id}">
                            ${renderVariacoes(variacoes, item.unidade_medida)}
                        </div>
                        <button class="btn btn-success btn-small" style="margin-top:15px;" onclick="abrirModalVariacao(${item.id})">
                            ‚ûï Adicionar Varia√ß√£o de Cor
                        </button>
                    </div>
                </div>`;
            }
            lista.innerHTML = html;
        }

        function renderVariacoes(variacoes, unidade_medida) {
            if (variacoes.length === 0) {
                return '<p class="muted">Nenhuma varia√ß√£o cadastrada.</p>';
            }
            
            // ALTERA√á√ÉO: Adicionado cabe√ßalho de colunas para o grid
            const headerHtml = `
                <div class="variacao-linha" style="font-weight: bold; border-bottom: 2px solid #ccc; padding-top: 0; padding-bottom: 5px;">
                    <span>Cor</span>
                    <span>SKU/C√≥digo</span>
                    <span>Pre√ßo (${unidade_medida})</span>
                    <span>Qtd. em Estoque</span>
                    <span>A√ß√µes</span>
                </div>
            `;
            
            const variacoesHtml = variacoes.map(v => `
                <div class="variacao-linha">
                    <strong>${v.cores.nome}</strong> 
                    <span>${v.sku || 'S/ SKU'}</span>
                    <span>R$ ${v.preco_venda.toFixed(2)}</span>
                    <span>${v.quantidade_estoque} ${unidade_medida}</span>
                    <div class="acoes">
                        <button class="btn btn-warning btn-small" onclick="editarVariacao(${v.id}, ${v.item_id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-small" onclick="excluirVariacao(${v.id}, ${v.item_id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            return headerHtml + variacoesHtml;
        }

        function limparFiltros() {
            document.getElementById('filtroNome').value = '';
            document.getElementById('filtroCategoria').value = '';
            document.getElementById('filtroLinha').value = '';
            document.getElementById('filtroUnidadeMedida').value = '';
            aplicarFiltros();
        }

        function expandirTodos() {
            todosItens.forEach(item => {
                const content = document.getElementById(`content-${item.id}`);
                if (content) {
                    content.style.display = 'block';
                }
            });
        }

        function recolherTodos() {
            todosItens.forEach(item => {
                const content = document.getElementById(`content-${item.id}`);
                if (content) {
                    content.style.display = 'none';
                }
            });
        }
        
        // =============================================================================
        // FUN√á√ïES CRUD - ITEM PAI (MODELO)
        // =============================================================================
        async function salvarItemPai(event) {
            event.preventDefault();
            const item = {
                id: editandoItemPaiId,
                nome: document.getElementById('nome').value,
                categoria_id: document.getElementById('categoria').value,
                unidade_medida: document.getElementById('unidadeMedida').value,
                linha_id: document.getElementById('linha').value,
                
                // NOVOS CAMPOS PARA SALVAR:
                descricao: document.getElementById('descricao').value,
                preco_custo: parseFloat(document.getElementById('precoCusto').value) || null,
                quantidade_minima: parseFloat(document.getElementById('quantidadeMinima').value) || 0,

                ativo: true
            };

            try {
                // A fun√ß√£o estoqueFunctions.salvarItemPai (em config.js) foi ajustada para aceitar estes novos campos
                await estoqueFunctions.salvarItemPai(item);
                alert('‚úÖ Item modelo salvo com sucesso!');
                limparFormularioItemPai();
                await carregarTodosItens(); // Recarrega todos os itens ap√≥s salvar
            } catch (error) {
                alert('‚ùå Erro ao salvar item modelo: ' + error.message);
            }
        }

        async function editarItemPai(id) {
            const item = todosItens.find(i => i.id === id);
            if (!item) return;

            editandoItemPaiId = id;
            document.getElementById('itemId').value = id;
            document.getElementById('nome').value = item.nome;
            document.getElementById('categoria').value = item.categoria_id;
            document.getElementById('unidadeMedida').value = item.unidade_medida;
            document.getElementById('linha').value = item.linha_id;
            
            // NOVOS CAMPOS PARA EDI√á√ÉO:
            document.getElementById('descricao').value = item.descricao || '';
            document.getElementById('precoCusto').value = item.preco_custo || '';
            document.getElementById('quantidadeMinima').value = item.quantidade_minima || 0;

            document.getElementById('formTituloItemPai').textContent = '‚úèÔ∏è Editando Item (Modelo)';
            document.getElementById('btnCancelarEdicao').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function excluirItemPai(id) {
            if (!confirm('Tem certeza? Isso desativar√° o item e todas as suas varia√ß√µes.')) return;
            try {
                await estoqueFunctions.excluirItemPai(id);
                alert('‚úÖ Item desativado!');
                await carregarTodosItens();
            } catch(error) {
                alert('‚ùå Erro ao desativar: ' + error.message);
            }
        }

        // =============================================================================
        // FUN√á√ïES CRUD - VARIA√á√ïES
        // =============================================================================
        
        async function salvarVariacao(event) {
            event.preventDefault();
            const variacao = {
                id: document.getElementById('variacaoId').value || null,
                item_id: document.getElementById('variacaoItemId').value,
                cor_id: document.getElementById('cor').value, // Agora √© cor_id
                preco_venda: parseFloat(document.getElementById('precoVenda').value),
                quantidade_estoque: parseFloat(document.getElementById('quantidadeEstoque').value),
                sku: document.getElementById('sku').value
            };
            
            try {
                await estoqueFunctions.salvarVariacao(variacao);
                alert('‚úÖ Varia√ß√£o salva com sucesso!');
                fecharModal();
                const itemPai = todosItens.find(i => i.id == variacao.item_id);
                const variacoes = await estoqueFunctions.carregarVariacoesDeItem(variacao.item_id);
                document.getElementById(`variacoes-lista-${variacao.item_id}`).innerHTML = renderVariacoes(variacoes, itemPai.unidade_medida);
            } catch(error) {
                alert('‚ùå Erro ao salvar varia√ß√£o: ' + error.message);
            }
        }
        
        async function editarVariacao(variacaoId, itemPaiId) {
            const variacoes = await estoqueFunctions.carregarVariacoesDeItem(itemPaiId);
            const variacao = variacoes.find(v => v.id === variacaoId);
            if (!variacao) return;
            
            abrirModalVariacao(itemPaiId, variacao);
        }

        async function excluirVariacao(variacaoId, itemPaiId) {
            if (!confirm('Tem certeza que deseja excluir esta varia√ß√£o?')) return;
            try {
                await estoqueFunctions.excluirVariacao(variacaoId);
                alert('‚úÖ Varia√ß√£o exclu√≠da!');
                const itemPai = todosItens.find(i => i.id == itemPaiId);
                const variacoes = await estoqueFunctions.carregarVariacoesDeItem(itemPaiId);
                document.getElementById(`variacoes-lista-${itemPaiId}`).innerHTML = renderVariacoes(variacoes, itemPai.unidade_medida);
            } catch (error) {
                alert('‚ùå Erro ao excluir varia√ß√£o: ' + error.message);
            }
        }

        // =============================================================================
        // FUN√á√ïES AUXILIARES E DE UI
        // =============================================================================
        function toggleVariacoes(id) {
            const content = document.getElementById(`content-${id}`);
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }

        function abrirModalVariacao(itemPaiId, variacao = null) {
            document.getElementById('formVariacao').reset();
            document.getElementById('variacaoItemId').value = itemPaiId;
            
            if (variacao) { // Modo edi√ß√£o
                document.getElementById('modalTitulo').textContent = '‚úèÔ∏è Editando Varia√ß√£o';
                document.getElementById('variacaoId').value = variacao.id;
                document.getElementById('cor').value = variacao.cor_id; // Agora √© cor_id
                document.getElementById('precoVenda').value = variacao.preco_venda;
                document.getElementById('quantidadeEstoque').value = variacao.quantidade_estoque;
                document.getElementById('sku').value = variacao.sku || '';
            } else { // Modo cria√ß√£o
                document.getElementById('modalTitulo').textContent = '‚ûï Adicionar Nova Varia√ß√£o';
                document.getElementById('variacaoId').value = '';
            }
            
            document.getElementById('modalVariacao').style.display = 'flex';
        }
        
        function fecharModal() {
            document.getElementById('modalVariacao').style.display = 'none';
        }

        function limparFormularioItemPai() {
            document.getElementById('formItemPai').reset();
            editandoItemPaiId = null;
            document.getElementById('itemId').value = '';
            
            // LIMPAR NOVOS CAMPOS
            document.getElementById('descricao').value = '';
            document.getElementById('precoCusto').value = '';
            document.getElementById('quantidadeMinima').value = 0;

            document.getElementById('formTituloItemPai').textContent = '‚ûï Cadastrar Novo Item (Modelo)';
            document.getElementById('btnCancelarEdicao').classList.add('hidden');
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('modalVariacao')) {
                fecharModal();
            }
        }
    </script>
</body>
</html>