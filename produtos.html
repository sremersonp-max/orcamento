<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Produtos - Esquadrias</title>
    <link rel="stylesheet" href="styles.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* AJUSTE AQUI: Adicionado espa√ßo para o novo campo Tipo do Item */
        .linha-produto { 
            display: grid; 
            /* Colunas: Item (Modelo), Tipo do Item, F√≥rmula, Substitu√≠vel, A√ß√µes */
            grid-template-columns: minmax(200px, 1fr) 150px 200px 120px auto; 
            gap: 15px; 
            margin-bottom: 15px; 
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .input-formula {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .checkbox-substituivel {
            width: 20px !important;
            height: 20px;
        }
        
        .produto-item {
            border-left: 4px solid #3498db;
        }
        
        .badge-substituivel {
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h1>üßÆ Cadastro de Produtos Compostos</h1>
                <div style="display: flex; gap: 10px;">
                    <a href="index.html" class="btn btn-secondary">üè† In√≠cio</a>
                    <a href="estoque.html" class="btn btn-primary">üì¶ Estoque</a>
                    <a href="orcamento.html" class="btn btn-success">üìã Or√ßamentos</a>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 id="formTitulo">‚ûï Novo Produto</h2>
            <div class="grid grid-2">
                <div class="form-group">
                    <label for="nomeProduto">Nome do Produto *</label>
                    <input type="text" id="nomeProduto" placeholder="Ex: Janela de Correr 2 Folhas">
                </div>
                <div class="form-group">
                    <label for="categoriaProduto">Categoria do Produto *</label>
                    <select id="categoriaProduto"></select>
                </div>
            </div>

            <h3 style="margin-top: 25px;">üõ†Ô∏è Itens da Composi√ß√£o</h3>
            <div id="itensComposicao">
                </div>
            <button class="btn btn-primary" onclick="adicionarLinha()">‚ûï Adicionar Item</button>
            
            <div class="acoes" style="margin-top: 25px;">
                <button class="btn btn-success" onclick="salvarProduto()">üíæ Salvar Produto</button>
                <button class="btn btn-secondary hidden" id="btnCancelar" onclick="limparFormulario()">Cancelar Edi√ß√£o</button>
            </div>
        </div>

        <div class="card">
             <div class="search-box" style="margin-bottom: 20px;">
                <input type="text" id="pesquisaProduto" placeholder="üîç Pesquisar por nome ou categoria..." onkeyup="filtrarProdutos()">
            </div>
            <div id="listaProdutos">
                <div class="loading">Carregando produtos...</div>
            </div>
        </div>
    </div>

    <div class="modal" id="modalVisualizar">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitulo">Composi√ß√£o do Produto</h3>
                <button class="btn btn-danger btn-small" onclick="fecharModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalConteudo"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // =============================================================================
        // VARI√ÅVEIS GLOBAIS
        // =============================================================================
        let produtosCadastrados = [];
        let itensPaiEstoque = [];
        let categoriasProdutos = [];
        let linhasItens = [];
        let editandoProdutoId = null;

        // =============================================================================
        // INICIALIZA√á√ÉO
        // =============================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üöÄ Iniciando sistema de produtos...");
            
            try {
                await carregarCategoriasProdutos();
                await carregarItensPaiEstoque();
                await carregarProdutosBanco();
                adicionarLinha(); // Adiciona a primeira linha no formul√°rio
                console.log("‚úÖ Sistema de produtos inicializado!");
            } catch (error) {
                console.error("‚ùå Erro na inicializa√ß√£o:", error);
                document.getElementById('listaProdutos').innerHTML = 
                    '<div class="error">Erro ao carregar produtos: ' + error.message + '</div>';
            }
        });

        // Carrega apenas os ITENS PAI (modelos sem cor)
        async function carregarItensPaiEstoque() {
            try {
                console.log("üì¶ Carregando itens pai do estoque...");
                itensPaiEstoque = await estoqueFunctions.carregarItensPai();
                console.log('‚úÖ Itens pai carregados:', itensPaiEstoque.length, 'itens');
            } catch (error) {
                console.error('‚ùå Erro ao carregar itens pai:', error);
                itensPaiEstoque = [];
                document.getElementById('listaProdutos').innerHTML = 
                    '<div class="error">Erro ao carregar itens do estoque</div>';
            }
        }

        async function carregarCategoriasProdutos() {
            try {
                console.log("üìã Carregando categorias de produtos...");
                const { data, error } = await supabase
                    .from('produto_categorias')
                    .select('*')
                    .order('nome');
                
                if (error) throw error;
                
                categoriasProdutos = data || [];
                const select = document.getElementById('categoriaProduto');
                select.innerHTML = '<option value="">Selecione...</option>' + 
                    categoriasProdutos.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                
                console.log('‚úÖ Categorias carregadas:', categoriasProdutos.length, 'categorias');
            } catch (error) {
                console.error('‚ùå Erro ao carregar categorias de produtos:', error);
                categoriasProdutos = [];
            }
        }

        async function carregarProdutosBanco() {
            try {
                console.log("üìö Carregando produtos do banco...");
                const { data, error } = await supabase
                    .from('produtos')
                    .select(`*, produto_categorias(nome)`)
                    .eq('ativo', true)
                    .order('nome');
                
                if (error) throw error;
                
                produtosCadastrados = data || [];
                console.log('‚úÖ Produtos carregados:', produtosCadastrados.length, 'produtos');
                atualizarListaProdutos();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                document.getElementById('listaProdutos').innerHTML = 
                    '<div class="error">Erro ao carregar produtos: ' + error.message + '</div>';
            }
        }
        
        // =============================================================================
        // MANIPULA√á√ÉO DO FORMUL√ÅRIO DE COMPOSI√á√ÉO
        // =============================================================================
        function adicionarLinha(item = null) {
            const idLinha = `linha_${Date.now()}`;
            const itemData = item || { 
                item_id: '', 
                item_nome: '', 
                formula: '(L*2)+(A*2)', 
                substituivel: false,
                tipo_item: '' // NOVO CAMPO: Adiciona o tipo_item com valor padr√£o
            };
            linhasItens.push({ ...itemData, idLinha });
            
            // Mostra apenas itens PAI (modelos sem cor)
            const options = itensPaiEstoque.map(i => 
                `<option value="${i.id}" ${itemData.item_id == i.id ? 'selected' : ''}>
                    ${i.nome} (${i.categorias?.nome || 'Sem categoria'})
                </option>`
            ).join('');
            
            const linhaHTML = `
                <div class="linha-produto" id="${idLinha}">
                    <div class="form-group">
                        <label>Item do Estoque (Modelo Base)</label>
                        <select onchange="atualizarDadosLinha('${idLinha}', 'item_id', this.value)">
                            <option value="">Selecione um item modelo...</option>
                            ${options}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo do Item</label>
                        <select onchange="atualizarDadosLinha('${idLinha}', 'tipo_item', this.value)">
                            <option value="">Selecione o Tipo...</option>
                            <option value="Perfis" ${itemData.tipo_item === 'Perfis' ? 'selected' : ''}>Perfis</option>
                            <option value="Acessorios" ${itemData.tipo_item === 'Acessorios' ? 'selected' : ''}>Acess√≥rios</option>
                            <option value="Vidros" ${itemData.tipo_item === 'Vidros' ? 'selected' : ''}>Vidros</option>
                            <option value="Outros" ${itemData.tipo_item === 'Outros' || !itemData.tipo_item ? 'selected' : ''}>Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>F√≥rmula (L=Larg, A=Alt)</label>
                        <input type="text" class="input-formula" value="${itemData.formula}" 
                               onchange="atualizarDadosLinha('${idLinha}', 'formula', this.value)"
                               placeholder="(L*2)+(A*2)">
                    </div>
                    <div class="form-group" style="text-align:center;">
                        <label>Substitu√≠vel?</label>
                        <input type="checkbox" class="checkbox-substituivel" 
                               ${itemData.substituivel ? 'checked' : ''} 
                               onchange="atualizarDadosLinha('${idLinha}', 'substituivel', this.checked)">
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removerLinha('${idLinha}')">üóëÔ∏è</button>
                </div>`;
            document.getElementById('itensComposicao').insertAdjacentHTML('beforeend', linhaHTML);
        }

        function removerLinha(idLinha) {
            linhasItens = linhasItens.filter(l => l.idLinha !== idLinha);
            document.getElementById(idLinha).remove();
        }

        function atualizarDadosLinha(idLinha, campo, valor) {
            const linha = linhasItens.find(l => l.idLinha === idLinha);
            if (!linha) return;

            linha[campo] = valor;
            
            // Atualiza o nome do item na estrutura de dados
            if (campo === 'item_id') {
                const itemSelecionado = itensPaiEstoque.find(i => i.id == valor);
                linha.item_nome = itemSelecionado ? itemSelecionado.nome : '';
            }
        }
        
        // =============================================================================
        // CRUD DE PRODUTOS
        // =============================================================================
        async function salvarProduto() {
            const nome = document.getElementById('nomeProduto').value.trim();
            const categoriaId = document.getElementById('categoriaProduto').value;

            if (!nome) {
                alert('‚ùå O nome do produto √© obrigat√≥rio.');
                return;
            }

            if (!categoriaId) {
                alert('‚ùå A categoria do produto √© obrigat√≥ria.');
                return;
            }

            if (linhasItens.length === 0) {
                alert('‚ùå Adicione pelo menos um item na composi√ß√£o.');
                return;
            }

            // Filtra linhas vazias e remove o idLinha tempor√°rio
            const composicaoFinal = linhasItens
                .filter(l => l.item_id && l.item_id !== '')
                .map(({ idLinha, ...resto }) => resto); // 'resto' inclui o novo 'tipo_item'

            if (composicaoFinal.length === 0) {
                alert('‚ùå Selecione os itens v√°lidos para a composi√ß√£o.');
                return;
            }

            const produto = {
                nome: nome,
                categoria_id: categoriaId,
                itens_composicao: composicaoFinal,
                ativo: true
            };

            try {
                let resultado;
                if (editandoProdutoId) {
                    resultado = await supabase.from('produtos').update(produto).eq('id', editandoProdutoId);
                    if (resultado.error) throw resultado.error;
                    alert('‚úÖ Produto atualizado com sucesso!');
                } else {
                    resultado = await supabase.from('produtos').insert([produto]);
                    if (resultado.error) throw resultado.error;
                    alert('‚úÖ Produto cadastrado com sucesso!');
                }
                
                limparFormulario();
                await carregarProdutosBanco();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar produto:', error);
                alert('‚ùå Erro ao salvar produto: ' + error.message);
            }
        }
        
        function editarProduto(id) {
            const produto = produtosCadastrados.find(p => p.id === id);
            if (!produto) {
                alert('Produto n√£o encontrado');
                return;
            }

            editandoProdutoId = id;
            document.getElementById('formTitulo').textContent = '‚úèÔ∏è Editando Produto';
            document.getElementById('nomeProduto').value = produto.nome;
            document.getElementById('categoriaProduto').value = produto.categoria_id;
            
            // Limpa e recria a composi√ß√£o
            document.getElementById('itensComposicao').innerHTML = '';
            linhasItens = [];
            
            if (produto.itens_composicao && produto.itens_composicao.length > 0) {
                // Passa o objeto completo para adicionarLinha, que agora suporta o tipo_item
                produto.itens_composicao.forEach(item => adicionarLinha(item));
            } else {
                adicionarLinha(); // Adiciona uma linha vazia se n√£o houver itens
            }
            
            document.getElementById('btnCancelar').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        async function excluirProduto(id) {
            if (!confirm('Tem certeza? Isso ir√° desativar o produto, mas ele permanecer√° no hist√≥rico.')) return;
            
            try {
                const { error } = await supabase
                    .from('produtos')
                    .update({ ativo: false })
                    .eq('id', id);
                    
                if (error) throw error;
                
                alert('‚úÖ Produto desativado com sucesso!');
                await carregarProdutosBanco();
                
            } catch (error) {
                console.error('‚ùå Erro ao desativar produto:', error);
                alert('‚ùå Erro ao desativar produto: ' + error.message);
            }
        }
        
        // =============================================================================
        // UI, LISTAGEM E FILTROS
        // =============================================================================
        function atualizarListaProdutos() {
            const lista = document.getElementById('listaProdutos');
            
            if (!produtosCadastrados || produtosCadastrados.length === 0) {
                lista.innerHTML = '<div class="muted" style="text-align: center; padding: 40px;">Nenhum produto cadastrado.</div>';
                return;
            }

            lista.innerHTML = produtosCadastrados.map(p => `
                <div class="card produto-item">
                    <div style="display:flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${p.nome || 'Sem nome'}</strong>
                            <div class="text-muted">${p.produto_categorias?.nome || 'Sem categoria'}</div>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                ${p.itens_composicao?.length || 0} itens na composi√ß√£o
                                ${p.itens_composicao?.filter(item => item.substituivel).length > 0 ? 
                                    '<span class="badge-substituivel">Com itens substitu√≠veis</span>' : ''}
                            </div>
                        </div>
                        <div class="acoes">
                            <button class="btn btn-info btn-small" onclick="visualizarComposicao(${p.id})">üëÅÔ∏è Ver</button>
                            <button class="btn btn-warning btn-small" onclick="editarProduto(${p.id})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger btn-small" onclick="excluirProduto(${p.id})">üóëÔ∏è Desativar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function visualizarComposicao(id) {
            const produto = produtosCadastrados.find(p => p.id === id);
            if (!produto) {
                alert('Produto n√£o encontrado');
                return;
            }

            document.getElementById('modalTitulo').textContent = `Composi√ß√£o de ${produto.nome}`;
            
            let conteudo = '';
            
            if (produto.itens_composicao && produto.itens_composicao.length > 0) {
                conteudo = produto.itens_composicao.map(item => {
                    // Busca o nome do item PAI
                    const itemPai = itensPaiEstoque.find(i => i.id == item.item_id);
                    const nomeItem = itemPai ? itemPai.nome : `Item ID ${item.item_id} n√£o encontrado`;
                    
                    // Adiciona o tipo_item na visualiza√ß√£o
                    const tipoItem = item.tipo_item || 'N√£o Definido';

                    return `
                        <div style="padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                            <strong>${nomeItem}</strong>
                            <span class="badge ${item.tipo_item === 'Perfis' || item.tipo_item === 'Acessorios' ? 'badge-primary' : 'badge-secondary'}" style="margin-left: 10px; font-size: 11px;">${tipoItem}</span>
                            ${item.substituivel ? '<span class="badge-substituivel">Substitu√≠vel</span>' : ''}
                            <br>
                            <small class="text-muted">F√≥rmula: ${item.formula || '(L*2)+(A*2)'}</small>
                        </div>`;
                }).join('');
            } else {
                conteudo = '<p class="muted">Produto sem itens na composi√ß√£o.</p>';
            }
            
            document.getElementById('modalConteudo').innerHTML = conteudo;
            document.getElementById('modalVisualizar').style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('modalVisualizar').style.display = 'none';
        }

        function filtrarProdutos() {
            const termo = document.getElementById('pesquisaProduto').value.toLowerCase();
            
            if (!produtosCadastrados || produtosCadastrados.length === 0) {
                return;
            }
            
            const filtrados = produtosCadastrados.filter(p => {
                const nomeMatch = p.nome && p.nome.toLowerCase().includes(termo);
                const categoriaMatch = p.produto_categorias?.nome && 
                                      p.produto_categorias.nome.toLowerCase().includes(termo);
                return nomeMatch || categoriaMatch;
            });
            
            // Atualiza a lista com os produtos filtrados
            const lista = document.getElementById('listaProdutos');
            
            if (filtrados.length === 0) {
                lista.innerHTML = '<div class="muted" style="text-align: center; padding: 40px;">Nenhum produto encontrado.</div>';
                return;
            }

            lista.innerHTML = filtrados.map(p => `
                <div class="card produto-item">
                    <div style="display:flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${p.nome || 'Sem nome'}</strong>
                            <div class="text-muted">${p.produto_categorias?.nome || 'Sem categoria'}</div>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                ${p.itens_composicao?.length || 0} itens na composi√ß√£o
                                ${p.itens_composicao?.filter(item => item.substituivel).length > 0 ? 
                                    '<span class="badge-substituivel">Com itens substitu√≠veis</span>' : ''}
                            </div>
                        </div>
                        <div class="acoes">
                            <button class="btn btn-info btn-small" onclick="visualizarComposicao(${p.id})">üëÅÔ∏è Ver</button>
                            <button class="btn btn-warning btn-small" onclick="editarProduto(${p.id})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger btn-small" onclick="excluirProduto(${p.id})">üóëÔ∏è Desativar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function limparFormulario() {
            document.getElementById('nomeProduto').value = '';
            document.getElementById('categoriaProduto').value = '';
            document.getElementById('itensComposicao').innerHTML = '';
            linhasItens = [];
            editandoProdutoId = null;
            document.getElementById('formTitulo').textContent = '‚ûï Novo Produto';
            document.getElementById('btnCancelar').classList.add('hidden');
            adicionarLinha(); // Adiciona uma linha vazia
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('modalVisualizar')) {
                fecharModal();
            }
        }
    </script>
</body>
</html>