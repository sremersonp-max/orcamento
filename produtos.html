<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Produtos - Esquadrias</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS DO SEU produtos1.html --- */
        .linha-produto { 
            display: grid; 
            /* ATEN√á√ÉO: Seu arquivo original tem uma l√≥gica diferente de colunas aqui. Vou manter a do seu arquivo que funciona. */
            grid-template-columns: minmax(200px, 1fr) 150px 200px 120px auto; 
            gap: 15px; 
            margin-bottom: 15px; 
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .config-vidro {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #17a2b8;
        }
        
        .badge-vidro {
            background: #17a2b8;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        /* --- NOVOS ESTILOS PARA VISUALIZA√á√ÉO --- */
        .linha-formula-vidro {
            display: grid;
            /* Grid ATUALIZADO para incluir o campo de quantidade */
            grid-template-columns: 1fr 1fr 1fr 0.8fr 1.5fr 1fr 1fr 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: end;
            padding: 15px;
            background: white;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .preview-desenho {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .svg-preview {
            width: 100%;
            height: 120px;
            border: 1px solid #ccc;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .svg-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .mini-input {
            padding: 6px 8px;
            font-size: 12px;
        }
        
        /* Estilo para a linha de composi√ß√£o do seu arquivo original */
        .linha-composicao {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        /* Estilos para o upload de arquivo */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 6px 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
            cursor: pointer;
            color: #495057;
        }

        .file-input-label:hover {
            background: #e9ecef;
        }

        .file-name {
            font-size: 10px;
            color: #28a745;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="card" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h1>üßÆ Cadastro de Produtos Compostos</h1>
                <div style="display: flex; gap: 10px;">
                    <a href="index.html" class="btn btn-secondary">üè† In√≠cio</a>
                    <a href="estoque.html" class="btn btn-primary">üì¶ Estoque</a>
                    <a href="orcamento.html" class="btn btn-success">üìã Or√ßamentos</a>
                    <a href="pedido_tempera.html" class="btn btn-info">üîç Pedido Tempera</a>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 id="formTitulo">‚ûï Novo Produto</h2>
            <div class="grid grid-2">
                <div class="form-group">
                    <label for="nomeProduto">Nome do Produto *</label>
                    <input type="text" id="nomeProduto" placeholder="Ex: Janela de Correr 4 Folhas">
                </div>
                <div class="form-group">
                    <label for="categoriaProduto">Categoria do Produto *</label>
                    <select id="categoriaProduto"></select>
                </div>
            </div>

            <div class="config-vidro">
                <h4>üìê Configura√ß√£o de F√≥rmulas de Vidro com Visualiza√ß√£o</h4>
                <p class="text-muted">Configure as f√≥rmulas e a visualiza√ß√£o de cada pe√ßa de vidro. Agora voc√™ pode fazer UPLOAD direto da imagem.</p>
                
                <div id="listaFormulasVidro">
                    </div>
                
                <button type="button" class="btn btn-primary btn-small" onclick="adicionarFormulaVidro()">
                    ‚ûï Adicionar F√≥rmula de Vidro
                </button>
                
                <div class="preview-desenho">
                    <h5>üé® Visualiza√ß√£o Geral do Produto</h5>
                    <div id="previewGeralDesenho" class="svg-preview">
                        </div>
                </div>
            </div>

            <h3 style="margin-top: 25px;">üõ†Ô∏è Itens da Composi√ß√£o</h3>
            <div id="itensComposicao">
                </div>
            <button class="btn btn-primary" onclick="adicionarLinha()">‚ûï Adicionar Item</button>
            
            <div class="acoes" style="margin-top: 25px;">
                <button class="btn btn-success" onclick="salvarProduto()">üíæ Salvar Produto</button>
                <button class="btn btn-secondary hidden" id="btnCancelar" onclick="limparFormulario()">Cancelar Edi√ß√£o</button>
            </div>
        </div>

        <div class="card">
             <div class="search-box" style="margin-bottom: 20px;">
                <input type="text" id="pesquisaProduto" placeholder="üîç Pesquisar por nome ou categoria..." onkeyup="filtrarProdutos()">
            </div>
            <div id="listaProdutos">
                <div class="loading">Carregando produtos...</div>
            </div>
        </div>
    </div>

    <div class="modal" id="modalVisualizar">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitulo">Composi√ß√£o do Produto</h3>
                <button class="btn btn-danger btn-small" onclick="fecharModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalConteudo"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // =============================================================================
        // VARI√ÅVEIS GLOBAIS (DO SEU ARQUIVO)
        // =============================================================================
        let produtosCadastrados = [];
        let itensPaiEstoque = [];
        let categoriasProdutos = [];
        let linhasItens = [];
        let formulasVidro = []; // Array para f√≥rmulas de vidro (agora com visualiza√ß√£o)
        let editandoProdutoId = null;

        // Cores padr√£o para SVG (fallback se n√£o usar imagem)
        const CORES_PADRAO = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6'];

        // =============================================================================
        // INICIALIZA√á√ÉO (DO SEU ARQUIVO)
        // =============================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üöÄ Iniciando sistema de produtos...");
            
            try {
                await carregarCategoriasProdutos();
                await carregarItensPaiEstoque();
                await carregarProdutosBanco();
                adicionarLinha(); // Adiciona a primeira linha de COMPOSI√á√ÉO
                console.log("‚úÖ Sistema de produtos inicializado!");
            } catch (error) {
                console.error("‚ùå Erro na inicializa√ß√£o:", error);
                document.getElementById('listaProdutos').innerHTML = 
                    '<div class="error">Erro ao carregar produtos: ' + error.message + '</div>';
            }
        });

        // =============================================================================
        // NOVO SISTEMA DE F√ìRMULAS DE VIDRO (COM UPLOAD DE IMAGEM E QUANTIDADE)
        // =============================================================================
        function adicionarFormulaVidro(formulaExistente = null) {
            const idFormula = `formula_${Date.now()}`;
            const corPadrao = CORES_PADRAO[formulasVidro.length % CORES_PADRAO.length];
            
            const formulaData = formulaExistente || { 
                nome_peca: '',
                formula_largura: 'L - 0.00',
                formula_altura: 'A - 0.00', 
                descricao: '',
                quantidade_pecas: 1, // NOVO CAMPO: Quantidade de pe√ßas (padr√£o 1)
                cor_indicativa: corPadrao,
                posicao_x: formulasVidro.length * 20,
                posicao_y: 15,
                largura_svg: 40,
                altura_svg: 60,
                url_imagem_peca: '' // Agora ser√° Base64 ou URL
            };
            
            formulasVidro.push({ ...formulaData, idFormula });
            
            const linhaHtml = `
                <div class="linha-formula-vidro" id="${idFormula}">
                    <div class="form-group">
                        <label>Pe√ßa</label>
                        <input type="text" value="${formulaData.nome_peca}" 
                               placeholder="Ex: Folha Fixa"
                               class="mini-input"
                               onchange="atualizarFormulaVidro('${idFormula}', 'nome_peca', this.value)"
                               onkeyup="atualizarVisualizacaoGeral()">
                    </div>
                    <div class="form-group">
                        <label>Largura</label>
                        <input type="text" value="${formulaData.formula_largura}" 
                               placeholder="L - 0.20"
                               class="mini-input"
                               onchange="atualizarFormulaVidro('${idFormula}', 'formula_largura', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Altura</label>
                        <input type="text" value="${formulaData.formula_altura}" 
                               placeholder="A - 0.10"
                               class="mini-input"
                               onchange="atualizarFormulaVidro('${idFormula}', 'formula_altura', this.value)">
                    </div>
                    
                    <!-- NOVO CAMPO: Quantidade de Pe√ßas -->
                    <div class="form-group">
                        <label>Qtd. Pe√ßas</label>
                        <input type="number" value="${formulaData.quantidade_pecas}" 
                               class="mini-input" min="1" max="20" step="1"
                               onchange="atualizarFormulaVidro('${idFormula}', 'quantidade_pecas', parseInt(this.value)); atualizarVisualizacaoGeral()">
                    </div>
                    
                    <div class="form-group">
                        <label>Imagem da Pe√ßa</label>
                        <div class="file-input-wrapper">
                            <div class="file-input-label" id="file_label_${idFormula}">
                                üìÅ Escolher imagem
                            </div>
                            <input type="file" 
                                   id="file_input_${idFormula}"
                                   accept="image/*" 
                                   onchange="uploadImagemPeca(this, '${idFormula}')">
                        </div>
                        <div class="file-name" id="file_name_${idFormula}">
                            ${formulaData.url_imagem_peca ? '‚úÖ Imagem carregada' : 'Nenhuma imagem'}
                        </div>
                        <input type="hidden" id="url_imagem_${idFormula}" 
                               value="${formulaData.url_imagem_peca || ''}"
                               onchange="atualizarFormulaVidro('${idFormula}', 'url_imagem_peca', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>Cor (SVG)</label>
                        <input type="color" value="${formulaData.cor_indicativa}" 
                               style="height: 32px; padding: 2px;"
                               onchange="atualizarFormulaVidro('${idFormula}', 'cor_indicativa', this.value); atualizarVisualizacaoGeral()">
                    </div>
                    <div class="form-group">
                        <label>Pos X</label>
                        <input type="number" value="${formulaData.posicao_x}" 
                               class="mini-input" min="0"
                               onchange="atualizarFormulaVidro('${idFormula}', 'posicao_x', parseInt(this.value)); atualizarVisualizacaoGeral()">
                    </div>
                    <div class="form-group">
                        <label>Pos Y</label>
                        <input type="number" value="${formulaData.posicao_y}" 
                               class="mini-input" min="0"
                               onchange="atualizarFormulaVidro('${idFormula}', 'posicao_y', parseInt(this.value)); atualizarVisualizacaoGeral()">
                    </div>
                    <div class="form-group">
                        <label>Larg. Visual</label>
                        <input type="number" value="${formulaData.largura_svg}" 
                               class="mini-input" min="10"
                               onchange="atualizarFormulaVidro('${idFormula}', 'largura_svg', parseInt(this.value)); atualizarVisualizacaoGeral()">
                    </div>
                    <div class="form-group">
                        <label>Alt. Visual</label>
                        <input type="number" value="${formulaData.altura_svg}" 
                               class="mini-input" min="10"
                               onchange="atualizarFormulaVidro('${idFormula}', 'altura_svg', parseInt(this.value)); atualizarVisualizacaoGeral()">
                    </div>
                    
                    <button class="btn btn-danger btn-small" onclick="removerFormulaVidro('${idFormula}')" style="height: 32px;">üóëÔ∏è</button>
                </div>
                
                <div class="preview-desenho" id="preview_container_${idFormula}">
                    <small><strong>Preview da Pe√ßa: ${formulaData.nome_peca || 'Nova Pe√ßa'}</strong> ${formulaData.quantidade_pecas > 1 ? `(x${formulaData.quantidade_pecas})` : ''}</small>
                    <div id="preview_${idFormula}" class="svg-preview" style="height: 80px;">
                        ${gerarConteudoVisualPeca(formulaData)}
                    </div>
                </div>
            `;
            
            document.getElementById('listaFormulasVidro').insertAdjacentHTML('beforeend', linhaHtml);
            atualizarVisualizacaoGeral();
        }

        // =============================================================================
        // FUN√á√ÉO DE UPLOAD DE IMAGEM (BASE64) - NOVA FUN√á√ÉO
        // =============================================================================
        function uploadImagemPeca(input, idFormula) {
            const file = input.files[0];
            if (!file) return;
            
            // Verifica se √© imagem
            if (!file.type.startsWith('image/')) {
                alert('‚ùå Por favor, selecione apenas arquivos de imagem (JPG, PNG, SVG, etc.)');
                return;
            }
            
            // Verifica tamanho (m√°x 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('‚ùå Imagem muito grande! M√°ximo 2MB.');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Converte para Base64
                const base64Image = e.target.result;
                
                // Atualiza o campo hidden com Base64
                document.getElementById(`url_imagem_${idFormula}`).value = base64Image;
                
                // Atualiza a f√≥rmula
                atualizarFormulaVidro(idFormula, 'url_imagem_peca', base64Image);
                
                // Atualiza o nome do arquivo
                document.getElementById(`file_name_${idFormula}`).textContent = `‚úÖ ${file.name}`;
                document.getElementById(`file_label_${idFormula}`).textContent = 'üìÅ Trocar imagem';
                
                // Atualiza preview individual
                const previewIndividual = document.getElementById(`preview_${idFormula}`);
                if (previewIndividual) {
                    previewIndividual.innerHTML = gerarConteudoVisualPeca({
                        ...formulasVidro.find(f => f.idFormula === idFormula),
                        url_imagem_peca: base64Image
                    });
                }
                
                atualizarVisualizacaoGeral();
            };
            
            reader.onerror = function() {
                alert('‚ùå Erro ao carregar a imagem. Tente novamente.');
            };
            
            reader.readAsDataURL(file);
        }

        // Gera <img> se tiver URL/Base64, sen√£o gera <svg>
        function gerarConteudoVisualPeca(formula) {
            if (formula.url_imagem_peca) {
                return `<img src="${formula.url_imagem_peca}" alt="${formula.nome_peca || 'Pe√ßa'}" 
                             style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            } else {
                // Fallback para SVG
                return `
                    <svg width="${formula.largura_svg}" height="${formula.altura_svg}" viewBox="0 0 ${formula.largura_svg} ${formula.altura_svg}">
                        <rect x="0" y="0" width="${formula.largura_svg}" height="${formula.altura_svg}"
                              fill="${formula.cor_indicativa}40" 
                              stroke="${formula.cor_indicativa}" 
                              stroke-width="2"/>
                        <text x="50%" y="50%" font-size="10" text-anchor="middle" dominant-baseline="middle" fill="#000">SVG</text>
                    </svg>
                `;
            }
        }

        function atualizarVisualizacaoGeral() {
            const container = document.getElementById('previewGeralDesenho');
            if (formulasVidro.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Adicione f√≥rmulas para ver a visualiza√ß√£o</div>';
                return;
            }
            container.innerHTML = gerarSVGGeralComImagens();
        }

        // Gera o SVG principal que cont√©m as imagens (AGORA COM MULTIPLAS PE√áAS)
        function gerarSVGGeralComImagens() {
            let pecasParaRenderizar = [];
            
            // Expande as pe√ßas baseado na quantidade
            formulasVidro.forEach((formula, index) => {
                for (let i = 0; i < (formula.quantidade_pecas || 1); i++) {
                    pecasParaRenderizar.push({
                        ...formula,
                        // Desloca ligeiramente pe√ßas m√∫ltiplas para visualiza√ß√£o
                        posicao_x: formula.posicao_x + (i * 5),
                        posicao_y: formula.posicao_y + (i * 3),
                        // Adiciona √≠ndice para identifica√ß√£o
                        indiceMultipla: i + 1
                    });
                }
            });

            return `
                <svg width="100%" height="100%" viewBox="0 0 200 150">
                    <rect x="10" y="10" width="180" height="130" fill="none" stroke="#333" stroke-width="2"/>
                    
                    ${pecasParaRenderizar.map((formula, index) => {
                        const x = formula.posicao_x + 15;
                        const y = formula.posicao_y + 15;
                        const width = formula.largura_svg;
                        const height = formula.altura_svg;
                        const textoIndice = formula.quantidade_pecas > 1 ? `${index + 1}.${formula.indiceMultipla}` : (index + 1);

                        if (formula.url_imagem_peca) {
                            return `
                                <image href="${formula.url_imagem_peca}" 
                                       x="${x}" y="${y}" 
                                       width="${width}" height="${height}"
                                       preserveAspectRatio="xMidYMid meet"/>
                                <text x="${x + width/2}" y="${y + height/2}" font-size="8" text-anchor="middle" dominant-baseline="middle"
                                      fill="#000" font-weight="bold" stroke="#fff" stroke-width="0.5">
                                    ${textoIndice}
                                </text>
                            `;
                        } else {
                            // Fallback para <rect>
                            return `
                                <rect x="${x}" y="${y}" width="${width}" height="${height}"
                                      fill="${formula.cor_indicativa}40" stroke="${formula.cor_indicativa}" stroke-width="1.5" rx="2"/>
                                <text x="${x + width/2}" y="${y + height/2}" font-size="8" text-anchor="middle" dominant-baseline="middle"
                                      fill="#2c3e50" font-weight="bold">
                                    ${textoIndice}
                                </text>
                            `;
                        }
                    }).join('')}
                    
                    <text x="100" y="145" font-size="10" text-anchor="middle" fill="#666">
                        Visualiza√ß√£o: ${pecasParaRenderizar.length} pe√ßa(s) total
                    </text>
                </svg>
            `;
        }
        
        // Gera o SVG para o MODAL (para n√£o conflitar com o formul√°rio)
        function gerarSVGGeralComImagensModal(formulas) {
            // Esta fun√ß√£o √© uma c√≥pia da 'gerarSVGGeralComImagens' mas recebe as f√≥rmulas
            // como argumento, para usar no modal e no pedido de tempera.
            if (!formulas || formulas.length === 0) {
                 return '<div style="text-align: center; padding: 40px; color: #666;">Sem visualiza√ß√£o</div>';
            }
            
            let pecasParaRenderizar = [];
            
            // Expande as pe√ßas baseado na quantidade (tamb√©m no modal)
            formulas.forEach((formula, index) => {
                for (let i = 0; i < (formula.quantidade_pecas || 1); i++) {
                    pecasParaRenderizar.push({
                        ...formula,
                        posicao_x: formula.posicao_x + (i * 5),
                        posicao_y: formula.posicao_y + (i * 3),
                        indiceMultipla: i + 1
                    });
                }
            });

            return `
                <svg width="100%" height="100%" viewBox="0 0 200 150">
                    <rect x="10" y="10" width="180" height="130" fill="none" stroke="#333" stroke-width="2"/>
                    ${pecasParaRenderizar.map((formula, index) => {
                        const x = (formula.posicao_x || 0) + 15;
                        const y = (formula.posicao_y || 0) + 15;
                        const width = formula.largura_svg || 50;
                        const height = formula.altura_svg || 50;
                        const textoIndice = formula.quantidade_pecas > 1 ? `${index + 1}.${formula.indiceMultipla}` : (index + 1);

                        if (formula.url_imagem_peca) {
                            return `
                                <image href="${formula.url_imagem_peca}" 
                                       x="${x}" y="${y}" 
                                       width="${width}" height="${height}"
                                       preserveAspectRatio="xMidYMid meet"/>
                                <text x="${x + width/2}" y="${y + height/2}" font-size="8" text-anchor="middle" dominant-baseline="middle"
                                      fill="#000" font-weight="bold" stroke="#fff" stroke-width="0.5">
                                    ${textoIndice}
                                </text>
                            `;
                        } else {
                            return `
                                <rect x="${x}" y="${y}" width="${width}" height="${height}"
                                      fill="${formula.cor_indicativa || '#3498db'}40" stroke="${formula.cor_indicativa || '#3498db'}" stroke-width="1.5" rx="2"/>
                                <text x="${x + width/2}" y="${y + height/2}" font-size="8" text-anchor="middle" dominant-baseline="middle"
                                      fill="#2c3e50" font-weight="bold">
                                    ${textoIndice}
                                </text>
                            `;
                        }
                    }).join('')}
                    <text x="100" y="145" font-size="10" text-anchor="middle" fill="#666">
                        Visualiza√ß√£o: ${pecasParaRenderizar.length} pe√ßa(s) total
                    </text>
                </svg>
            `;
        }

        function removerFormulaVidro(idFormula) {
            formulasVidro = formulasVidro.filter(f => f.idFormula !== idFormula);
            document.getElementById(idFormula).remove();
            document.getElementById(`preview_container_${idFormula}`)?.remove(); // Remove o preview individual
            atualizarVisualizacaoGeral();
        }

        function atualizarFormulaVidro(idFormula, campo, valor) {
            const formula = formulasVidro.find(f => f.idFormula === idFormula);
            if (formula) {
                formula[campo] = valor;
                
                // Atualiza preview individual
                const previewIndividual = document.getElementById(`preview_${idFormula}`);
                if (previewIndividual) {
                    previewIndividual.innerHTML = gerarConteudoVisualPeca(formula);
                }
                // Atualiza o nome no t√≠tulo do preview individual
                const containerPreview = document.getElementById(`preview_container_${idFormula}`);
                if (containerPreview) {
                    if (campo === 'nome_peca') {
                        containerPreview.querySelector('small strong').textContent = `Preview da Pe√ßa: ${valor || 'Nova Pe√ßa'}${formula.quantidade_pecas > 1 ? ` (x${formula.quantidade_pecas})` : ''}`;
                    } else if (campo === 'quantidade_pecas') {
                        containerPreview.querySelector('small strong').textContent = `Preview da Pe√ßa: ${formula.nome_peca || 'Nova Pe√ßa'}${valor > 1 ? ` (x${valor})` : ''}`;
                    }
                }
            }
            // N√£o atualiza o geral aqui por performance, s√≥ no onchange/onkeyup dos inputs visuais
        }

        // =============================================================================
        // SUAS FUN√á√ïES DE CARREGAMENTO (N√ÉO MODIFICADAS)
        // =============================================================================
        
        async function carregarItensPaiEstoque() {
            try {
                console.log("üì¶ Carregando itens pai do estoque...");
                // Usando a fun√ß√£o do config.js
                itensPaiEstoque = await window.estoqueFunctions.carregarItensPai(); 
                console.log('‚úÖ Itens pai carregados:', itensPaiEstoque.length, 'itens');
            } catch (error) {
                console.error('‚ùå Erro ao carregar itens pai:', error);
                itensPaiEstoque = [];
            }
        }

        async function carregarCategoriasProdutos() {
            try {
                console.log("üìã Carregando categorias de produtos...");
                // Usando a tabela 'produto_categorias' do seu arquivo
                const { data, error } = await supabase
                    .from('produto_categorias') 
                    .select('*')
                    .order('nome');
                
                if (error) throw error;
                
                categoriasProdutos = data || [];
                const select = document.getElementById('categoriaProduto');
                select.innerHTML = '<option value="">Selecione...</option>' + 
                    categoriasProdutos.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                
                console.log('‚úÖ Categorias carregadas:', categoriasProdutos.length, 'categorias');
            } catch (error) {
                console.error('‚ùå Erro ao carregar categorias de produtos:', error);
                categoriasProdutos = [];
            }
        }

        async function carregarProdutosBanco() {
            try {
                console.log("üìö Carregando produtos do banco...");
                const { data, error } = await supabase
                    .from('produtos')
                    .select(`*, produto_categorias(nome)`) // Tabela correta
                    .eq('ativo', true)
                    .order('nome');
                
                if (error) throw error;
                
                produtosCadastrados = data || [];
                console.log('‚úÖ Produtos carregados:', produtosCadastrados.length, 'produtos');
                atualizarListaProdutos(); // Sua fun√ß√£o de listagem
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                document.getElementById('listaProdutos').innerHTML = 
                    '<div class="error">Erro ao carregar produtos: ' + error.message + '</div>';
            }
        }

        // =============================================================================
        // SUAS FUN√á√ïES DE COMPOSI√á√ÉO (N√ÉO MODIFICADAS)
        // =============================================================================

        function adicionarLinha(item = null) {
            const idLinha = `linha_${Date.now()}`;
            const itemData = item || { 
                item_id: '', 
                item_nome: '', 
                formula: '(L*2)+(A*2)', 
                substituivel: false,
                tipo_item: ''
            };
            linhasItens.push({ ...itemData, idLinha });
            
            const options = itensPaiEstoque.map(i => 
                `<option value="${i.id}" ${itemData.item_id == i.id ? 'selected' : ''}>
                    ${i.nome} (${i.categorias?.nome || 'Sem categoria'})
                </option>`
            ).join('');
            
            const linhaHTML = `
                <div class="linha-composicao" id="${idLinha}"> <div class="form-group">
                        <label>Item do Estoque (Modelo Base)</label>
                        <select onchange="atualizarDadosLinha('${idLinha}', 'item_id', this.value)">
                            <option value="">Selecione um item modelo...</option>
                            ${options}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo do Item</label>
                        <select onchange="atualizarDadosLinha('${idLinha}', 'tipo_item', this.value)">
                            <option value="">Selecione o Tipo...</option>
                            <option value="Perfis" ${itemData.tipo_item === 'Perfis' ? 'selected' : ''}>Perfis</option>
                            <option value="Acessorios" ${itemData.tipo_item === 'Acessorios' ? 'selected' : ''}>Acess√≥rios</option>
                            <option value="Vidros" ${itemData.tipo_item === 'Vidros' ? 'selected' : ''}>Vidros</option>
                            <option value="Outros" ${itemData.tipo_item === 'Outros' || !itemData.tipo_item ? 'selected' : ''}>Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>F√≥rmula (L=Larg, A=Alt)</label>
                        <input type="text" class="input-formula" value="${itemData.formula}" 
                               onchange="atualizarDadosLinha('${idLinha}', 'formula', this.value)"
                               placeholder="(L*2)+(A*2)">
                    </div>
                    <div class="form-group" style="text-align:center;">
                        <label>Substitu√≠vel?</label>
                        <input type="checkbox" class="checkbox-substituivel" 
                               ${itemData.substituivel ? 'checked' : ''} 
                               onchange="atualizarDadosLinha('${idLinha}', 'substituivel', this.checked)">
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removerLinha('${idLinha}')">üóëÔ∏è</button>
                </div>`;
            document.getElementById('itensComposicao').insertAdjacentHTML('beforeend', linhaHTML);
        }

        function removerLinha(idLinha) {
            linhasItens = linhasItens.filter(l => l.idLinha !== idLinha);
            document.getElementById(idLinha).remove();
        }

        function atualizarDadosLinha(idLinha, campo, valor) {
            const linha = linhasItens.find(l => l.idLinha === idLinha);
            if (!linha) return;

            linha[campo] = valor;
            
            if (campo === 'item_id') {
                const itemSelecionado = itensPaiEstoque.find(i => i.id == valor);
                linha.item_nome = itemSelecionado ? itemSelecionado.nome : '';
            }
        }

        // =============================================================================
        // CRUD DE PRODUTOS - ATUALIZADO PARA SALVAR IMAGENS/SVG E QUANTIDADES
        // =============================================================================
        async function salvarProduto() {
            const nome = document.getElementById('nomeProduto').value.trim();
            const categoriaId = document.getElementById('categoriaProduto').value;

            // Valida√ß√µes do seu arquivo
            if (!nome || !categoriaId || linhasItens.length === 0) {
                alert('‚ùå Preencha Nome, Categoria e adicione Itens de Composi√ß√£o.');
                return;
            }

            // Filtra f√≥rmulas de vidro v√°lidas (com os novos campos)
            const formulasParaSalvar = formulasVidro
                .filter(f => f.nome_peca && f.formula_largura && f.formula_altura && f.url_imagem_peca) // Exige imagem
                .map(({ idFormula, ...resto }) => resto); // Remove o idFormula tempor√°rio

            if (formulasVidro.length > 0 && formulasParaSalvar.length !== formulasVidro.length) {
                alert('‚ö†Ô∏è Aten√ß√£o: Algumas f√≥rmulas de vidro n√£o foram salvas. Verifique se preencheu Pe√ßa, F√≥rmulas e a Imagem em todas.');
            }
            
            // Sua l√≥gica de composi√ß√£o (n√£o modificada)
            const composicaoFinal = linhasItens
                .filter(l => l.item_id && l.item_id !== '')
                .map(({ idLinha, ...resto }) => resto);

            if (composicaoFinal.length === 0) {
                alert('‚ùå Selecione os itens v√°lidos para a composi√ß√£o.');
                return;
            }

            const produto = {
                nome: nome,
                categoria_id: categoriaId,
                itens_composicao: composicaoFinal,
                ativo: true
            };

            try {
                let produtoId;
                
                if (editandoProdutoId) {
                    const { error } = await supabase.from('produtos').update(produto).eq('id', editandoProdutoId);
                    if (error) throw error;
                    produtoId = editandoProdutoId;
                } else {
                    const { data, error } = await supabase.from('produtos').insert([produto]).select();
                    if (error) throw error;
                    produtoId = data[0].id;
                }

                // SALVA AS F√ìRMULAS DE VIDRO (COM VISUALIZA√á√ÉO E QUANTIDADE)
                
                // Remove f√≥rmulas antigas (se editando)
                if (editandoProdutoId) {
                    await supabase.from('produto_vidros').delete().eq('produto_id', produtoId);
                }
                
                if (formulasParaSalvar.length > 0) {
                    // Insere novas f√≥rmulas com dados de visualiza√ß√£o E QUANTIDADE
                    const formulasComVisualizacao = formulasParaSalvar.map((formula, index) => ({
                        ...formula,
                        produto_id: produtoId,
                        ordem: index,
                        // Garante que todos os campos de visualiza√ß√£o existam
                        quantidade_pecas: formula.quantidade_pecas || 1, // NOVO: Salva a quantidade
                        cor_indicativa: formula.cor_indicativa || CORES_PADRAO[index % CORES_PADRAO.length],
                        posicao_x: formula.posicao_x || index * 20,
                        posicao_y: formula.posicao_y || 15,
                        largura_svg: formula.largura_svg || 40,
                        altura_svg: formula.altura_svg || 60,
                        url_imagem_peca: formula.url_imagem_peca // J√° validado (agora pode ser Base64)
                    }));
                    
                    const { error: errorFormulas } = await supabase
                        .from('produto_vidros')
                        .insert(formulasComVisualizacao);
                    
                    if (errorFormulas) throw errorFormulas;
                }

                alert(`‚úÖ Produto salvo com sucesso! ${formulasParaSalvar.length} f√≥rmula(s) de vidro.`);
                limparFormulario();
                await carregarProdutosBanco();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar produto:', error);
                alert('‚ùå Erro ao salvar produto: ' + error.message);
            }
        }

        function editarProduto(id) {
            const produto = produtosCadastrados.find(p => p.id === id);
            if (!produto) return;

            editandoProdutoId = id;
            document.getElementById('formTitulo').textContent = '‚úèÔ∏è Editando Produto';
            document.getElementById('nomeProduto').value = produto.nome;
            document.getElementById('categoriaProduto').value = produto.categoria_id;
            
            // Sua l√≥gica de composi√ß√£o (n√£o modificada)
            document.getElementById('itensComposicao').innerHTML = '';
            linhasItens = [];
            if (produto.itens_composicao && produto.itens_composicao.length > 0) {
                produto.itens_composicao.forEach(item => adicionarLinha(item));
            } else {
                adicionarLinha();
            }
            
            // CARREGA AS F√ìRMULAS DE VIDRO (COM VISUALIZA√á√ÉO E QUANTIDADE)
            carregarFormulasVidroProduto(id);
            
            document.getElementById('btnCancelar').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function carregarFormulasVidroProduto(produtoId) {
            try {
                const { data, error } = await supabase
                    .from('produto_vidros')
                    .select('*') // Pega todos os campos, incluindo os novos
                    .eq('produto_id', produtoId)
                    .order('ordem');
                
                if (error) throw error;
                
                // Limpa f√≥rmulas atuais
                formulasVidro = [];
                document.getElementById('listaFormulasVidro').innerHTML = '';
                
                // Adiciona cada f√≥rmula com os dados de visualiza√ß√£o E QUANTIDADE
                if (data && data.length > 0) {
                    data.forEach(formula => {
                        adicionarFormulaVidro(formula); // A fun√ß√£o 'adicionarFormulaVidro' j√° sabe lidar com os novos campos
                    });
                }
                
                atualizarVisualizacaoGeral(); // Garante que o preview geral seja renderizado
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar f√≥rmulas de vidro:', error);
            }
        }

        // Sua fun√ß√£o de excluir (desativar) (N√£o modificada)
        async function excluirProduto(id) {
            if (!confirm('Tem certeza? Isso ir√° desativar o produto, mas ele permanecer√° no hist√≥rico.')) return;
            
            try {
                const { error } = await supabase
                    .from('produtos')
                    .update({ ativo: false })
                    .eq('id', id);
                    
                if (error) throw error;
                
                alert('‚úÖ Produto desativado com sucesso!');
                await carregarProdutosBanco();
                
            } catch (error) {
                console.error('‚ùå Erro ao desativar produto:', error);
                alert('‚ùå Erro ao desativar produto: ' + error.message);
            }
        }
        
        // =============================================================================
        // SUAS FUN√á√ïES DE UI E LISTAGEM (ATUALIZADAS PARA VISUALIZA√á√ÉO)
        // =============================================================================
        
        // Sua fun√ß√£o (n√£o modificada)
        function atualizarListaProdutos() {
            const lista = document.getElementById('listaProdutos');
            
            if (!produtosCadastrados || produtosCadastrados.length === 0) {
                lista.innerHTML = '<div class="muted" style="text-align: center; padding: 40px;">Nenhum produto cadastrado.</div>';
                return;
            }

            // HTML da sua fun√ß√£o original
            lista.innerHTML = produtosCadastrados.map(p => {
                const temItensSubstituiveis = p.itens_composicao?.filter(item => item.substituivel).length > 0;
                
                return `
                    <div class="card produto-item" style="padding: 15px; border: 1px solid #eee;">
                        <div style="display:flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong>${p.nome || 'Sem nome'}</strong>
                                <div class="text-muted">${p.produto_categorias?.nome || 'Sem categoria'}</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ${p.itens_composicao?.length || 0} itens na composi√ß√£o
                                    ${temItensSubstituiveis ? 
                                        '<span class="badge-substituivel">Substitu√≠veis</span>' : ''}
                                    <span class="badge-vidro" onclick="visualizarFormulasVidro(${p.id})" style="cursor: pointer;">üìê Ver F√≥rmulas</span>
                                </div>
                            </div>
                            <div class="acoes">
                                <button class="btn btn-info btn-small" onclick="visualizarComposicao(${p.id})">üëÅÔ∏è Ver</button>
                                <button class="btn btn-warning btn-small" onclick="editarProduto(${p.id})">‚úèÔ∏è Editar</button>
                                <button class="btn btn-danger btn-small" onclick="excluirProduto(${p.id})">üóëÔ∏è Desativar</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ATUALIZADA para mostrar a visualiza√ß√£o no modal (COM QUANTIDADES)
        async function visualizarFormulasVidro(produtoId) {
            try {
                const { data, error } = await supabase
                    .from('produto_vidros')
                    .select('*') // Pega todos os campos, incluindo os visuais
                    .eq('produto_id', produtoId)
                    .order('ordem');
                
                if (error) throw error;
                
                const produto = produtosCadastrados.find(p => p.id === produtoId);
                document.getElementById('modalTitulo').textContent = `F√≥rmulas de Vidro - ${produto.nome}`;
                
                let conteudo = '';
                
                // Adiciona o Preview Geral no topo do Modal
                conteudo += `
                    <div class="preview-desenho">
                        <h5>Visualiza√ß√£o Geral</h5>
                        <div class="svg-preview" style="height: 150px;">
                            ${gerarSVGGeralComImagensModal(data)}
                        </div>
                    </div>
                `;

                if (data && data.length > 0) {
                    conteudo += '<div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">';
                    data.forEach((formula) => {
                        // NOVO: Mostra a quantidade na listagem
                        const quantidadeInfo = formula.quantidade_pecas > 1 ? ` (x${formula.quantidade_pecas})` : '';
                        
                        conteudo += `
                            <div style="display: flex; gap: 10px; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: #f8f9fa; margin-bottom: 8px; border-radius: 5px;">
                                <div style="width: 60px; height: 60px; border: 1px solid #ccc; background: #fff; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                                    ${formula.url_imagem_peca ? 
                                        `<img src="${formula.url_imagem_peca}" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : 
                                        'Sem Img'}
                                </div>
                                <div>
                                    <strong>${formula.nome_peca}${quantidadeInfo}</strong>
                                    <div style="font-family: monospace; margin: 5px 0;">
                                        üìè ${formula.formula_largura} √ó ${formula.formula_altura}
                                    </div>
                                </div>
                            </div>`;
                    });
                    conteudo += '</div>';
                } else {
                    conteudo += '<p class="muted">Este produto n√£o tem f√≥rmulas de vidro cadastradas.</p>';
                }
                
                document.getElementById('modalConteudo').innerHTML = conteudo;
                document.getElementById('modalVisualizar').style.display = 'block'; // 'flex' no seu original, mas 'block' √© mais seguro
                
            } catch (error) {
                console.error('Erro ao carregar f√≥rmulas:', error);
                alert('Erro ao carregar f√≥rmulas: ' + error.message);
            }
        }

        // Sua fun√ß√£o de visualizar composi√ß√£o (n√£o modificada)
        function visualizarComposicao(id) {
            const produto = produtosCadastrados.find(p => p.id === id);
            if (!produto) return;

            document.getElementById('modalTitulo').textContent = `Composi√ß√£o de ${produto.nome}`;
            
            let conteudo = '';
            
            if (produto.itens_composicao && produto.itens_composicao.length > 0) {
                conteudo += '<strong>Itens da Composi√ß√£o:</strong>';
                conteudo += produto.itens_composicao.map(item => {
                    const itemPai = itensPaiEstoque.find(i => i.id == item.item_id);
                    const nomeItem = itemPai ? itemPai.nome : `Item ID ${item.item_id} n√£o encontrado`;
                    const tipoItem = item.tipo_item || 'N√£o Definido';

                    return `
                        <div style="padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                            <strong>${nomeItem}</strong>
                            <span class="badge ${item.tipo_item === 'Perfis' || item.tipo_item === 'Acessorios' ? 'badge-primary' : 'badge-secondary'}" style="margin-left: 10px; font-size: 11px;">${tipoItem}</span>
                            ${item.substituivel ? '<span class="badge-substituivel">Substitu√≠vel</span>' : ''}
                            <br>
                            <small class="text-muted">F√≥rmula: ${item.formula || '(L*2)+(A*2)'}</small>
                        </div>`;
                }).join('');
            } else {
                conteudo = '<p class="muted">Produto sem itens na composi√ß√£o.</p>';
            }
            
            conteudo += `<div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-info btn-small" onclick="visualizarFormulasVidro(${id})">
                    üìê Ver F√≥rmulas de Vidro (com Imagens)
                </button>
            </div>`;
            
            document.getElementById('modalConteudo').innerHTML = conteudo;
            document.getElementById('modalVisualizar').style.display = 'block';
        }

        // Sua fun√ß√£o (n√£o modificada)
        function fecharModal() {
            document.getElementById('modalVisualizar').style.display = 'none';
        }

        // Sua fun√ß√£o (n√£o modificada)
        function filtrarProdutos() {
            const termo = document.getElementById('pesquisaProduto').value.toLowerCase();
            
            if (!produtosCadastrados || produtosCadastrados.length === 0) return;
            
            const filtrados = produtosCadastrados.filter(p => {
                const nomeMatch = p.nome && p.nome.toLowerCase().includes(termo);
                const categoriaMatch = p.produto_categorias?.nome && 
                                      p.produto_categorias.nome.toLowerCase().includes(termo);
                return nomeMatch || categoriaMatch;
            });
            
            // Re-renderiza a lista com base no filtro
            // (Reutilizando sua l√≥gica de renderiza√ß√£o original)
            const lista = document.getElementById('listaProdutos');
            if (filtrados.length === 0) {
                lista.innerHTML = '<div class="muted" style="text-align: center; padding: 40px;">Nenhum produto encontrado.</div>';
                return;
            }
            lista.innerHTML = filtrados.map(p => {
                const temItensSubstituiveis = p.itens_composicao?.filter(item => item.substituivel).length > 0;
                return `
                    <div class="card produto-item" style="padding: 15px; border: 1px solid #eee;">
                        <div style="display:flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong>${p.nome || 'Sem nome'}</strong>
                                <div class="text-muted">${p.produto_categorias?.nome || 'Sem categoria'}</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    ${p.itens_composicao?.length || 0} itens na composi√ß√£o
                                    ${temItensSubstituiveis ? '<span class="badge-substituivel">Substitu√≠veis</span>' : ''}
                                    <span class="badge-vidro" onclick="visualizarFormulasVidro(${p.id})" style="cursor: pointer;">üìê Ver F√≥rmulas</span>
                                </div>
                            </div>
                            <div class="acoes">
                                <button class="btn btn-info btn-small" onclick="visualizarComposicao(${p.id})">üëÅÔ∏è Ver</button>
                                <button class="btn btn-warning btn-small" onclick="editarProduto(${p.id})">‚úèÔ∏è Editar</button>
                                <button class="btn btn-danger btn-small" onclick="excluirProduto(${p.id})">üóëÔ∏è Desativar</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        // ATUALIZADO para limpar os novos campos
        function limparFormulario() {
            document.getElementById('nomeProduto').value = '';
            document.getElementById('categoriaProduto').value = '';
            document.getElementById('itensComposicao').innerHTML = '';
            document.getElementById('listaFormulasVidro').innerHTML = '';
            linhasItens = [];
            formulasVidro = []; // Limpa array de vidros
            editandoProdutoId = null;
            document.getElementById('formTitulo').textContent = '‚ûï Novo Produto';
            document.getElementById('btnCancelar').classList.add('hidden');
            // Limpa o preview geral
            document.getElementById('previewGeralDesenho').innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Adicione f√≥rmulas para ver a visualiza√ß√£o</div>';
            adicionarLinha();
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('modalVisualizar')) {
                fecharModal();
            }
        }
    </script>
</body>
</html>