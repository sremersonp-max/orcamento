<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impress√£o T√©rmica - Or√ßamentos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #2c3e50;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 420px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .content {
            padding: 20px;
        }
        
        .config-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .preview-section {
            background: white;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .preview-title {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .termica-preview {
            background: white;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.3;
            padding: 10px;
            border: 1px solid #34495e;
            white-space: pre-line;
            min-height: 200px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .alert {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .alert-error {
            background: #fde8e8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .linha-divisoria {
            border-top: 1px dashed #7f8c8d;
            margin: 10px 0;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-bold {
            font-weight: bold;
        }
        
        .orcamentos-salvos {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .orcamento-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .orcamento-item:hover {
            background: #f0f8ff;
        }
        
        .orcamento-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñ®Ô∏è IMPRESS√ÉO T√âRMICA</h1>
            <p>Sistema de Etiquetas para Or√ßamentos</p>
        </div>

        <div class="content">
            <div id="alertContainer"></div>

            <div class="config-section" id="seletorOrcamentos">
                <h3>üìã Selecionar Or√ßamento</h3>
                <div class="form-group">
                    <label for="selectOrcamentoSalvo">Or√ßamentos Salvos</label>
                    <select id="selectOrcamentoSalvo" onchange="carregarOrcamentoSelecionado()">
                        <option value="">Selecione um or√ßamento salvo...</option>
                    </select>
                </div>
                <div class="loading" id="loadingOrcamentos">Carregando or√ßamentos...</div>
                <div class="text-center" style="margin-top: 10px;">
                    <small class="text-muted">Ou use o or√ßamento atual do sistema</small>
                </div>
            </div>

            <div class="config-section">
                <h3>‚öôÔ∏è Configura√ß√µes da Impressora</h3>
                
                <div class="form-group">
                    <label for="selectImpressora">Selecionar Impressora</label>
                    <select id="selectImpressora">
                        <option value="termica">Impressora T√©rmica 80mm</option>
                        <option value="pdf">PDF (Simula√ß√£o)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="copias">N√∫mero de C√≥pias</label>
                    <input type="number" id="copias" value="1" min="1" max="10">
                </div>
                
                <div class="form-group">
                    <label for="observacoesImpressao">Observa√ß√µes na Etiqueta</label>
                    <textarea id="observacoesImpressao" placeholder="Observa√ß√µes adicionais..."></textarea>
                </div>
            </div>

            <div class="config-section" id="infoOrcamento">
                <h3>üìã Dados do Or√ßamento</h3>
                <div class="loading" id="loadingOrcamento">Carregando dados do or√ßamento...</div>
                <div id="dadosOrcamento" class="hidden">
                    <div class="form-group">
                        <label>Cliente</label>
                        <input type="text" id="cliente" readonly>
                    </div>
                    
                    <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="text" id="telefone" readonly>
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="text" id="dataOrcamento" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Localiza√ß√£o</label>
                        <input type="text" id="localizacao" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Total do Or√ßamento</label>
                        <input type="text" id="totalOrcamento" readonly class="text-bold">
                    </div>
                    
                    <div class="form-group">
                        <label>Status</label>
                        <input type="text" id="statusOrcamento" readonly>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3>üéØ A√ß√µes</h3>
                <button class="btn btn-primary" onclick="carregarPreview()">
                    üëÅÔ∏è Visualizar Pr√©via
                </button>
                <!-- NOVO BOT√ÉO ADICIONADO AQUI -->
                <button class="btn btn-info" onclick="imprimirTermica60Linhas()" id="btnImprimir60" disabled>
                    üìü 60 Linhas (TXT)
                </button>
                <button class="btn btn-success" onclick="imprimirTermica()" id="btnImprimir" disabled>
                    üñ®Ô∏è Imprimir Etiqueta
                </button>
                <button class="btn btn-warning" onclick="imprimirPDF()">
                    üìÑ Gerar PDF
                </button>
                <button class="btn btn-danger" onclick="window.close()">
                    ‚ùå Fechar
                </button>
            </div>

            <div class="preview-section hidden" id="previewSection">
                <div class="preview-title">PR√âVIA DA ETIQUETA</div>
                <div class="termica-preview" id="termicaPreview">
                    </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // =============================================================================
        // VARI√ÅVEIS GLOBAIS
        // =============================================================================
        let orcamentoData = null;
        let orcamentosSalvos = [];

        // =============================================================================
        // INICIALIZA√á√ÉO
        // =============================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üñ®Ô∏è Iniciando sistema de impress√£o t√©rmica...');
            await carregarOrcamentosSalvos();
            await carregarDadosOrcamento();
        });

        // =============================================================================
        // CARREGAMENTO DE OR√áAMENTOS SALVOS
        // =============================================================================
        async function carregarOrcamentosSalvos() {
            try {
                console.log('üóÉÔ∏è Carregando or√ßamentos salvos...');
                
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('id, cliente, data, status, total, margem')
                    .order('data', { ascending: false })
                    .limit(50);

                if (error) throw error;

                orcamentosSalvos = data || [];
                atualizarSelectOrcamentos();
                
                console.log(`‚úÖ ${orcamentosSalvos.length} or√ßamentos carregados`);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar or√ßamentos:', error);
                mostrarAlerta('‚ùå Erro ao carregar or√ßamentos salvos', 'error');
            }
        }

        function atualizarSelectOrcamentos() {
            const select = document.getElementById('selectOrcamentoSalvo');
            const loading = document.getElementById('loadingOrcamentos');
            
            if (orcamentosSalvos.length === 0) {
                loading.innerHTML = '‚ùå Nenhum or√ßamento encontrado';
                return;
            }

            loading.classList.add('hidden');
            
            select.innerHTML = '<option value="">Selecione um or√ßamento salvo...</option>' +
                orcamentosSalvos.map(orc => {
                    const dataFormatada = formatarData(orc.data);
                    const totalVenda = (orc.total || 0) * (orc.margem || 1);
                    return `<option value="${orc.id}">
                        ${orc.cliente} - ${dataFormatada} - R$ ${totalVenda.toFixed(2)} - ${orc.status}
                    </option>`;
                }).join('');
        }

        // =============================================================================
        // CARREGAMENTO DE DADOS DO OR√áAMENTO
        // =============================================================================
        async function carregarDadosOrcamento() {
            try {
                // Tenta primeiro carregar do localStorage (orcamento atual)
                const dadosSalvos = localStorage.getItem('orcamentoParaImpressao');
                
                if (dadosSalvos) {
                    // Modo: Or√ßamento atual em mem√≥ria
                    orcamentoData = JSON.parse(dadosSalvos);
                    console.log('üì¶ Dados do or√ßamento atual carregados:', orcamentoData);
                    preencherDadosOrcamento();
                    mostrarAlerta('‚úÖ Or√ßamento atual carregado com sucesso!', 'success');
                    return;
                }

                // Se n√£o tem no localStorage, busca da URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const orcamentoId = urlParams.get('id');
                
                if (orcamentoId) {
                    // Carrega or√ßamento espec√≠fico da URL
                    await carregarOrcamentoDoBanco(orcamentoId);
                    return;
                }

                // Se n√£o encontrou nenhum dos dois, mostra instru√ß√µes
                mostrarAlerta('‚ÑπÔ∏è Selecione um or√ßamento salvo ou use o sistema principal', 'info');
                document.getElementById('loadingOrcamento').innerHTML = 
                    '‚ÑπÔ∏è Nenhum or√ßamento carregado.<br>Selecione um or√ßamento salvo acima.';
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                mostrarAlerta('‚ùå Erro ao carregar or√ßamento: ' + error.message, 'error');
            }
        }

        async function carregarOrcamentoSelecionado() {
            const orcamentoId = document.getElementById('selectOrcamentoSalvo').value;
            if (!orcamentoId) return;
            
            await carregarOrcamentoDoBanco(orcamentoId);
        }

        async function carregarOrcamentoDoBanco(orcamentoId) {
            try {
                console.log('üóÉÔ∏è Carregando or√ßamento do banco:', orcamentoId);
                
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('id, cliente, telefone, localizacao, observacoes, data, status, produtos, total, margem')
                    .eq('id', orcamentoId)
                    .single();

                if (error) throw error;
                if (!data) throw new Error('Or√ßamento n√£o encontrado');

                // Converte os dados do banco para o formato esperado
                orcamentoData = {
                    id: data.id,
                    cliente: data.cliente,
                    telefone: data.telefone,
                    localizacao: data.localizacao,
                    observacoes: data.observacoes,
                    data: data.data,
                    status: data.status,
                    produtos: data.produtos || [],
                    total: data.total || 0,
                    margem: data.margem || 1
                };

                console.log('‚úÖ Or√ßamento carregado do banco:', orcamentoData);
                preencherDadosOrcamento();
                mostrarAlerta(`‚úÖ Or√ßamento de ${orcamentoData.cliente} carregado!`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar or√ßamento do banco:', error);
                mostrarAlerta('‚ùå Erro ao carregar or√ßamento: ' + error.message, 'error');
            }
        }

        function preencherDadosOrcamento() {
            if (!orcamentoData) return;

            document.getElementById('cliente').value = orcamentoData.cliente || 'N√£o informado';
            document.getElementById('telefone').value = orcamentoData.telefone || 'N√£o informado';
            document.getElementById('localizacao').value = orcamentoData.localizacao || 'N√£o informado';
            document.getElementById('dataOrcamento').value = orcamentoData.data || new Date().toLocaleDateString('pt-BR');
            document.getElementById('statusOrcamento').value = orcamentoData.status || 'rascunho';
            
            const total = (orcamentoData.total || 0) * (orcamentoData.margem || 1);
            document.getElementById('totalOrcamento').value = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

            document.getElementById('loadingOrcamento').classList.add('hidden');
            document.getElementById('dadosOrcamento').classList.remove('hidden');
        }

        // =============================================================================
        // GERA√á√ÉO DA PR√âVIA
        // =============================================================================
        function carregarPreview() {
            if (!orcamentoData) {
                mostrarAlerta('‚ùå Selecione ou carregue um or√ßamento primeiro.', 'error');
                return;
            }

            const preview = gerarConteudoTermica();
            document.getElementById('termicaPreview').textContent = preview;
            document.getElementById('previewSection').classList.remove('hidden');
            document.getElementById('btnImprimir').disabled = false;
            document.getElementById('btnImprimir60').disabled = false; // Habilita o novo bot√£o tamb√©m
            
            // Scroll para a pr√©via
            document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
        }

        function gerarConteudoTermica() {
            if (!orcamentoData) return '';
            
            const margem = orcamentoData.margem || 1;
            const totalVenda = (orcamentoData.total || 0) * margem;
            const observacoes = document.getElementById('observacoesImpressao').value;
            const copias = parseInt(document.getElementById('copias').value) || 1;

            let conteudo = '';
            
            // Cabe√ßalho - MODIFICADO
            conteudo += '‚ïê'.repeat(42) + '\n';
            conteudo += ' '.repeat(10) + '** OFICINA DA FAM√çLIA **' + '\n';
            conteudo += ' '.repeat(8) + 'Tel: (42) 99960-8330' + '\n';
            conteudo += '‚ïê'.repeat(42) + '\n\n';
            
            // Dados do Cliente
            conteudo += 'CLIENTE: ' + (orcamentoData.cliente || 'N√£o informado') + '\n';
            conteudo += 'TEL: ' + (orcamentoData.telefone || 'N√£o informado') + '\n';
            conteudo += 'LOCAL: ' + (orcamentoData.localizacao || 'N√£o informado') + '\n';
            conteudo += 'DATA: ' + (orcamentoData.data || new Date().toLocaleDateString('pt-BR')) + '\n';
            conteudo += 'STATUS: ' + (orcamentoData.status || 'rascunho') + '\n';
            conteudo += '‚îÄ'.repeat(42) + '\n\n';
            
            // Produtos - MODIFICADO
            conteudo += '**PRODUTOS:**\n';
            conteudo += '‚îÄ'.repeat(42) + '\n';
            
            if (orcamentoData.produtos && orcamentoData.produtos.length > 0) {
                orcamentoData.produtos.forEach((produto, index) => {
                    let nomeProduto = '';
                    let descricao = '';
                    
                    if (produto.isAvulso) {
                        nomeProduto = produto.nomeAvulso || 'Item Avulso';
                        descricao = `Qtd: ${produto.quantidade} ${produto.unidadeMedida}`;
                    } else {
                        // Tenta obter nome do produto base
                        nomeProduto = produto.descricao || `Produto ${produto.produtoId}`;
                        descricao = `Dim: ${produto.largura || 0}m x ${produto.altura || 0}m`;
                        if (produto.quantidade > 1) {
                            descricao += ` - Qtd: ${produto.quantidade}`;
                        }
                    }
                    
                    const precoVenda = (produto.preco || 0) * margem;
                    
                    // Quebra linha longa se necess√°rio
                    if (nomeProduto.length > 30) {
                        nomeProduto = nomeProduto.substring(0, 30) + '...';
                    }
                    
                    conteudo += `${index + 1}. ${nomeProduto}\n`;
                    conteudo += `   ${descricao}\n`;
                    conteudo += `   R$ ${precoVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                    
                    if (index < orcamentoData.produtos.length - 1) {
                        conteudo += '   ‚îÄ\n';
                    }
                });
            } else {
                conteudo += 'Nenhum produto\n';
            }
            
            conteudo += '\n' + '‚îÄ'.repeat(42) + '\n';
            
            // Totais - MODIFICADO (mant√©m c√°lculo da margem mas oculta a exibi√ß√£o)
            conteudo += 'RESUMO:\n';
            conteudo += `Produtos: ${orcamentoData.produtos?.length || 0}\n`;
            // REMOVIDA A LINHA DA MARGEM
            conteudo += '‚îÄ'.repeat(42) + '\n';
            conteudo += 'TOTAL: R$ ' + totalVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
            conteudo += '‚ïê'.repeat(42) + '\n';
            
            // Observa√ß√µes
            if (observacoes) {
                conteudo += '\nOBS: ' + observacoes + '\n';
                conteudo += '‚îÄ'.repeat(42) + '\n';
            }
            
            // Rodap√© - MODIFICADO
            conteudo += '\n';
            conteudo += ' '.repeat(10) + '**OBRIGADO!**\n';
            conteudo += ' '.repeat(8) + 'Volte sempre!\n';
            conteudo += '‚ïê'.repeat(42) + '\n';
            conteudo += `C√≥pia: 1/${copias}\n`;
            conteudo += 'üìû (42) 99960-8330\n\n';
            
            // C√≥digo de barras simulado
            conteudo += '||||| '.repeat(7) + '\n';
            conteudo += `COD: ${orcamentoData.id || 'TEMPORARIO'}\n`;
            conteudo += '||||| '.repeat(7) + '\n';

            return conteudo;
        }

        // =============================================================================
        // NOVA FUN√á√ÉO: IMPRESS√ÉO T√âRMICA 60 LINHAS
        // =============================================================================
        function imprimirTermica60Linhas() {
            if (!orcamentoData) {
                mostrarAlerta('‚ùå Selecione ou carregue um or√ßamento primeiro.', 'error');
                return;
            }

            try {
                const conteudo = gerarConteudoTermica60Linhas();
                const copias = parseInt(document.getElementById('copias').value) || 1;
                
                // Criar arquivo de texto para impress√£o t√©rmica
                const blob = new Blob([conteudo], { 
                    type: 'text/plain; charset=utf-8' 
                });
                
                // Criar URL para download
                const url = URL.createObjectURL(blob);
                
                // Criar link de download
                const link = document.createElement('a');
                link.href = url;
                link.download = `termica_60mm_${orcamentoData.cliente || 'cliente'}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.txt`;
                
                // Simular clique para download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Liberar mem√≥ria
                URL.revokeObjectURL(url);
                
                mostrarAlerta(`‚úÖ Arquivo para impressora 60mm gerado! ${copias} c√≥pia(s)`, 'success');
                
                // Instru√ß√µes para o usu√°rio
                setTimeout(() => {
                    mostrarAlerta('üí° Dica: Use o arquivo .txt com software de impress√£o t√©rmica', 'info');
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erro na gera√ß√£o do arquivo 60mm:', error);
                mostrarAlerta('‚ùå Erro ao gerar arquivo: ' + error.message, 'error');
            }
        }

        function gerarConteudoTermica60Linhas() {
            if (!orcamentoData) return '';
            
            const margem = orcamentoData.margem || 1;
            const totalVenda = (orcamentoData.total || 0) * margem;
            const observacoes = document.getElementById('observacoesImpressao').value;
            const copias = parseInt(document.getElementById('copias').value) || 1;

            let conteudo = '';
            
            // Configura√ß√£o para 60mm (aproximadamente 32 caracteres de largura)
            const larguraLinha = 32;
            
            // Fun√ß√£o para centralizar texto
            const centralizar = (texto) => {
                const espacos = Math.max(0, larguraLinha - texto.length);
                const espacosEsquerda = Math.floor(espacos / 2);
                return ' '.repeat(espacosEsquerda) + texto;
            };
            
            // Fun√ß√£o para linha divis√≥ria
            const linhaDivisoria = (caractere = '=') => caractere.repeat(larguraLinha);
            
            // Cabe√ßalho - MODIFICADO
            conteudo += linhaDivisoria() + '\n';
            conteudo += centralizar('OFICINA DA FAM√çLIA') + '\n';
            conteudo += centralizar('(42) 99960-8330') + '\n';
            conteudo += linhaDivisoria() + '\n\n';
            
            // Dados do Cliente
            conteudo += 'CLIENTE: ' + (orcamentoData.cliente || 'N/I') + '\n';
            conteudo += 'TEL: ' + (orcamentoData.telefone || 'N/I') + '\n';
            conteudo += 'LOCAL: ' + (orcamentoData.localizacao || 'N/I') + '\n';
            conteudo += 'DATA: ' + (orcamentoData.data || new Date().toLocaleDateString('pt-BR')) + '\n';
            conteudo += 'STATUS: ' + (orcamentoData.status || 'rascunho') + '\n';
            conteudo += linhaDivisoria('-') + '\n\n';
            
            // Produtos (formato compacto para 60mm) - MODIFICADO
            conteudo += 'PRODUTOS:\n';
            conteudo += linhaDivisoria('-') + '\n';
            
            if (orcamentoData.produtos && orcamentoData.produtos.length > 0) {
                orcamentoData.produtos.forEach((produto, index) => {
                    let nomeProduto = '';
                    let descricao = '';
                    
                    if (produto.isAvulso) {
                        nomeProduto = (produto.nomeAvulso || 'Item Avulso').substring(0, 20);
                        descricao = `${produto.quantidade}${produto.unidadeMedida || 'un'}`;
                    } else {
                        nomeProduto = (produto.descricao || `Prod ${produto.produtoId}`).substring(0, 15);
                        descricao = `${produto.largura || 0}x${produto.altura || 0}m`;
                        if (produto.quantidade > 1) {
                            descricao += ` x${produto.quantidade}`;
                        }
                    }
                    
                    const precoVenda = (produto.preco || 0) * margem;
                    
                    // Formato compacto para 60mm
                    const linhaProduto = `${index + 1}. ${nomeProduto}`.padEnd(18);
                    const linhaDescricao = `${descricao}`.padEnd(10);
                    const linhaPreco = `R$ ${precoVenda.toFixed(2)}`;
                    
                    conteudo += linhaProduto + linhaDescricao + linhaPreco + '\n';
                });
            } else {
                conteudo += 'Nenhum produto\n';
            }
            
            conteudo += '\n' + linhaDivisoria('-') + '\n';
            
            // Totais compactos - MODIFICADO (mant√©m c√°lculo mas oculta margem)
            conteudo += 'RESUMO:\n';
            conteudo += `Itens: ${orcamentoData.produtos?.length || 0}\n`;
            // REMOVIDA A LINHA DA MARGEM
            conteudo += linhaDivisoria('-') + '\n';
            conteudo += `TOTAL: R$ ${totalVenda.toFixed(2)}`.padStart(larguraLinha) + '\n';
            conteudo += linhaDivisoria() + '\n';
            
            // Observa√ß√µes (quebrar linha se necess√°rio)
            if (observacoes) {
                conteudo += '\nOBS: ';
                let obsRestante = observacoes;
                while (obsRestante.length > 0) {
                    const pedaco = obsRestante.substring(0, larguraLinha - 5);
                    conteudo += pedaco + '\n';
                    obsRestante = obsRestante.substring(pedaco.length);
                    if (obsRestante.length > 0) {
                        conteudo += '     ';
                    }
                }
                conteudo += linhaDivisoria('-') + '\n';
            }
            
            // Rodap√© - MODIFICADO
            conteudo += '\n';
            conteudo += centralizar('**OBRIGADO!**') + '\n';
            conteudo += centralizar('Volte sempre!') + '\n';
            conteudo += linhaDivisoria() + '\n';
            conteudo += `C√≥pia: 1/${copias}`.padStart(larguraLinha) + '\n';
            conteudo += '(42) 99960-8330\n\n';
            
            // C√≥digo de barras simulado compacto
            conteudo += '|'.repeat(larguraLinha) + '\n';
            conteudo += `COD: ${orcamentoData.id || 'TEMP'}`.padStart(larguraLinha) + '\n';
            conteudo += '|'.repeat(larguraLinha) + '\n';

            return conteudo;
        }

        // =============================================================================
        // FUN√á√ïES DE IMPRESS√ÉO EXISTENTES (MANTIDAS)
        // =============================================================================
        function imprimirTermica() {
            const tipoImpressora = document.getElementById('selectImpressora').value;
            const copias = parseInt(document.getElementById('copias').value) || 1;
            
            if (tipoImpressora === 'pdf') {
                imprimirPDF();
                return;
            }

            try {
                const conteudo = gerarConteudoTermica();
                
                // Criar uma nova janela para impress√£o
                const janelaImpressao = window.open('', '_blank');
                janelaImpressao.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Impress√£o T√©rmica - Or√ßamento</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 12px; 
                                margin: 0; 
                                padding: 10px;
                                width: 280px;
                            }
                            .conteudo-termica { white-space: pre-line; line-height: 1.2; }
                            @media print {
                                body { margin: 0; padding: 5px; }
                                @page { margin: 0; size: 80mm auto; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="conteudo-termica">${conteudo}</div>
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(() => window.close(), 1000);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                janelaImpressao.document.close();

                mostrarAlerta(`‚úÖ ${copias} c√≥pia(s) enviada(s) para impress√£o!`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erro na impress√£o:', error);
                mostrarAlerta('‚ùå Erro na impress√£o: ' + error.message, 'error');
            }
        }

        function imprimirPDF() {
            try {
                const conteudo = gerarConteudoTermica();
                const blob = new Blob([conteudo], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `orcamento_${orcamentoData.cliente || 'cliente'}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.txt`;
                link.click();
                
                URL.revokeObjectURL(url);
                mostrarAlerta('‚úÖ PDF gerado e baixado com sucesso!', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar PDF:', error);
                mostrarAlerta('‚ùå Erro ao gerar PDF: ' + error.message, 'error');
            }
        }

        // =============================================================================
        // FUN√á√ïES AUXILIARES (MANTIDAS)
        // =============================================================================
        function mostrarAlerta(mensagem, tipo) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo}`;
            alert.textContent = mensagem;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function formatarData(data) {
            if (!data) return 'Data inv√°lida';
            if (data.includes('/')) return data;
            if (data.includes('-')) {
                const [ano, mes, dia] = data.split('-');
                return `${dia}/${mes}/${ano}`;
            }
            return data;
        }

        // Suporte para impress√£o direta via USB
        function imprimirDiretoUSB() {
            console.log('üîå Conectando com impressora t√©rmica via USB...');
            mostrarAlerta('‚ö†Ô∏è Funcionalidade USB requer configura√ß√£o adicional.', 'error');
        }
    </script>
</body>
</html>
