<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos de Vidros para Tempera - F√≥rmulas Espec√≠ficas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* ... (Todos os seus estilos originais) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 25px 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .content { padding: 30px; }
        .card { background: #f8f9fa; border-radius: 10px; padding: 25px; margin-bottom: 25px; border-left: 4px solid #3498db; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; margin: 5px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; }
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        
        .produto-tempera-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #f39c12; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .produto-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 15px; align-items: end; margin-bottom: 15px; }
        .vidro-info { background: #e8f4f8; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 3px solid #17a2b8; }
        .folha-info { background: #f8f9fa; padding: 8px 12px; margin: 5px 0; border-radius: 4px; border-left: 2px solid #3498db; }
        .tabela-vidros { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tabela-vidros th { background: #34495e; color: white; padding: 15px; text-align: left; font-weight: 600; }
        .tabela-vidros td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; }
        .tabela-vidros tr:hover { background: #f8f9fa; }
        .total-section { background: #2c3e50; color: white; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; }
        .total-geral { font-size: 24px; font-weight: bold; color: #27ae60; margin-top: 10px; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .hidden { display: none; }
        .error { color: #e74c3c; background: #fde8e8; padding: 10px; border-radius: 5px; }
        .success { color: #27ae60; background: #e8f8ef; padding: 10px; border-radius: 5px; }
        .badge-formula { background: #6c757d; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 8px; cursor: help; }
        
        /* --- NOVOS ESTILOS PARA O PREVIEW DA IMAGEM --- */
        .preview-desenho-tempera {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .svg-preview-tempera {
            width: 100%;
            height: 120px;
            border: 1px solid #ccc;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .svg-preview-tempera img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        /* --- FIM DOS NOVOS ESTILOS --- */

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .produto-header { grid-template-columns: 1fr; gap: 10px; }
            .content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Pedidos de Vidros para Tempera - F√≥rmulas Espec√≠ficas</h1>
            <p>Sistema que usa as f√≥rmulas cadastradas em cada produto</p>
        </div>

        <div class="content">
            <div class="card">
                <h2>üèóÔ∏è Selecionar Obra para Calcular Vidros</h2>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label for="selecionarObra">Selecionar Obra Aprovada</label>
                        <select id="selecionarObra" onchange="carregarProdutosObra()">
                            <option value="">Carregando obras...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clienteObra">Cliente</label>
                        <input type="text" id="clienteObra" readonly>
                    </div>
                    <div class="form-group">
                        <label for="localizacaoObra">Localiza√ß√£o</label>
                        <input type="text" id="localizacaoObra" readonly>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>‚öôÔ∏è Configura√ß√µes do Pedido</h2>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label for="dataPedido">Data do Pedido</label>
                        <input type="text" id="dataPedido" readonly>
                    </div>
                    <div class="form-group">
                        <label for="fornecedorVidro">Fornecedor de Vidros</label>
                        <select id="fornecedorVidro">
                            <option value="Tempera Norte">Tempera Norte</option>
                            <option value="Vidra√ßaria Central">Vidra√ßaria Central</option>
                            <option value="Tempera Sul">Tempera Sul</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoVidro">Tipo de Vidro</label>
                        <select id="tipoVidro">
                            <option value="incolor">Incolor</option>
                            <option value="fum√™">Fum√™</option>
                            <option value="bronze">Bronze</option>
                            <option value="verde">Verde</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="observacoesTempera">Observa√ß√µes</label>
                        <textarea id="observacoesTempera" rows="3" placeholder="Observa√ß√µes para o fornecedor..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="margemAdicional">Margem Adicional (cm)</label>
                        <input type="number" id="margemAdicional" value="0.0" step="0.1" min="0">
                        <small style="color: #666;">Margem extra para aplicar em todas as f√≥rmulas (opcional)</small>
                    </div>
                </div>
            </div>

            <div class="card" id="cardProdutosObra" style="display: none;">
                <h2>üìã Produtos da Obra Selecionada</h2>
                <div id="infoObra" style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong id="infoCliente"></strong><br>
                    <small id="infoLocalizacao"></small>
                </div>
                
                <div id="listaProdutosObra">
                    <div class="loading">Carregando produtos da obra...</div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="calcularTodosVidrosObra()">
                        üßÆ Calcular Todos os Vidros da Obra
                    </button>
                </div>
            </div>

            <div class="card" id="resumoVidros" style="display: none;">
                <h2>üìä Resumo dos Vidros para Tempera</h2>
                
                <div id="tabelaResumoVidros">
                    <table class="tabela-vidros">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Pe√ßa</th>
                                <th>F√≥rmula</th>
                                <th>Medidas Vidro</th>
                                <th>Quantidade</th>
                                <th>√Årea (m¬≤)</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaVidros">
                        </tbody>
                    </table>
                </div>
                
                <div class="total-section">
                    <h3>üì¶ Resumo Geral da Obra</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div>Total de Produtos: <span id="totalProdutosVidro">0</span></div>
                        <div>Total de Vidros: <span id="totalVidros">0</span></div>
                        <div>√Årea Total: <span id="areaTotal">0 m¬≤</span></div>
                    </div>
                    <div class="total-geral" id="totalGeralVidros">√Årea Total: 0 m¬≤</div>
                </div>

                <div class="acoes" style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="gerarPDFTempera()">
                        üìÑ Gerar PDF para Tempera
                    </button>
                    <button class="btn btn-info" onclick="gerarPlanilha()">
                        üìä Exportar para Excel
                    </button>
                    <button class="btn btn-primary" onclick="limparPedido()">
                        üÜï Novo Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // =============================================================================
        // VARI√ÅVEIS GLOBAIS
        // =============================================================================
        let obrasAprovadas = [];
        let produtosObra = [];
        let vidrosCalculados = [];
        let produtosCadastrados = []; // <-- ADICIONADO para buscar nomes dos produtos
        let formulasPorProduto = {}; // Cache das f√≥rmulas {produtoId: [formulas...]}

        // =============================================================================
        // INICIALIZA√á√ÉO
        // =============================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîç Iniciando sistema de pedidos para tempera...');
            atualizarData();
            
            try {
                await carregarObrasAprovadas();
                await carregarTodosProdutosBase(); // <-- ADICIONADO Carrega nomes dos produtos
                console.log('‚úÖ Sistema de tempera pronto!');
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                alert('Erro ao carregar dados: ' + error.message);
            }
        });

        function atualizarData() {
            const now = new Date();
            const dataFormatada = now.toLocaleDateString('pt-BR');
            document.getElementById('dataPedido').value = dataFormatada;
        }

        // =============================================================================
        // CARREGAMENTO DE DADOS
        // =============================================================================
        async function carregarObrasAprovadas() {
            try {
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('id, cliente, localizacao, data, status')
                    .eq('status', 'aprovado')
                    .order('data', { ascending: false });

                if (error) throw error;
                
                obrasAprovadas = data || [];
                atualizarSelectObras();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar obras aprovadas:', error);
                document.getElementById('selecionarObra').innerHTML = '<option value="">Erro ao carregar obras</option>';
            }
        }
        
        // <-- FUN√á√ÉO ADICIONADA -->
        // Carrega os nomes dos produtos base para podermos exibir
        async function carregarTodosProdutosBase() {
             try {
                const { data, error } = await supabase
                    .from('produtos') // A tabela 'produtos' que voc√™ cadastra
                    .select('id, nome'); // S√≥ precisamos do ID e nome
                
                if (error) throw error;
                produtosCadastrados = data || [];
                console.log('‚úÖ Nomes de produtos base carregados.');
            } catch (error) {
                console.error('‚ùå Erro ao carregar nomes de produtos:', error);
            }
        }


        function atualizarSelectObras() {
            const select = document.getElementById('selecionarObra');
            select.innerHTML = '<option value="">Selecione uma obra...</option>';
            
            obrasAprovadas.forEach(obra => {
                const dataFormatada = formatarData(obra.data);
                select.innerHTML += `<option value="${obra.id}">${obra.cliente} - ${obra.localizacao || 'Sem local'} (${dataFormatada})</option>`;
            });
        }

        function formatarData(data) {
            if (!data) return 'Data inv√°lida';
            if (data.includes('/')) return data;
            if (data.includes('-')) {
                // Pega s√≥ a parte da data (antes do 'T' de tempo)
                const [ano, mes, dia] = data.split('T')[0].split('-');
                return `${dia}/${mes}/${ano}`;
            }
            return data;
        }

        // =============================================================================
        // CARREGAMENTO DE PRODUTOS DA OBRA
        // =============================================================================
        async function carregarProdutosObra() {
            const obraId = document.getElementById('selecionarObra').value;
            if (!obraId) return;

            try {
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('*')
                    .eq('id', obraId)
                    .single();

                if (error) throw error;

                // Preenche informa√ß√µes da obra
                document.getElementById('clienteObra').value = data.cliente || '';
                document.getElementById('localizacaoObra').value = data.localizacao || '';
                document.getElementById('infoCliente').textContent = `Cliente: ${data.cliente}`;
                document.getElementById('infoLocalizacao').textContent = `Local: ${data.localizacao || 'N√£o informado'}`;
                
                // Carrega produtos da obra
                produtosObra = data.produtos || [];
                
                // Carrega f√≥rmulas de vidro (incluindo campos visuais)
                await carregarFormulasParaProdutosObra();
                
                renderizarProdutosObra();
                document.getElementById('cardProdutosObra').style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos da obra:', error);
                alert('Erro ao carregar obra: ' + error.message);
            }
        }

        // =============================================================================
        // CARREGAMENTO DE F√ìRMULAS
        // =============================================================================
        async function carregarFormulasParaProdutosObra() {
            formulasPorProduto = {};
            
            const produtosComId = produtosObra.filter(p => !p.isAvulso && p.produtoId);
            if (produtosComId.length === 0) return;
            
            const produtoIds = [...new Set(produtosComId.map(p => p.produtoId))];
            
            try {
                // O select('*') J√Å VAI PEGAR os novos campos (url_imagem_peca, etc)
                const { data, error } = await supabase
                    .from('produto_vidros')
                    .select('*') 
                    .in('produto_id', produtoIds)
                    .order('ordem');
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    data.forEach(formula => {
                        if (!formulasPorProduto[formula.produto_id]) {
                            formulasPorProduto[formula.produto_id] = [];
                        }
                        formulasPorProduto[formula.produto_id].push(formula);
                    });
                }
                
                console.log('‚úÖ F√≥rmulas (com visualiza√ß√£o) carregadas:', Object.keys(formulasPorProduto).length);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar f√≥rmulas:', error);
            }
        }
        
        // <-- FUN√á√ÉO ADICIONADA -->
        // Fun√ß√£o para gerar o SVG/Imagem (copiada do produtos.html)
        function gerarSVGGeralComImagensModal(formulas) {
            if (!formulas || formulas.length === 0) {
                 return '<div style="text-align: center; padding: 40px; color: #666;">Sem visualiza√ß√£o</div>';
            }
            
            return `
                <svg width="100%" height="100%" viewBox="0 0 200 150">
                    <rect x="10" y="10" width="180" height="130" fill="none" stroke="#333" stroke-width="2"/>
                    ${formulas.map((formula, index) => {
                        // Usa valores padr√£o caso n√£o existam (para evitar erros)
                        const x = (formula.posicao_x || 0) + 15;
                        const y = (formula.posicao_y || 0) + 15;
                        const width = formula.largura_svg || 50;
                        const height = formula.altura_svg || 50;

                        if (formula.url_imagem_peca) {
                            return `
                                <image href="${formula.url_imagem_peca}" 
                                       x="${x}" y="${y}" 
                                       width="${width}" height="${height}"
                                       preserveAspectRatio="xMidYMid meet"/>
                                <text x="${x + width/2}" y="${y + height/2}" font-size="8" text-anchor="middle" dominant-baseline="middle"
                                      fill="#000" font-weight="bold" stroke="#fff" stroke-width="0.5">
                                    ${index + 1}
                                </text>
                            `;
                        } else {
                            // Fallback para SVG se n√£o houver imagem
                            return `
                                <rect x="${x}" y="${y}" width="${width}" height="${height}"
                                      fill="${formula.cor_indicativa || '#3498db'}40" stroke="${formula.cor_indicativa || '#3498db'}" stroke-width="1.5" rx="2"/>
                                <text x="${x + width/2}" y="${y + height/2}" font-size="8" text-anchor="middle" dominant-baseline="middle"
                                      fill="#2c3e50" font-weight="bold">
                                    ${index + 1}
                                </text>
                            `;
                        }
                    }).join('')}
                    <text x="100" y="145" font-size="10" text-anchor="middle" fill="#666">
                        Visualiza√ß√£o: ${formulas.length} pe√ßa(s)
                    </text>
                </svg>
            `;
        }

        // =============================================================================
        // RENDERIZA√á√ÉO DOS PRODUTOS (ATUALIZADA COM VISUALIZA√á√ÉO)
        // =============================================================================
        function renderizarProdutosObra() {
            const container = document.getElementById('listaProdutosObra');
            
            if (produtosObra.length === 0) {
                container.innerHTML = '<div class="loading">Nenhum produto encontrado nesta obra</div>';
                return;
            }

            container.innerHTML = produtosObra.map(produto => {
                const produtoInfo = obterInfoProduto(produto);
                const temFormulas = produtoInfo.temFormulas;
                const quantidadeFormulas = produtoInfo.quantidadeFormulas;
                
                // <-- ADICIONADO --> Pega as f√≥rmulas para gerar o preview
                const formulas = formulasPorProduto[produto.produtoId] || [];
                const previewHtml = temFormulas ? gerarSVGGeralComImagensModal(formulas) : '';

                return `
                    <div class="produto-tempera-card" id="produto_${produto.id}">
                        <div class="produto-header">
                            <div class="form-group">
                                <label>Produto</label>
                                <p style="font-weight: bold; margin: 0; font-size: 16px;">${produtoInfo.nome}</p>
                                <small style="color: #666;">
                                    ${temFormulas ? 
                                        `<span class="badge-formula" title="${quantidadeFormulas} f√≥rmula(s) cadastrada(s)">üìê ${quantidadeFormulas} f√≥rmula(s)</span>` : 
                                        '<span style="color: #e74c3c;">‚ùå Sem f√≥rmulas de vidro</span>'}
                                </small>
                            </div>
                            <div class="form-group">
                                <label>Largura (m)</label>
                                <input type="number" id="largura_${produto.id}" 
                                       value="${produto.largura || ''}" 
                                       placeholder="1.20" min="0.1" step="0.01" 
                                       onchange="calcularVidroProduto('${produto.id}')">
                            </div>
                            <div class="form-group">
                                <label>Altura (m)</label>
                                <input type="number" id="altura_${produto.id}" 
                                       value="${produto.altura || ''}" 
                                       placeholder="2.00" min="0.1" step="0.01"
                                       onchange="calcularVidroProduto('${produto.id}')">
                            </div>
                            <div class="form-group">
                                <label>Quantidade</label>
                                <input type="number" id="quantidade_${produto.id}" 
                                       value="${produto.quantidade || 1}" min="1"
                                       onchange="calcularVidroProduto('${produto.id}')">
                            </div>
                            <button class="btn btn-info" onclick="calcularVidroProduto('${produto.id}')" 
                                    ${!temFormulas ? 'disabled title="Produto sem f√≥rmulas de vidro cadastradas"' : ''}>
                                üßÆ Calcular
                            </button>
                        </div>
                        
                        PREVIEW VISUAL INSERIDO AQUI -->
                        ${temFormulas ? `
                            <div class="preview-desenho-tempera">
                                <div class="svg-preview-tempera">
                                    ${previewHtml}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="resultado_${produto.id}" class="vidro-info hidden">
                            </div>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // FUN√á√ïES AUXILIARES (ATUALIZADA)
        // =============================================================================
        function obterInfoProduto(produto) {
            if (produto.isAvulso) {
                return {
                    nome: produto.nomeAvulso || 'Item Avulso',
                    temFormulas: false,
                    quantidadeFormulas: 0
                };
            } else {
                // <-- MODIFICADO --> Busca o nome do produto na lista carregada
                const produtoBase = produtosCadastrados.find(p => p.id == produto.produtoId);
                const nomeProduto = produtoBase ? produtoBase.nome : `Produto ID: ${produto.produtoId}`;
                
                const formulas = formulasPorProduto[produto.produtoId] || [];
                return {
                    nome: nomeProduto, // Usa o nome real
                    temFormulas: formulas.length > 0,
                    quantidadeFormulas: formulas.length
                };
            }
        }

        // =============================================================================
        // C√ÅLCULO DE VIDROS (ATUALIZADO com miniatura da imagem)
        // =============================================================================
        function calcularVidroProduto(produtoId) {
            const produto = produtosObra.find(p => p.id === produtoId);
            if (!produto) return;

            const produtoInfo = obterInfoProduto(produto);
            const larguraJanela = parseFloat(document.getElementById(`largura_${produtoId}`).value) || 0;
            const alturaJanela = parseFloat(document.getElementById(`altura_${produtoId}`).value) || 0;
            const quantidade = parseInt(document.getElementById(`quantidade_${produtoId}`).value) || 1;
            const margemAdicional = parseFloat(document.getElementById('margemAdicional').value) || 0;

            if (larguraJanela <= 0 || alturaJanela <= 0) {
                document.getElementById(`resultado_${produtoId}`).innerHTML = `
                    <div class="error">
                        ‚ùå Informe largura e altura v√°lidas
                    </div>
                `;
                return;
            }

            if (!produtoInfo.temFormulas) {
                document.getElementById(`resultado_${produtoId}`).innerHTML = `
                    <div class="error">
                        ‚ùå Este produto n√£o tem f√≥rmulas de vidro cadastradas
                    </div>
                `;
                return;
            }

            const formulas = formulasPorProduto[produto.produtoId] || [];
            
            let resultadosHTML = `<div class="success">‚úÖ ${formulas.length} pe√ßa(s) de vidro calculada(s)</div>`;
            let vidrosProduto = [];

            formulas.forEach((formula, index) => {
                const larguraVidro = calcularFormula(formula.formula_largura, larguraJanela, alturaJanela, margemAdicional);
                const alturaVidro = calcularFormula(formula.formula_altura, larguraJanela, alturaJanela, margemAdicional);
                
                const areaVidro = larguraVidro * alturaVidro;
                const quantidadeTotal = quantidade; // Cada pe√ßa aparece em cada unidade do produto

                // <-- ADICIONADO --> Miniatura da imagem da pe√ßa
                const imgPreview = formula.url_imagem_peca ? 
                    `<img src="${formula.url_imagem_peca}" style="width: 40px; height: 40px; object-fit: contain; border: 1px solid #ccc; background: white; margin-right: 10px; border-radius: 4px;">` : 
                    ''; // Se n√£o tiver imagem, n√£o mostra nada

                resultadosHTML += `
                    <div class="folha-info" style="display: flex; align-items: center;">
                        ${imgPreview}
                        <div>
                            <strong>${formula.nome_peca}</strong>
                            <div style="font-size: 14px; color: #666;">
                                F√≥rmula: ${formula.formula_largura} √ó ${formula.formula_altura}<br>
                                Medidas: ${larguraVidro.toFixed(3)}m √ó ${alturaVidro.toFixed(3)}m<br>
                                √Årea: ${areaVidro.toFixed(3)}m¬≤ ‚Ä¢ Quantidade: ${quantidadeTotal}
                                ${formula.descricao ? `<br><small>${formula.descricao}</small>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                vidrosProduto.push({
                    produtoId: produtoId,
                    produtoNome: produtoInfo.nome,
                    pecaNome: formula.nome_peca,
                    formulaLargura: formula.formula_largura,
                    formulaAltura: formula.formula_altura,
                    descricao: formula.descricao,
                    larguraJanela: larguraJanela,
                    alturaJanela: alturaJanela,
                    larguraVidro: larguraVidro,
                    alturaVidro: alturaVidro,
                    quantidadeProduto: quantidade,
                    quantidadeTotal: quantidadeTotal,
                    areaUnitario: areaVidro,
                    areaTotal: areaVidro * quantidadeTotal,
                    url_imagem_peca: formula.url_imagem_peca // Salva a URL para o PDF/Excel
                });
            });

            // Atualiza interface
            const resultadoDiv = document.getElementById(`resultado_${produtoId}`);
            resultadoDiv.innerHTML = resultadosHTML;
            resultadoDiv.classList.remove('hidden');

            // Atualiza array global
            vidrosCalculados = vidrosCalculados.filter(v => v.produtoId !== produtoId);
            vidrosCalculados.push(...vidrosProduto);

            atualizarResumoVidros();
        }

        // =============================================================================
        // FUN√á√ÉO PARA CALCULAR F√ìRMULAS
        // =============================================================================
        function calcularFormula(formula, L, A, margemAdicional = 0) {
            // Converte f√≥rmula para min√∫sculas e remove espa√ßos
            let expressao = formula.toLowerCase().replace(/\s/g, '');
            
            // Substitui L e A pelos valores reais
            expressao = expressao.replace(/l/g, L.toString());
            expressao = expressao.replace(/a/g, A.toString());
            
            // Adiciona margem adicional se especificada
            if (margemAdicional > 0) {
                // Para f√≥rmulas de subtra√ß√£o, adiciona a margem extra
                if (expressao.includes('-')) {
                    expressao = `(${expressao}) - ${margemAdicional/100}`;
                }
                // Adicione aqui se quiser somar em outros casos
                // else {
                //     expressao = `(${expressao}) + ${margemAdicional/100}`;
                // }
            }
            
            try {
                // Usa Function para maior seguran√ßa que eval
                const resultado = new Function(`return ${expressao}`)();
                return Math.max(0, parseFloat(resultado) || 0); // Garante que n√£o seja negativo
            } catch (error) {
                console.error(`Erro ao calcular f√≥rmula "${formula}":`, error);
                return 0;
            }
        }

        // =============================================================================
        // C√ÅLCULO EM LOTE
        // =============================================================================
        function calcularTodosVidrosObra() {
            const produtos = document.querySelectorAll('[id^="produto_"]');
            let calculados = 0;
            let semFormulas = 0;
            let comErro = 0;
            
            produtos.forEach(produtoCard => {
                const produtoId = produtoCard.id.replace('produto_', '');
                const produto = produtosObra.find(p => p.id === produtoId);
                const produtoInfo = obterInfoProduto(produto);
                const largura = parseFloat(document.getElementById(`largura_${produtoId}`).value) || 0;
                const altura = parseFloat(document.getElementById(`altura_${produtoId}`).value) || 0;
                
                if (largura > 0 && altura > 0) {
                    if (produtoInfo.temFormulas) {
                        calcularVidroProduto(produtoId);
                        calculados++;
                    } else {
                        semFormulas++;
                    }
                } else {
                    comErro++;
                }
            });
            
            let mensagem = '';
            if (calculados > 0) mensagem += `üßÆ ${calculados} produtos calculados!`;
            if (semFormulas > 0) mensagem += ` ${semFormulas} sem f√≥rmulas de vidro.`;
            if (comErro > 0) mensagem += ` ${comErro} com dados incompletos.`;
            
            if (mensagem) {
                alert(mensagem);
            } else {
                alert('‚ùå Preencha as medidas dos produtos primeiro');
            }
        }

        // =============================================================================
        // ATUALIZA√á√ÉO DO RESUMO
        // =============================================================================
        function atualizarResumoVidros() {
            if (vidrosCalculados.length === 0) {
                document.getElementById('resumoVidros').style.display = 'none';
                return;
            }

            document.getElementById('resumoVidros').style.display = 'block';
            
            const tabelaBody = document.getElementById('corpoTabelaVidros');
            
            let html = '';
            let totalVidros = 0;
            let areaTotal = 0;
            const produtosProcessados = new Set();

            vidrosCalculados.forEach(vidro => {
                html += `
                    <tr>
                        <td><strong>${vidro.produtoNome}</strong></td>
                        <td>${vidro.pecaNome}</td>
                        <td><small>${vidro.formulaLargura} √ó ${vidro.formulaAltura}</small></td>
                        <td>${vidro.larguraVidro.toFixed(3)}m √ó ${vidro.alturaVidro.toFixed(3)}m</td>
                        <td>${vidro.quantidadeTotal}</td>
                        <td>${vidro.areaTotal.toFixed(3)}m¬≤</td>
                    </tr>
                `;
                
                totalVidros += vidro.quantidadeTotal;
                areaTotal += vidro.areaTotal;
                produtosProcessados.add(vidro.produtoId);
            });

            tabelaBody.innerHTML = html;
            
            document.getElementById('totalProdutosVidro').textContent = produtosProcessados.size;
            document.getElementById('totalVidros').textContent = totalVidros;
            document.getElementById('areaTotal').textContent = areaTotal.toFixed(3);
            document.getElementById('totalGeralVidros').textContent = `√Årea Total: ${areaTotal.toFixed(3)} m¬≤ (${totalVidros} vidros)`;
        }

        // =============================================================================
        // GERA√á√ÉO DE RELAT√ìRIOS
        // =============================================================================
        function gerarPDFTempera() {
            if (vidrosCalculados.length === 0) {
                alert('‚ùå Calcule os vidros primeiro');
                return;
            }

            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('‚ùå Biblioteca PDF n√£o carregada');
                return;
            }

            const doc = new jsPDF();
            const fornecedor = document.getElementById('fornecedorVidro').value;
            const tipoVidro = document.getElementById('tipoVidro').value;
            const observacoes = document.getElementById('observacoesTempera').value;
            const dataPedido = document.getElementById('dataPedido').value;
            const cliente = document.getElementById('clienteObra').value;
            const localizacao = document.getElementById('localizacaoObra').value;

            // Cabe√ßalho
            doc.setFontSize(18);
            doc.text('PEDIDO DE VIDROS PARA TEMPERA', 20, 30);
            
            doc.setFontSize(11);
            doc.text(`Data: ${dataPedido}`, 20, 45);
            doc.text(`Cliente: ${cliente}`, 20, 55);
            doc.text(`Local: ${localizacao || 'N√£o informado'}`, 20, 65);
            doc.text(`Fornecedor: ${fornecedor}`, 20, 75);
            doc.text(`Tipo de Vidro: ${tipoVidro}`, 20, 85);
            
            let startY = 95;
            if (observacoes) {
                doc.text(`Observa√ß√µes: ${observacoes}`, 20, 95);
                startY = 105;
            }

            // Tabela de vidros
            const tableData = vidrosCalculados.map(vidro => [
                vidro.produtoNome,
                vidro.pecaNome,
                `${vidro.larguraVidro.toFixed(3)}m √ó ${vidro.alturaVidro.toFixed(3)}m`,
                vidro.quantidadeTotal.toString(),
                `${vidro.areaTotal.toFixed(3)}m¬≤`
            ]);

            doc.autoTable({
                startY: startY,
                head: [['Produto', 'Pe√ßa', 'Medidas Vidro', 'Quantidade', '√Årea Total']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80] }
            });

            // Total
            const areaTotal = vidrosCalculados.reduce((sum, v) => sum + v.areaTotal, 0);
            const totalVidros = vidrosCalculados.reduce((sum, v) => sum + v.quantidadeTotal, 0);
            
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.setTextColor(44, 62, 80);
            doc.text(`TOTAL GERAL:`, 20, finalY);
            doc.setTextColor(231, 76, 60);
            doc.text(`${totalVidros} vidros ‚Ä¢ ${areaTotal.toFixed(3)} m¬≤`, 60, finalY);

            doc.save(`Pedido_Tempera_${cliente.replace(/ /g, '_')}_${dataPedido.replace(/\//g, '-')}.pdf`);
        }

        function gerarPlanilha() {
            if (vidrosCalculados.length === 0) {
                alert('‚ùå Calcule os vidros primeiro');
                return;
            }
            
            // Adicionado 'URL Imagem' ao CSV
            let csv = 'Produto,Pe√ßa,F√≥rmula Largura,F√≥rmula Altura,Largura Vidro (m),Altura Vidro (m),Quantidade,√Årea Total (m¬≤),URL Imagem\n';
            
            vidrosCalculados.forEach(vidro => {
                csv += `"${vidro.produtoNome}","${vidro.pecaNome}","${vidro.formulaLargura}","${vidro.formulaAltura}",${vidro.larguraVidro.toFixed(3)},${vidro.alturaVidro.toFixed(3)},${vidro.quantidadeTotal},${vidro.areaTotal.toFixed(3)},"${vidro.url_imagem_peca || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vidros_tempera_${document.getElementById('clienteObra').value.replace(/ /g, '_')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // =============================================================================
        // UTILIT√ÅRIOS
        // =============================================================================
        function limparPedido() {
            if (!confirm('Limpar todo o pedido atual?')) return;
            
            vidrosCalculados = [];
            formulasPorProduto = {};
            document.getElementById('selecionarObra').value = '';
            document.getElementById('clienteObra').value = '';
            document.getElementById('localizacaoObra').value = '';
            document.getElementById('cardProdutosObra').style.display = 'none';
            document.getElementById('resumoVidros').style.display = 'none';
            alert('‚úÖ Pedido limpo!');
        }
    </script>
</body>
</html>
