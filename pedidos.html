<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Pedidos - Oficina da Familia</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.js"></script>
    
    <style>
        /* Estilos das Abas */
        .tabs {
            display: flex;
            background: #f1f1f1;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            border: 1px solid #e1e5e9;
            border-bottom: none;
        }
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f1f1f1;
            color: #333;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }
        .tab:hover {
            background: #e9ecef;
        }
        .tab.active {
            background: white;
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }
        .tab-content {
            display: none;
            padding: 25px;
            background: white;
            border: 1px solid #e1e5e9;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
        .tab-content.active {
            display: block;
        }

        /* Tabela de Pedido */
        .pedido-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .pedido-table th, .pedido-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .pedido-table th {
            background: #f8f9fa;
        }
        .pedido-table input[type="number"] {
            width: 100px;
            padding: 8px;
        }
        .pedido-table input[type="text"] {
            width: 150px;
            padding: 8px;
        }
        .pedido-table .unidade-barra {
            font-weight: bold;
            color: #2c3e50;
        }

        /* Lista de Pedidos Pendentes */
        .pedido-pendente-card {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .pedido-pendente-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }
        .pedido-pendente-card strong {
            font-size: 1.1em;
            color: #2c3e50;
        }
        
        /* Modal de Confer√™ncia */
        .modal-content {
             width: 90%;
             max-width: 900px; /* Maior para caber a tabela */
        }

        /* Tabela de Contabilidade */
        .contabilidade-table {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            border: 1px solid #ccc;
        }
        .contabilidade-table th, .contabilidade-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .contabilidade-table th {
            background-color: #f2f2f2;
            text-align: left;
        }
        .contabilidade-total {
            font-size: 1.2em;
            font-weight: bold;
            color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h1>üöö Gest√£o de Pedidos - Oficina da Familia</h1>
                <div style="display: flex; gap: 10px;">
                    <a href="index.html" class="btn btn-secondary">üè† In√≠cio</a>
                    <a href="estoque.html" class="btn btn-primary">üì¶ Estoque</a>
                    <a href="orcamento.html" class="btn btn-success">üìã Or√ßamentos</a>
                    <a href="relatorios_estoque.html" class="btn btn-info">üìä Relat√≥rios</a> 
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="openTab('novoPedido', event)">1. Fazer Novo Pedido</button>
            <button class="tab" onclick="openTab('pedidosPendentes', event)">2. Receber Pedidos Pendentes</button>
            <button class="tab" onclick="openTab('ajusteManual', event)">3. Ajuste Manual</button>
            <button class="tab" onclick="openTab('valorTotalEstoque', event)">4. Valor Total do Estoque</button>
        </div>

        <div id="novoPedido" class="tab-content active">
            <h2>üõí Novo Pedido de Compra</h2>
            <form id="formNovoPedido" onsubmit="salvarPedidoPendente(event)">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="fornecedor">Fornecedor</label>
                        <input type="text" id="fornecedor" placeholder="Nome do fornecedor">
                    </div>
                    <div class="form-group">
                        <label for="notaFiscal">N¬∫ Nota Fiscal (Opcional)</label>
                        <input type="text" id="notaFiscal" placeholder="123456">
                    </div>
                </div>

                <hr style="margin: 20px 0;">
                
                <h4>üîç Filtrar Itens para o Pedido</h4>
                <div class="grid grid-4">
                    <div class="form-group">
                        <label for="filtroCategoriaPedido">Categoria</label>
                        <select id="filtroCategoriaPedido" onchange="renderListaParaPedido()">
                            <option value="todos">Todas as Categorias</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroStatusEstoque">Status do Estoque</label>
                        <select id="filtroStatusEstoque" onchange="renderListaParaPedido()">
                            <option value="todos">Todos</option>
                            <option value="critico">Cr√≠tico (Baixo ou Negativo)</option>
                            <option value="baixo">Abaixo do M√≠nimo</option>
                            <option value="negativo">Negativo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroNivelMinimo">N√≠vel M√≠nimo</label>
                        <input type="number" id="filtroNivelMinimo" value="5" min="0" onchange="renderListaParaPedido()">
                    </div>
                    <div class="form-group">
                        <label for="filtroItensPedido">Pesquisa (Nome/SKU)</label>
                        <input type="text" id="filtroItensPedido" placeholder="üîç Pesquisar..." onkeyup="renderListaParaPedido()">
                    </div>
                </div>

                <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px;">
                    <table class="pedido-table">
                        <thead>
                            <tr>
                                <th>Item (Varia√ß√£o)</th>
                                <th>Cor</th>
                                <th>Estoque Atual</th>
                                <th>Unid. Pedido</th>
                                <th style="width: 120px;">Qtd. a Pedir</th>
                            </tr>
                        </thead>
                        <tbody id="listaItensPedido">
                            <tr class="loading"><td colspan="5">Carregando itens...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="acoes" style="margin-top: 25px; justify-content: space-between;">
                    <button type="button" class="btn btn-info" id="btnGerarPDFPedido" onclick="gerarPDFPedido()">
                        üìÑ Gerar PDF do Pedido
                    </button>
                    <button type="submit" class="btn btn-success">
                        üíæ Salvar Pedido como Pendente
                    </button>
                </div>
            </form>
        </div>

        <div id="pedidosPendentes" class="tab-content">
            <h2>üì• Pedidos Pendentes de Recebimento</h2>
            <div id="listaPedidosPendentes">
                <div class="loading">Carregando pedidos pendentes...</div>
            </div>
        </div>

        <div id="ajusteManual" class="tab-content">
            <h2>üîß Ajuste Manual de Estoque / Custo</h2>
            <p class="text-muted">Use esta ferramenta para corre√ß√µes r√°pidas, perdas ou para atualizar valores fora de um pedido. (Ajustes s√£o sempre na unidade base, ex: metros).</p>
            
            <form id="formAjusteManual" onsubmit="aplicarAjusteManual(event)">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="selectAjusteItem">Item (Varia√ß√£o)</label>
                        <select id="selectAjusteItem" required>
                            <option value="">Carregando itens...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ajusteQuantidade">Qtd. a Adicionar/Remover (ex: metros)</label>
                        <input type="number" step="0.01" id="ajusteQuantidade" value="0" required>
                        <small class="text-muted">Use valores positivos para adicionar (ex: 10) e negativos para remover (ex: -2).</small>
                    </div>
                </div>
                
                <hr style="margin: 15px 0;">
                <h4>Atualiza√ß√£o de Valores (Opcional)</h4>
                
                <div class="form-group">
                    <label for="ajustePrecoVenda">Novo Custo/Venda da Varia√ß√£o (por unidade base, ex: R$/metro)</label>
                    <input type="number" step="0.01" id="ajustePrecoVenda" placeholder="Deixe em branco para n√£o alterar">
                </div>

                <div class="form-group">
                    <label for="ajusteMotivo">Motivo do Ajuste *</label>
                    <textarea id="ajusteMotivo" rows="2" placeholder="Ex: Contagem de balan√ßo, perda de material, doa√ß√£o..." required></textarea>
                </div>

                <div class="acoes" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-warning">üî© Aplicar Ajuste</button>
                </div>
            </form>
        </div>
        
        <div id="valorTotalEstoque" class="tab-content">
            <h2>üí∞ Valor Total do Estoque (Contabilidade)</h2>
            <p class="text-muted">Calcula o valor total do invent√°rio com base no "Pre√ßo de Venda" (seu custo) cadastrado na "Varia√ß√£o do Item". Itens com custo zero ou estoque negativo n√£o s√£o somados.</p>
            
            <div class="acoes" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="calcularValorTotalEstoque()">
                    üîÑ Calcular Valor Total
                </button>
            </div>
            
            <div id="resultadoValorTotal" class="card" style="margin-top: 20px; display: none;">
                <h3>Resultado do C√°lculo</h3>
                <h2 id="valorTotalDisplay" class="text-success" style="font-size: 2.5em; margin-bottom: 20px;">R$ 0,00</h2>
                
                <h4>Valor por Categoria</h4>
                <table class="contabilidade-table">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Valor em Estoque (Custo)</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaValorPorCategoria">
                        </tbody>
                </table>
            </div>
        </div>
        
    </div>


    <div class="modal" id="modalConferencia">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTituloConferencia">Confer√™ncia de Pedido</h3>
                <button class="btn btn-danger btn-small" onclick="fecharModalConferencia()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="infoPedidoConferencia" class="info" style="margin-bottom: 20px;"></div>
                
                <form id="formConferencia" onsubmit="confirmarEntradaEstoque(event)">
                    <input type="hidden" id="conferenciaPedidoId">
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="pedido-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Qtd. Pedida</th>
                                    <th>Qtd. Recebida*</th>
                                    <th>Novo Custo/Venda (por unidade base)*</th>
                                </tr>
                            </thead>
                            <tbody id="listaItensConferencia">
                                </tbody>
                        </table>
                    </div>
                    
                    <div class="acoes" style="margin-top: 25px;">
                        <button type="button" class="btn btn-secondary" onclick="fecharModalConferencia()">Cancelar</button>
                        <button type="submit" class="btn btn-success">‚úÖ Confirmar Entrada e Atualizar Estoque</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script src="config.js"></script>
    <script>
        // =============================================================================
        // VARI√ÅVEIS GLOBAIS
        // =============================================================================
        let todosItensVariacao = []; // Armazena todas as varia√ß√µes (para Novo Pedido e Ajuste)
        let pedidosPendentesCache = []; // Armazena os pedidos pendentes carregados
        let categoriasCache = []; // Armazena as categorias

        // Lista de categorias a excluir (baseado no seu relatorios_estoque.html)
        const CATEGORIAS_EXCLUIDAS_NOME = ['Vidro', 'M√£o de Obra', 'Servi√ßo'];

        // *** NOVO: Constantes para Perfis ***
        // ! IMPORTANTE: Verifique o nome exato da sua categoria de perfis no Supabase!
        const CATEGORIA_PERFIS_NOME = 'perfil'; // Ex: "Perfis", "Alum√≠nio", "Perfis de Alum√≠nio"
        const COMPRIMENTO_BARRA = 6; // Comprimento padr√£o da barra em metros


        // =============================================================================
        // INICIALIZA√á√ÉO E ABAS
        // =============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof supabase === 'undefined') {
                alert("Erro fatal: Supabase (config.js) n√£o foi carregado.");
                return;
            }
            
            // CORRE√á√ÉO: Verifica a disponibilidade do PDF AP√ìS o DOM
            const btnPDF = document.getElementById('btnGerarPDFPedido');
            if (btnPDF) {
                // Tenta acessar jspdf.plugin.autotable
                if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.prototype.autoTable === 'undefined') {
                    console.warn("Bibliotecas jsPDF ou jsPDF-AutoTable n√£o carregadas ou instaladas incorretamente. PDF desabilitado.");
                    btnPDF.style.opacity = '0.5';
                    btnPDF.disabled = true;
                    btnPDF.textContent = 'Erro no PDF';
                }
            }
            
            carregarDadosIniciais();
        });

        async function carregarDadosIniciais() {
            try {
                // Carrega em paralelo
                const [itens, pedidos, categorias] = await Promise.all([
                    estoqueFunctions.carregarItens(), // Carrega todas as varia√ß√µes
                    carregarPedidosPendentesDB(),     // Carrega pedidos pendentes
                    estoqueFunctions.carregarCategorias() // Carrega categorias para filtros
                ]);

                categoriasCache = categorias;
                pedidosPendentesCache = pedidos;

                // Filtra os itens ANTES de popular as listas
                todosItensVariacao = itens.filter(item => {
                    if (!item.categorias || !item.categorias.nome) {
                        return true; 
                    }
                    return !CATEGORIAS_EXCLUIDAS_NOME.includes(item.categorias.nome);
                });

                popularFiltrosPedido();
                renderListaParaPedido();
                renderSelectAjuste();
                renderPedidosPendentes();

            } catch (error) {
                console.error("Erro ao carregar dados iniciais:", error);
                alert("Erro ao carregar dados: " + error.message);
            }
        }
        
        function popularFiltrosPedido() {
            const selectCategoria = document.getElementById('filtroCategoriaPedido');
            let html = '<option value="todos">Todas as Categorias</option>';
            
            const categoriasFiltradas = categoriasCache.filter(c => {
                return !CATEGORIAS_EXCLUIDAS_NOME.includes(c.nome);
            });

            html += categoriasFiltradas.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            selectCategoria.innerHTML = html;
        }

        function openTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // =============================================================================
        // ABA 1: NOVO PEDIDO (COM FILTROS E L√ìGICA DE BARRA)
        // =============================================================================
        
        function renderListaParaPedido() {
            const tbody = document.getElementById('listaItensPedido');
            
            const filtroTexto = document.getElementById('filtroItensPedido').value.toLowerCase();
            const filtroCategoria = document.getElementById('filtroCategoriaPedido').value;
            const filtroStatus = document.getElementById('filtroStatusEstoque').value;
            const nivelMinimo = parseFloat(document.getElementById('filtroNivelMinimo').value) || 0;
            
            let html = '';
            
            const itensFiltrados = todosItensVariacao.filter(item => {
                const matchTexto = item.nome.toLowerCase().includes(filtroTexto) || 
                                   (item.sku && item.sku.toLowerCase().includes(filtroTexto));
                if (!matchTexto) return false;

                const matchCategoria = (filtroCategoria === 'todos' || String(item.categoria_id) === filtroCategoria);
                if (!matchCategoria) return false;
                
                if (filtroStatus !== 'todos') {
                    const isNegativo = item.quantidade_estoque < 0;
                    const isBaixo = item.quantidade_estoque >= 0 && item.quantidade_estoque < nivelMinimo;

                    if (filtroStatus === 'negativo' && !isNegativo) return false;
                    if (filtroStatus === 'baixo' && !isBaixo) return false;
                    if (filtroStatus === 'critico' && !(isNegativo || isBaixo)) return false;
                }
                
                return true; 
            });

            if (itensFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">Nenhum item encontrado com esses filtros.</td></tr>';
                return;
            }

            itensFiltrados.forEach(item => {
                let classeLinha = '';
                if (item.quantidade_estoque < 0) {
                    classeLinha = 'estoque-negativo'; 
                } else if (item.quantidade_estoque < nivelMinimo) {
                    classeLinha = 'estoque-baixo'; 
                }

                // *** IN√çCIO DA L√ìGICA DE BARRA ***
                const isBarra = (item.categorias.nome === CATEGORIA_PERFIS_NOME);
                let unidadeMedidaDisplay, inputStep, inputPlaceholder, isBarraData, unidadeData;

                if (isBarra) {
                    unidadeMedidaDisplay = `<span class="unidade-barra">Barra (${COMPRIMENTO_BARRA}m)</span>`;
                    inputStep = 1; // S√≥ pode pedir em barras inteiras
                    inputPlaceholder = "0";
                    isBarraData = "true";
                    unidadeData = "Barra(s)"; // Unidade para o PDF
                } else {
                    unidadeMedidaDisplay = item.unidade_medida;
                    inputStep = 0.01; // Padr√£o para outros itens (ex: kg, un)
                    inputPlaceholder = "0.00";
                    isBarraData = "false";
                    unidadeData = item.unidade_medida;
                }
                // *** FIM DA L√ìGICA DE BARRA ***
                
                html += `
                    <tr data-variacao-id="${item.id}" class="${classeLinha}">
                        <td><strong>${item.nome_base}</strong></td>
                        <td>${item.cor}</td>
                        <td>${item.quantidade_estoque.toFixed(2)} ${item.unidade_medida}</td>
                        <td>${unidadeMedidaDisplay}</td>
                        <td>
                            <input type="number" step="${inputStep}" min="0" class="input-qtd-pedir" placeholder="${inputPlaceholder}" 
                                   data-sku="${item.sku || 'N/A'}" 
                                   data-nome="${item.nome_base}" 
                                   data-cor="${item.cor}" 
                                   data-unidade="${unidadeData}"
                                   data-is-barra="${isBarraData}">
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        async function salvarPedidoPendente(event) {
            event.preventDefault();
            const fornecedor = document.getElementById('fornecedor').value || 'N√£o informado';
            const notaFiscal = document.getElementById('notaFiscal').value || null;

            const itensDoPedido = [];
            const inputs = document.querySelectorAll('.input-qtd-pedir');

            inputs.forEach(input => {
                const quantidade = parseFloat(input.value);
                if (quantidade > 0) {
                    
                    // *** L√ìGICA DE BARRA: Converte barras em metros ANTES de salvar ***
                    const isBarra = input.dataset.isBarra === 'true';
                    let qtdParaSalvar = quantidade;

                    if (isBarra) {
                        qtdParaSalvar = quantidade * COMPRIMENTO_BARRA;
                    }
                    // *** FIM DA L√ìGICA ***

                    itensDoPedido.push({
                        variacao_id: input.closest('tr').dataset.variacaoId,
                        quantidade_pedida: qtdParaSalvar // Salva a quantidade em metros
                    });
                }
            });

            if (itensDoPedido.length === 0) {
                alert('‚ùå Adicione pelo menos um item com quantidade maior que zero.');
                return;
            }

            try {
                // A RPC 'salvar_pedido_pendente' j√° espera a quantidade em metros (ou unidade base)
                const { data, error } = await supabase.rpc('salvar_pedido_pendente', {
                    p_fornecedor: fornecedor,
                    p_nota_fiscal: notaFiscal,
                    p_itens: itensDoPedido
                });

                if (error) throw error;

                alert('‚úÖ Pedido salvo como pendente!');
                document.getElementById('formNovoPedido').reset();
                renderListaParaPedido(); // Limpa os inputs da tabela
                
                pedidosPendentesCache = await carregarPedidosPendentesDB();
                renderPedidosPendentes();
                
                openTab('pedidosPendentes', { currentTarget: document.querySelector('.tab[onclick*="pedidosPendentes"]') });

            } catch (error) {
                console.error('Erro ao salvar pedido:', error);
                alert('‚ùå Erro ao salvar pedido: ' + error.message);
            }
        }
        
        function gerarPDFPedido() {
            // Verifica se as bibliotecas est√£o carregadas (segunda checagem)
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.prototype.autoTable === 'undefined') {
                alert("Erro: Bibliotecas de PDF n√£o carregadas corretamente."); return;
            }
            
            const fornecedor = document.getElementById('fornecedor').value || '_________________________';
            const notaFiscal = document.getElementById('notaFiscal').value;

            const itensParaPDF = [];
            const inputs = document.querySelectorAll('.input-qtd-pedir');

            inputs.forEach(input => {
                const quantidade = parseFloat(input.value);
                if (quantidade > 0) {
                    // *** L√ìGICA DE BARRA: Usa a unidade correta (Barra ou un/m/kg) ***
                    const unidade = input.dataset.unidade; // Pega "Barra(s)" ou "un" etc.
                    
                    itensParaPDF.push([
                        input.dataset.sku,
                        input.dataset.nome,
                        input.dataset.cor,
                        unidade, // Unidade correta (Barra ou m/un/kg)
                        quantidade.toFixed(2) // Quantidade correta (N¬∫ de Barras ou N_de un/m/kg)
                    ]);
                }
            });

            if (itensParaPDF.length === 0) {
                alert('‚ùå Adicione itens ao pedido antes de gerar o PDF.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            gerarPDFBase(doc, fornecedor, notaFiscal, itensParaPDF);
            
            // Salvar
            doc.save(`Pedido_Novo_OficinaFamilia_${fornecedor.replace(/ /g, '_')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
        }

        // =============================================================================
        // ABA 2: PEDIDOS PENDENTES E CONFER√äNCIA (COM L√ìGICA DE BARRA)
        // =============================================================================
        
        async function carregarPedidosPendentesDB() {
            try {
                // Chama a fun√ß√£o RPC (que agora inclui 'categoria_nome')
                const { data, error } = await supabase.rpc('carregar_pedidos_pendentes');
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao carregar pedidos pendentes:', error);
                document.getElementById('listaPedidosPendentes').innerHTML = '<div class="error">Erro ao carregar pedidos.</div>';
                return [];
            }
        }

        function renderPedidosPendentes() {
            const container = document.getElementById('listaPedidosPendentes');
            if (pedidosPendentesCache.length === 0) {
                container.innerHTML = '<div class="muted">Nenhum pedido pendente.</div>';
                return;
            }

            container.innerHTML = pedidosPendentesCache.map(pedido => {
                const dataPedido = new Date(pedido.data_criacao).toLocaleDateString('pt-BR');
                // totalItens agora √© apenas um contador de tipos de item, n√£o de soma
                const totalTiposItens = pedido.itens.length; 
                
                return `
                <div class="pedido-pendente-card">
                    <div onclick="abrirModalConferencia(${pedido.id})" style="flex-grow: 1; cursor: pointer;">
                        <strong>Fornecedor: ${pedido.fornecedor}</strong>
                        <div class="text-muted">
                            Pedido #${pedido.id} ‚Ä¢ Data: ${dataPedido} ‚Ä¢ ${totalTiposItens} tipo(s) de item
                        </div>
                        <div class="text-muted">
                            NF: ${pedido.nota_fiscal || 'N/A'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-info" onclick="event.stopPropagation(); gerarPDFDePedidoPendente(${pedido.id})">
                            üìÑ PDF
                        </button>
                        <button class="btn btn-success" onclick="event.stopPropagation(); abrirModalConferencia(${pedido.id})">
                            Receber üì¶
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        /**
         * Gera um PDF para um pedido j√° existente no cache.
         * @param {number} pedidoId 
         */
        function gerarPDFDePedidoPendente(pedidoId) {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.prototype.autoTable === 'undefined') {
                alert("Erro: Bibliotecas de PDF n√£o carregadas corretamente."); return;
            }
            
            const pedido = pedidosPendentesCache.find(p => p.id === pedidoId);
            if (!pedido) {
                alert('Erro: Pedido n√£o encontrado para gerar PDF.');
                return;
            }

            const itensParaPDF = [];
            
            pedido.itens.forEach(item => {
                // *** L√ìGICA DE BARRA: Converte metros para Barras se for Perfil ***
                const isBarra = (item.categoria_nome === CATEGORIA_PERFIS_NOME);
                let quantidadeDisplay;
                let unidadeDisplay;
                
                if (isBarra) {
                    quantidadeDisplay = (item.quantidade_pedida / COMPRIMENTO_BARRA).toFixed(2);
                    unidadeDisplay = "Barra(s)";
                } else {
                    quantidadeDisplay = item.quantidade_pedida.toFixed(2);
                    unidadeDisplay = item.unidade_medida;
                }
                
                itensParaPDF.push([
                    item.sku || 'N/A',
                    item.nome_base,
                    item.cor,
                    unidadeDisplay, 
                    quantidadeDisplay 
                ]);
            });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            gerarPDFBase(doc, pedido.fornecedor, pedido.nota_fiscal, itensParaPDF, pedido.id);

            doc.save(`Pedido_${pedido.id}_OficinaFamilia_${pedido.fornecedor.replace(/ /g, '_')}_${new Date(pedido.data_criacao).toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
        }
        
        /**
         * Fun√ß√£o centralizada para gerar o conte√∫do do PDF, usada por "Novo Pedido" e "Pedido Pendente".
         * @param {jsPDF} doc - Inst√¢ncia do jsPDF
         * @param {string} fornecedor - Nome do fornecedor
         * @param {string | null} notaFiscal - N√∫mero da Nota Fiscal
         * @param {Array<Array<string>>} itensParaPDF - Dados da tabela (SKU, Item, Cor, Unid., Qtd.)
         * @param {number | null} pedidoId - ID do Pedido (opcional)
         */
        function gerarPDFBase(doc, fornecedor, notaFiscal, itensParaPDF, pedidoId = null) {
            const dataAtual = new Date().toLocaleDateString('pt-BR');

            // 1. Cabe√ßalho da Empresa
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Oficina da Familia", 15, 20);
            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            doc.text("PEDIDO DE COMPRA", 15, 28);
            
            doc.setFontSize(10);
            doc.text(`Data: ${dataAtual}`, 140, 20);
            if(notaFiscal) {
                doc.text(`NF: ${notaFiscal}`, 140, 26);
            }
            if(pedidoId) {
                doc.text(`Pedido ID: #${pedidoId}`, 140, 32);
            }

            // 2. Dados do Fornecedor (Placeholder)
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("PARA:", 15, 45);
            doc.setFont(undefined, 'normal');
            let startY = 51;
            doc.text(`Fornecedor: ${fornecedor}`, 15, startY); startY += 6;
            doc.text("CNPJ: _________________________", 15, startY); startY += 6;
            doc.text("Endere√ßo: _______________________", 15, startY); startY += 6;
            doc.text("Contato: ________________________", 15, startY); startY += 6;
            
            // 3. Tabela de Itens
            doc.autoTable({
                startY: startY + 5,
                head: [['SKU', 'Item', 'Cor', 'Unid.', 'Qtd. Pedida']],
                body: itensParaPDF,
                theme: 'striped',
                headStyles: { fillColor: [44, 62, 80] } // Cor #2c3e50
            });
            
            // 4. Rodap√©
            const finalY = doc.lastAutoTable.finalY + 15;
            doc.setFontSize(10);
            doc.text("Observa√ß√µes:", 15, finalY);
            doc.text("____________________________________________________________________", 15, finalY + 6);
            doc.text("____________________________________________________________________", 15, finalY + 12);
        }
        
        function fecharModalConferencia() {
            document.getElementById('modalConferencia').style.display = 'none';
        }

        function abrirModalConferencia(pedidoId) {
            const pedido = pedidosPendentesCache.find(p => p.id === pedidoId);
            if (!pedido) {
                alert('Erro: Pedido n√£o encontrado no cache.');
                return;
            }
            
            document.getElementById('conferenciaPedidoId').value = pedidoId;
            document.getElementById('modalTituloConferencia').textContent = `Confer√™ncia Pedido #${pedidoId} (${pedido.fornecedor})`;
            document.getElementById('infoPedidoConferencia').innerHTML = `
                <strong>Fornecedor:</strong> ${pedido.fornecedor} <br>
                <strong>Nota Fiscal:</strong> ${pedido.nota_fiscal || 'N/A'} <br>
                <strong>Data do Pedido:</strong> ${new Date(pedido.data_criacao).toLocaleString('pt-BR')}
            `;

            const tbody = document.getElementById('listaItensConferencia');
            tbody.innerHTML = ''; // Limpa a tabela

            pedido.itens.forEach(item => {
                // item.* v√™m do JOIN na RPC (incluindo item.categoria_nome)
                const tr = document.createElement('tr');
                tr.dataset.variacaoId = item.variacao_id;

                // *** IN√çCIO DA L√ìGICA DE BARRA (RECEBIMENTO) ***
                const isBarra = (item.categoria_nome === CATEGORIA_PERFIS_NOME);
                let qtdPedidaDisplay, inputQtdRecebida, inputStep;

                if (isBarra) {
                    const qtdEmBarras = item.quantidade_pedida / COMPRIMENTO_BARRA;
                    qtdPedidaDisplay = `<span class="unidade-barra">${qtdEmBarras.toFixed(2)} Barra(s)</span> (${item.quantidade_pedida.toFixed(2)} m)`;
                    inputQtdRecebida = qtdEmBarras.toFixed(2);
                    inputStep = 1; // Recebe em barras
                    tr.dataset.isBarra = "true";
                } else {
                    qtdPedidaDisplay = `${item.quantidade_pedida.toFixed(2)} ${item.unidade_medida}`;
                    inputQtdRecebida = item.quantidade_pedida.toFixed(2);
                    inputStep = 0.01;
                    tr.dataset.isBarra = "false";
                }
                // *** FIM DA L√ìGICA ***
                
                tr.innerHTML = `
                    <td>
                        <strong>${item.nome_base}</strong><br>
                        <small class="text-muted">${item.cor} (SKU: ${item.sku || 'N/A'})</small>
                    </td>
                    <td>${qtdPedidaDisplay}</td>
                    <td>
                        <input type="number" step="${inputStep}" class="input-qtd-recebida" 
                               value="${inputQtdRecebida}" required>
                    </td>
                    <td>
                        <input type="number" step="0.01" class="input-nova-venda" 
                               placeholder="${(item.preco_venda || 0.00).toFixed(2)}">
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('modalConferencia').style.display = 'flex';
        }

        async function confirmarEntradaEstoque(event) {
            event.preventDefault();
            if (!confirm('Confirmar o recebimento e atualizar o estoque? Esta a√ß√£o n√£o pode ser desfeita facilmente.')) return;

            const pedidoId = document.getElementById('conferenciaPedidoId').value;
            const linhas = document.getElementById('listaItensConferencia').rows;
            const promises = [];
            
            try {
                // 1. Atualizar Estoque e Pre√ßos
                for (const linha of linhas) {
                    const variacaoId = linha.dataset.variacaoId;
                    const novaVenda = parseFloat(linha.querySelector('.input-nova-venda').value);

                    // *** L√ìGICA DE BARRA: Converte barras recebidas em metros ANTES de salvar ***
                    const isBarra = linha.dataset.isBarra === 'true';
                    let qtdRecebida = parseFloat(linha.querySelector('.input-qtd-recebida').value);

                    if (isBarra) {
                        qtdRecebida = qtdRecebida * COMPRIMENTO_BARRA;
                    }
                    // *** FIM DA L√ìGICA ***

                    // 1a. Atualizar Estoque (em metros)
                    if (qtdRecebida > 0) {
                        promises.push(
                            supabase.rpc('atualizar_variacao_estoque', {
                                variacao_id_in: variacaoId,
                                quantidade_in: qtdRecebida,
                                operacao_in: 'adicionar'
                            })
                        );
                    }

                    // 1b. Atualizar Pre√ßo de Venda (Seu Custo) (por metro)
                    if (novaVenda > 0) {
                         promises.push(
                            supabase.from('item_variacoes')
                                .update({ preco_venda: novaVenda })
                                .eq('id', variacaoId)
                        );
                    }
                }

                // 2. Marcar Pedido como Conclu√≠do
                promises.push(
                    supabase.rpc('marcar_pedido_concluido', { p_pedido_id: pedidoId })
                );

                const results = await Promise.all(promises);
                
                const errors = results.filter(res => res.error);
                if (errors.length > 0) {
                    throw new Error('Houve erros ao atualizar: ' + errors.map(e => e.error.message).join(', '));
                }

                alert('‚úÖ Pedido recebido e estoque atualizado com sucesso!');
                fecharModalConferencia();
                
                // Recarrega tudo
                await carregarDadosIniciais();

            } catch (error) {
                console.error('Erro ao confirmar entrada:', error);
                alert('‚ùå Erro ao confirmar entrada: ' + error.message);
            }
        }
        
        // =============================================================================
        // ABA 3: AJUSTE MANUAL (Ajuste √© sempre na unidade base: metros)
        // =============================================================================

        // FUN√á√ÉO MODIFICADA PARA ORDENAR E AGRUPAR POR CATEGORIA
        function renderSelectAjuste() {
            const select = document.getElementById('selectAjusteItem');
            
            if (todosItensVariacao.length === 0) {
                select.innerHTML = '<option value="">Nenhum item de estoque (sem vidros) encontrado.</option>';
                return;
            }

            // 1. Ordenar itens por Nome da Categoria, e secundariamente por Nome do Item (a varia√ß√£o)
            todosItensVariacao.sort((a, b) => {
                const catA = a.categorias?.nome || '';
                const catB = b.categorias?.nome || '';
                if (catA < catB) return -1;
                if (catA > catB) return 1;
                // Crit√©rio secund√°rio: nome da varia√ß√£o
                if (a.nome < b.nome) return -1;
                if (a.nome > b.nome) return 1;
                return 0;
            });

            // 2. Agrupar e renderizar com <optgroup>
            select.innerHTML = '<option value="">Selecione um item...</option>';
            let currentCategory = '';
            let html = '';

            todosItensVariacao.forEach(item => {
                const categoryName = item.categorias?.nome || 'Sem Categoria';
                
                // Iniciar novo optgroup se a categoria mudar
                if (categoryName !== currentCategory) {
                    if (currentCategory !== '') {
                        html += '</optgroup>';
                    }
                    html += `<optgroup label="${categoryName}">`;
                    currentCategory = categoryName;
                }

                html += `
                    <option value="${item.id}">
                        ${item.nome} (Estoque: ${item.quantidade_estoque.toFixed(2)} ${item.unidade_medida})
                    </option>
                `;
            });

            // Fechar o √∫ltimo optgroup
            if (currentCategory !== '') {
                html += '</optgroup>';
            }

            select.innerHTML += html;
        }
        
        async function aplicarAjusteManual(event) {
            event.preventDefault();
            
            const select = document.getElementById('selectAjusteItem');
            const variacaoId = select.value;
            if (!variacaoId) {
                alert('‚ùå Selecione um item.');
                return;
            }
            
            // Quantidade em unidade base (metros, un, kg)
            const quantidade = parseFloat(document.getElementById('ajusteQuantidade').value);
            const motivo = document.getElementById('ajusteMotivo').value;

            if (quantidade === 0) {
                alert('‚ùå A quantidade n√£o pode ser zero.');
                return;
            }
            
            if (!motivo.trim()) {
                alert('‚ùå O motivo √© obrigat√≥rio.');
                return;
            }

            if (!confirm(`Confirma o ajuste de ${quantidade} unidades para o item "${select.options[select.selectedIndex].text}"?`)) {
                return;
            }

            // Pre√ßo por unidade base (R$/metro, R$/un)
            const novaVenda = parseFloat(document.getElementById('ajustePrecoVenda').value);

            try {
                const promises = [];
                
                // 1. Ajuste de Estoque (na unidade base)
                const operacao = (quantidade > 0) ? 'adicionar' : 'subtrair';
                const qtdAbsoluta = Math.abs(quantidade);
                
                promises.push(
                    supabase.rpc('atualizar_variacao_estoque', {
                        variacao_id_in: variacaoId,
                        quantidade_in: qtdAbsoluta,
                        operacao_in: operacao
                    })
                );
                
                // 2. Ajuste de Pre√ßo de Custo/Venda (Varia√ß√£o)
                if (novaVenda > 0) {
                     promises.push(
                        supabase.from('item_variacoes')
                            .update({ preco_venda: novaVenda })
                            .eq('id', variacaoId)
                    );
                }
                
                const results = await Promise.all(promises);
                const errors = results.filter(res => res.error);

                if (errors.length > 0) {
                    throw new Error('Houve erros ao aplicar o ajuste: ' + errors.map(e => e.error.message).join(', '));
                }

                alert('‚úÖ Ajuste manual aplicado com sucesso!');
                document.getElementById('formAjusteManual').reset();
                
                // Recarrega os dados
                await carregarDadosIniciais();

            } catch (error) {
                console.error('Erro no ajuste manual:', error);
                alert('‚ùå Erro no ajuste manual: ' + error.message);
            }
        }
        
        // =============================================================================
        // ABA 4: VALOR TOTAL DO ESTOQUE (C√°lculo √© sempre na unidade base: metros)
        // =============================================================================
        
async function calcularValorTotalEstoque() {
    const resultadoDiv = document.getElementById('resultadoValorTotal');
    const tbody = document.getElementById('tabelaValorPorCategoria');
    const btn = document.querySelector('#valorTotalEstoque .btn-primary');
    
    btn.disabled = true;
    btn.textContent = 'üîÑ Carregando dados recentes...';
    tbody.innerHTML = '';
    resultadoDiv.style.display = 'none';

    try {
        let itensRecentes = await estoqueFunctions.carregarItens();

        // Filtro inicial (exclui Vidros, etc.)
        todosItensVariacao = itensRecentes.filter(item => {
            if (!item.categorias || !item.categorias.nome) {
                return true; 
            }
            return !CATEGORIAS_EXCLUIDAS_NOME.includes(item.categorias.nome);
        });

        btn.textContent = '‚è≥ Calculando...';
        
        let valorTotalGeral = 0;
        const valorPorCategoria = new Map();

        if (todosItensVariacao.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-muted text-center">Nenhum item de estoque (sem vidros) encontrado.</td></tr>';
            document.getElementById('valorTotalDisplay').textContent = 'R$ 0,00';
            resultadoDiv.style.display = 'block';
            return; 
        }

        todosItensVariacao.forEach(itemVar => {
            
            // --- IN√çCIO DA CORRE√á√ÉO FINAL ---
            // 1. Verifica se a categoria existe E se o nome n√£o √© o default 'S/ categoria'
            if (!itemVar.categorias || !itemVar.categorias.nome || itemVar.categorias.nome === 'S/ categoria') {
                console.log('Ignorando item sem categoria:', itemVar.nome); // Log para depura√ß√£o
                return; // Pula este item completamente
            }
            // --- FIM DA CORRE√á√ÉO FINAL ---

            // 2. Ignora itens com estoque zero ou negativo
            if (itemVar.quantidade_estoque <= 0) {
                return;
            }
            
            // 3. Pega o pre√ßo de custo (que √© o preco_venda) DIRETO DA VARIA√á√ÉO
            const precoCusto = (itemVar.preco_venda) ? parseFloat(itemVar.preco_venda) : 0;

            // 4. Ignora itens sem pre√ßo de custo
            if (precoCusto <= 0) {
                return;
            }

            const valorItem = itemVar.quantidade_estoque * precoCusto;
            valorTotalGeral += valorItem;
            
            // Agora 'catNome' NUNCA ser√° 'S/ categoria'
            const catNome = itemVar.categorias.nome; 
            valorPorCategoria.set(catNome, (valorPorCategoria.get(catNome) || 0) + valorItem);
        });
        
        // Renderiza o total geral
        document.getElementById('valorTotalDisplay').textContent = `R$ ${valorTotalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        // Renderiza a tabela por categoria
        const categoriasOrdenadas = [...valorPorCategoria.keys()].sort();
        
        if (categoriasOrdenadas.length === 0 && valorTotalGeral === 0) { // Verifica se realmente n√£o h√° nada a mostrar
             tbody.innerHTML = '<tr><td colspan="2" class="text-muted text-center">Nenhum item com categoria, estoque e custo v√°lidos encontrado.</td></tr>';
        } else if (categoriasOrdenadas.length === 0 && valorTotalGeral > 0) {
             tbody.innerHTML = '<tr><td colspan="2" class="text-warning text-center">Erro: Valor total calculado, mas nenhuma categoria encontrada para agrupar. Verifique os dados.</td></tr>';
        } else {
            categoriasOrdenadas.forEach(catNome => {
                const valor = valorPorCategoria.get(catNome);
                tbody.innerHTML += `
                    <tr>
                        <td>${catNome}</td>
                        <td class="text-right">R$ ${valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                `;
            });
        }
        
        // Adiciona a linha de total na tabela
        tbody.innerHTML += `
            <tr style="background: #f8f9fa;">
                <td style="font-weight: bold;">TOTAL</td>
                <td class="text-right contabilidade-total">R$ ${valorTotalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            </tr>
        `;

        resultadoDiv.style.display = 'block';

    } catch (error) {
        console.error("Erro ao calcular valor total:", error);
        alert("Erro ao buscar dados ou calcular: " + error.message);
    } finally {
        // Restaura o bot√£o, independente de sucesso ou erro
        btn.disabled = false;
        btn.textContent = 'üîÑ Calcular Valor Total';
    }
}

        // =============================================================================
        // HELPERS MODAL
        // =============================================================================
        window.onclick = function(event) {
            if (event.target == document.getElementById('modalConferencia')) {
                fecharModalConferencia();
            }
        }
    </script>
</body>
</html>