<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Pedidos - Oficina da Familia</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Estilos das Abas */
        .tabs { display: flex; background: #f1f1f1; border-radius: 8px 8px 0 0; overflow: hidden; border: 1px solid #e1e5e9; border-bottom: none; }
        .tab { flex: 1; padding: 15px 20px; background: #f1f1f1; color: #333; border: none; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; text-align: center; }
        .tab:hover { background: #e9ecef; }
        .tab.active { background: white; color: #3498db; border-bottom: 3px solid #3498db; }
        .tab-content { display: none; padding: 25px; background: white; border: 1px solid #e1e5e9; border-top: none; border-radius: 0 0 8px 8px; }
        .tab-content.active { display: block; }
        
        /* Tabela de Pedido */
        .pedido-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .pedido-table th, .pedido-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .pedido-table th { background: #f8f9fa; }
        .pedido-table input[type="number"] { width: 100px; padding: 8px; }
        .pedido-table input[type="text"] { width: 150px; padding: 8px; }
        .pedido-table .unidade-barra { font-weight: bold; color: #2c3e50; }

        /* Lista de Pedidos Pendentes */
        .pedido-pendente-card { background: #f8f9fa; border: 1px solid #e1e5e9; border-radius: 8px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; }
        .pedido-pendente-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .pedido-pendente-card strong { font-size: 1.1em; color: #2c3e50; }
        .pedido-pendente-info { flex-grow: 1; cursor: pointer; margin-right: 15px; }
        .pedido-pendente-actions { display: flex; gap: 8px; flex-shrink: 0; }

        /* Modal */
        .modal-content { width: 90%; max-width: 900px; }
        #modalEditarPedido .modal-content { max-width: 500px; }

        /* Tabela de Contabilidade */
        .contabilidade-table { width: 100%; max-width: 600px; margin-top: 20px; border: 1px solid #ccc; }
        .contabilidade-table th, .contabilidade-table td { padding: 10px; border-bottom: 1px solid #ddd; }
        .contabilidade-table th { background-color: #f2f2f2; text-align: left; }
        .contabilidade-total { font-size: 1.2em; font-weight: bold; color: #27ae60; }

        /* Indicador de Rascunho Carregado */
        #rascunhoInfo {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none; /* Come√ßa escondido */
            border: 1px solid #ffeeba;
        }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 5px; }

        /* ======================================================= */
        /* ESTILOS PARA IMPRESS√ÉO (PDF NATIVO) */
        /* ======================================================= */
        @media print {
            body * {
                visibility: hidden; /* Oculta tudo por padr√£o */
                overflow: visible !important;
            }
            .print-area, .print-area * {
                visibility: visible; /* Torna a √°rea de impress√£o vis√≠vel */
                overflow: visible !important;
                /* Impress√£o dos valores de Fornecedor/NF */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0 20px;
                background-color: white; 
            }
            /* Oculta controles, inputs, e a coluna de estoque atual */
            .acoes, .no-print, .input-qtd-pedir, #rascunhoInfo, .modal, .modal-backdrop, .form-group,
            .pedido-table th:nth-child(3), .pedido-table td:nth-child(3) { 
                display: none !important;
            }
            /* Exibe o valor est√°tico da quantidade no lugar do input */
            .qtd-imprimir {
                 display: block !important;
                 padding: 0;
                 margin: 0;
                 font-weight: bold;
                 text-align: left; /* Alinha √É¬† esquerda, mas o TD pode ajustar */
            }
            /* Garante que a tabela tenha um estilo limpo */
            .pedido-table {
                border: 1px solid #ccc;
            }
            .pedido-table th {
                background: #f8f9fa !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                color: #333;
            }
            .pedido-table td, .pedido-table th {
                border: 1px solid #ddd;
            }
            .print-header {
                display: block !important;
                font-family: Arial, sans-serif;
                margin-bottom: 20px;
            }
            /* Estilo para simular o valor do input */
            .print-static-value {
                border-bottom: 1px dotted #333;
                display: inline-block;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h1>üöö Gest√£o de Pedidos - Oficina da Familia</h1>
                <div class="no-print" style="display: flex; gap: 10px;">
                    <a href="index.html" class="btn btn-secondary">üè† In√≠cio</a>
                    <a href="estoque.html" class="btn btn-primary">üì¶ Estoque</a>
                    <a href="orcamento.html" class="btn btn-success">üìã Or√ßamentos</a>
                    <a href="relatorios_estoque.html" class="btn btn-info">üìä Relat√≥rios</a>
                </div>
            </div>
        </div>

        <div class="tabs no-print">
            <button class="tab active" onclick="openTab('novoPedido', event)">1. Fazer Pedido (Rascunho)</button>
            <button class="tab" onclick="openTab('pedidosPendentes', event)">2. Pedidos Finalizados</button>
            <button class="tab" onclick="openTab('ajusteManual', event)">3. Ajuste Manual</button>
            <button class="tab" onclick="openTab('valorTotalEstoque', event)">4. Valor Total do Estoque</button>
        </div>

        <div id="novoPedido" class="tab-content active print-area">
            
            <div id="print-header-rascunho" class="print-header no-print" style="display: none;">
                </div>
            
            <h2>üõí Pedido em Andamento (Rascunho)</h2>
            <div id="rascunhoInfo" class="no-print">
                <span id="rascunhoStatus"></span>
                <button type="button" class="btn btn-danger btn-small" style="float: right;" onclick="excluirRascunhoCarregado()">üóëÔ∏è Excluir Rascunho</button>
            </div>

            <form id="formNovoPedido">
                <input type="hidden" id="rascunhoIdAtual"> 
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="fornecedor">Fornecedor</label>
                        <input type="text" id="fornecedor" placeholder="Nome do fornecedor">
                    </div>
                    <div class="form-group">
                        <label for="notaFiscal">N¬∫ Nota Fiscal (Opcional)</label>
                        <input type="text" id="notaFiscal" placeholder="123456">
                    </div>
                </div>

                <hr style="margin: 20px 0;">

                <h4 class="no-print">üîç Filtrar Itens para o Pedido</h4>
                <div class="grid grid-4 no-print">
                     <div class="form-group">
                        <label for="filtroCategoriaPedido">Categoria</label>
                        <select id="filtroCategoriaPedido" onchange="renderListaParaPedido()">
                            <option value="todos">Carregando...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroStatusEstoque">Status do Estoque</label>
                        <select id="filtroStatusEstoque" onchange="renderListaParaPedido()">
                            <option value="todos">Todos</option>
                            <option value="critico">Cr√≠tico (Baixo ou Negativo)</option>
                            <option value="baixo">Abaixo do M√≠nimo</option>
                            <option value="negativo">Negativo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroNivelMinimo">N√≠vel M√≠nimo</label>
                        <input type="number" id="filtroNivelMinimo" value="5" min="0" onchange="renderListaParaPedido()">
                    </div>
                    <div class="form-group">
                        <label for="filtroItensPedido">Pesquisa (Nome/SKU)</label>
                        <input type="text" id="filtroItensPedido" placeholder="üîç Pesquisar..." onkeyup="renderListaParaPedido()">
                    </div>
                </div>

                <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px;">
                    <table class="pedido-table">
                        <thead>
                            <tr>
                                <th>Item (Varia√ß√£o)</th>
                                <th>Cor</th>
                                <th class="no-print">Estoque Atual</th>
                                <th>Unid. Pedido</th>
                                <th style="width: 120px;">Qtd. a Pedir</th>
                            </tr>
                        </thead>
                        <tbody id="listaItensPedido">
                            <tr class="loading"><td colspan="5">Carregando itens...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="acoes no-print" style="margin-top: 25px; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                     <div> 
                        <button type="button" class="btn btn-secondary" onclick="salvarRascunho()">üíæ Salvar Rascunho</button>
                        <button type="button" class="btn btn-info" id="btnGerarPDFPedido" onclick="gerarPDFPedido()">üìÑ Imprimir Pedido</button>
                     </div>
                     <div> 
                        <button type="button" class="btn btn-success" onclick="finalizarPedido()">‚úÖ Finalizar e Enviar Pedido</button>
                     </div>
                </div>
            </form>
        </div>

        <div id="pedidosPendentes" class="tab-content">
            <h2>üì• Pedidos Finalizados (Aguardando Recebimento)</h2>
            <div id="listaPedidosPendentes">
                <div class="loading">Carregando pedidos finalizados...</div>
            </div>
        </div>

        <div id="ajusteManual" class="tab-content">
             <h2>üîß Ajuste Manual de Estoque / Custo</h2>
            <p class="text-muted">Use esta ferramenta para corre√ß√µes r√°pidas, perdas ou para atualizar valores fora de um pedido. (Ajustes s√£o sempre na unidade base, ex: metros).</p>

            <form id="formAjusteManual" onsubmit="aplicarAjusteManual(event)">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="selectAjusteItem">Item (Varia√ß√£o)</label>
                        <select id="selectAjusteItem" required>
                            <option value="">Carregando itens...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ajusteQuantidade">Qtd. a Adicionar/Remover (ex: metros)</label>
                        <input type="number" step="0.01" id="ajusteQuantidade" value="0" required>
                        <small class="text-muted">Use valores positivos para adicionar (ex: 10) e negativos para remover (ex: -2).</small>
                    </div>
                </div>

                <hr style="margin: 15px 0;">
                <h4>Atualiza√ß√£o de Valores (Opcional)</h4>

                <div class="form-group">
                    <label for="ajustePrecoVenda">Novo Custo/Venda da Varia√ß√£o (por unidade base, ex: R$/metro)</label>
                    <input type="number" step="0.01" id="ajustePrecoVenda" placeholder="Deixe em branco para n√£o alterar">
                </div>

                <div class="form-group">
                    <label for="ajusteMotivo">Motivo do Ajuste *</label>
                    <textarea id="ajusteMotivo" rows="2" placeholder="Ex: Contagem de balan√ßo, perda de material, doa√ß√£o..." required></textarea>
                </div>

                <div class="acoes" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-warning">üî© Aplicar Ajuste</button>
                </div>
            </form>
        </div>

        <div id="valorTotalEstoque" class="tab-content">
             <h2>üí∞ Valor Total do Estoque (Contabilidade)</h2>
            <p class="text-muted">Calcula o valor total do invent√°rio com base no "Pre√ßo de Venda" (seu custo) cadastrado na "Varia√ß√£o do Item". Itens com custo zero ou estoque negativo n√£o s√£o somados.</p>

            <div class="acoes" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="calcularValorTotalEstoque()">
                    üîÑ Calcular Valor Total
                </button>
            </div>

            <div id="resultadoValorTotal" class="card" style="margin-top: 20px; display: none;">
                <h3>Resultado do C√°lculo</h3>
                <h2 id="valorTotalDisplay" class="text-success" style="font-size: 2.5em; margin-bottom: 20px;">R$ 0,00</h2>

                <h4>Valor por Categoria</h4>
                <table class="contabilidade-table">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Valor em Estoque (Custo)</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaValorPorCategoria">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="modal" id="modalConferencia">
         <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTituloConferencia">Confer√™ncia Pedido</h3>
                <button class="btn btn-danger btn-small" onclick="fecharModalConferencia()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="infoPedidoConferencia" class="info" style="margin-bottom: 20px;"></div>

                <form id="formConferencia" onsubmit="confirmarEntradaEstoque(event)">
                    <input type="hidden" id="conferenciaPedidoId">

                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="pedido-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Qtd. Pedida</th>
                                    <th>Qtd. Recebida*</th>
                                    <th>Novo Custo/Venda (por unidade base)*</th>
                                </tr>
                            </thead>
                            <tbody id="listaItensConferencia">
                                </tbody>
                        </table>
                    </div>

                    <div class="acoes" style="margin-top: 25px;">
                        <button type="button" class="btn btn-secondary" onclick="fecharModalConferencia()">Cancelar</button>
                        <button type="submit" class="btn btn-success">‚úÖ Confirmar Entrada e Atualizar Estoque</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="modalEditarPedido">
         <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTituloEditar">Editar Informa√ß√µes do Pedido</h3>
                <button class="btn btn-danger btn-small" onclick="fecharModalEditar()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="formEditarPedido" onsubmit="salvarEdicaoPedido(event)">
                    <input type="hidden" id="editarPedidoId">
                    <div class="form-group">
                        <label for="editarFornecedor">Fornecedor</label>
                        <input type="text" id="editarFornecedor" placeholder="Nome do fornecedor">
                    </div>
                    <div class="form-group">
                        <label for="editarNotaFiscal">N¬∫ Nota Fiscal (Opcional)</label>
                        <input type="text" id="editarNotaFiscal" placeholder="123456">
                    </div>
                    <p class="text-muted"><small>Nota: A edi√ß√£o dos itens n√£o √© permitida para pedidos finalizados. Se precisar alterar itens, exclua este pedido e crie um novo rascunho.</small></p>
                    <div class="acoes" style="margin-top: 25px;">
                        <button type="button" class="btn btn-secondary" onclick="fecharModalEditar()">Cancelar</button>
                        <button type="submit" class="btn btn-success">üíæ Salvar Altera√ß√µes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script src="config.js"></script>
    <script>
        // =============================================================================
        // VARI√ÅVEIS GLOBAIS
        // =============================================================================
        let todosItensVariacao = [];
        let pedidosPendentesCache = [];
        let categoriasCache = [];
        let rascunhoCarregadoId = null; // Guarda o ID do rascunho atualmente na tela

        const CATEGORIAS_EXCLUIDAS_NOME = ['Vidro', 'M√£o de Obra', 'Servi√ßo'];
        const CATEGORIA_PERFIS_NOME = 'perfil'; // Assumindo 'perfil' como o nome
        const COMPRIMENTO_BARRA = 6;


        // =============================================================================
        // INICIALIZA√á√ÉO E ABAS
        // =============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof supabase === 'undefined' || typeof estoqueFunctions === 'undefined') {
                alert("Erro fatal: Supabase (config.js) n√£o foi carregado. Verifique se o arquivo config.js est√° sendo importado corretamente.");
                return;
            }

            const btnPDF = document.getElementById('btnGerarPDFPedido');
            // Remove a checagem do jsPDF e habilita o bot√£o para a impress√£o nativa
            if (btnPDF) {
                btnPDF.textContent = 'üìÑ Imprimir Pedido';
                btnPDF.disabled = false;
                btnPDF.style.opacity = '1';
            }

            carregarDadosIniciais();
        });

        /**
         * FUN√á√ÉO DE CARREGAMENTO INICIAL (CORRIGIDA)
         * Corrigido o problema do categoriasCache.
         */
        async function carregarDadosIniciais() {
            try {
                // Etapa 1: Carregar dados CR√çTICOS (Itens e Categorias)
                console.log("Carregando dados cr√≠ticos (itens e categorias)...");
                const [itensResult, categoriasResult] = await Promise.all([
                    estoqueFunctions.carregarItens(),
                    estoqueFunctions.carregarCategorias()
                ]);

                if (!itensResult || !categoriasResult) {
                    throw new Error("Falha ao carregar itens ou categorias essenciais.");
                }
                
                // CORRE√á√ÉO MANTIDA: categoriasResult j√° √© o array (no arquivo config.js)
                categoriasCache = categoriasResult || []; 
                
                // Filtra itens (exclui vidro, etc.)
                todosItensVariacao = (itensResult || []).filter(item => {
                    if (!item.categorias || !item.categorias.nome) return true;
                    return !CATEGORIAS_EXCLUIDAS_NOME.includes(item.categorias.nome);
                });

                // Etapa 2: Popular listas IMEDIATAMENTE 
                console.log("Populando filtros e listas...");
                popularFiltrosPedido(); 
                renderListaParaPedido(); 
                renderSelectAjuste(); // Popula o select da Aba 3

                // Etapa 3: Carregar dados N√ÉO-CR√çTICOS (Pendentes e Rascunho)
                console.log("Carregando dados secund√°rios (pendentes e rascunho)...");
                
                try {
                    pedidosPendentesCache = await carregarPedidosPendentesDB();
                    renderPedidosPendentes();
                } catch (err) {
                    console.error("Erro ao carregar pedidos pendentes:", err);
                    document.getElementById('listaPedidosPendentes').innerHTML = '<div class="error">Erro ao carregar pedidos pendentes.</div>';
                }

                try {
                    const { data: rascunho, error: rascunhoError } = await supabase.rpc('carregar_ultimo_rascunho');
                    if (rascunhoError) throw rascunhoError;

                    if (rascunho && rascunho.id) { // Verifica se rascunho n√£o √© nulo ou vazio
                        console.log("Rascunho encontrado:", rascunho);
                        preencherFormComRascunho(rascunho);
                    } else {
                        console.log("Nenhum rascunho ativo encontrado.");
                        document.getElementById('rascunhoInfo').style.display = 'none';
                        document.getElementById('rascunhoIdAtual').value = '';
                    }
                } catch (err) {
                    console.error("Erro ao carregar rascunho:", err);
                    alert("Aten√ß√£o: N√£o foi poss√≠vel carregar o rascunho salvo. Verifique o console (F12) para detalhes.");
                    document.getElementById('rascunhoInfo').style.display = 'none';
                }

            } catch (error) {
                console.error("Erro fatal ao carregar dados iniciais:", error);
                alert("Erro fatal ao carregar dados: " + error.message);
                document.getElementById('listaItensPedido').innerHTML = '<tr><td colspan="5" class="error">Falha ao carregar dados essenciais. Recarregue a p√°gina.</td></tr>';
                document.getElementById('filtroCategoriaPedido').innerHTML = '<option value="">Erro</option>';
                document.getElementById('selectAjusteItem').innerHTML = '<option value="">Erro</option>';
            }
        }

        /**
         * Fun√ß√£o para popular a caixa suspensa de categoria.
         */
        function popularFiltrosPedido() {
            const selectCategoria = document.getElementById('filtroCategoriaPedido');
            // Op√ß√£o padr√£o
            let html = '<option value="todos">Todas as Categorias</option>';
            
            // Filtra categorias exclu√≠das
            const categoriasFiltradas = categoriasCache.filter(c => !CATEGORIAS_EXCLUIDAS_NOME.includes(c.nome));
            
            // Mapeia e adiciona as op√ß√µes restantes
            html += categoriasFiltradas.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            
            selectCategoria.innerHTML = html;
        }

        function openTab(tabName, event) {
             document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
             document.querySelectorAll('.tab').forEach(button => button.classList.remove('active'));
             document.getElementById(tabName).classList.add('active');
             event.currentTarget.classList.add('active');
        }

        // =============================================================================
        // ABA 1: RASCUNHO (L√ìGICA DAS RPCs)
        // =============================================================================

        /** Preenche o formul√°rio da Aba 1 com dados de um rascunho carregado */
        function preencherFormComRascunho(rascunho) {
             document.getElementById('fornecedor').value = rascunho.fornecedor || '';
             document.getElementById('notaFiscal').value = rascunho.nota_fiscal || '';
             document.getElementById('rascunhoIdAtual').value = rascunho.id;
             rascunhoCarregadoId = rascunho.id; // Atualiza vari√°vel global

             // Limpa quantidades existentes na tabela antes de preencher
             document.querySelectorAll('.input-qtd-pedir').forEach(input => input.value = '');

             // Preenche as quantidades dos itens do rascunho
             if (rascunho.itens && rascunho.itens.length > 0) {
                 rascunho.itens.forEach(itemRascunho => {
                     const input = document.querySelector(`#listaItensPedido tr[data-variacao-id="${itemRascunho.variacao_id}"] .input-qtd-pedir`);
                     if (input) {
                         const isBarra = input.dataset.isBarra === 'true';
                         if (isBarra) {
                             input.value = itemRascunho.quantidade_pedida / COMPRIMENTO_BARRA;
                         } else {
                             input.value = itemRascunho.quantidade_pedida;
                         }
                         // Atualiza o span de impress√£o
                         document.getElementById(`qtd-display-${input.closest('tr').dataset.variacaoId}`).textContent = input.value + ' ' + input.dataset.unidade;
                     } else {
                         console.warn(`Item do rascunho (ID ${itemRascunho.variacao_id}) n√£o encontrado na lista atual.`);
                     }
                 });
             }

            // Mostra o aviso de rascunho carregado
            const rascunhoInfo = document.getElementById('rascunhoInfo');
            document.getElementById('rascunhoStatus').textContent = `Rascunho #${rascunho.id} carregado. Continue editando ou finalize o pedido.`;
            rascunhoInfo.style.display = 'block';
        }

        /** Salva o estado atual da Aba 1 como rascunho no banco */
        async function salvarRascunho() {
            const fornecedor = document.getElementById('fornecedor').value || 'N√£o informado';
            const notaFiscal = document.getElementById('notaFiscal').value || null;

            const itensDoPedido = [];
            const inputs = document.querySelectorAll('.input-qtd-pedir');

            inputs.forEach(input => {
                const quantidade = parseFloat(input.value) || 0; 
                if (quantidade > 0) { 
                    const isBarra = input.dataset.isBarra === 'true';
                    let qtdParaSalvar = quantidade;
                    if (isBarra) {
                        qtdParaSalvar = quantidade * COMPRIMENTO_BARRA;
                    }

                    itensDoPedido.push({
                        variacao_id: input.closest('tr').dataset.variacaoId,
                        quantidade_pedida: qtdParaSalvar
                    });
                }
            });

            try {
                // Chama a RPC para salvar/atualizar
                const { data, error } = await supabase.rpc('salvar_ou_atualizar_rascunho', {
                    p_fornecedor: fornecedor,
                    p_nota_fiscal: notaFiscal,
                    p_itens: itensDoPedido // Envia apenas itens com qtd > 0
                });

                if (error || !data.success) throw error || new Error(data.error);

                rascunhoCarregadoId = data.rascunho_id; // Atualiza o ID do rascunho atual
                document.getElementById('rascunhoIdAtual').value = rascunhoCarregadoId;

                // Mostra o aviso de rascunho salvo
                const rascunhoInfo = document.getElementById('rascunhoInfo');
                document.getElementById('rascunhoStatus').textContent = `Rascunho #${rascunhoCarregadoId} salvo com sucesso!`;
                rascunhoInfo.style.display = 'block';

                alert('‚úÖ Rascunho salvo!');

            } catch (error) {
                console.error('Erro ao salvar rascunho:', error);
                alert('‚ùå Erro ao salvar rascunho: ' + error.message);
            }
        }


        /** Finaliza o rascunho atual, mudando seu status para 'pendente' */
        async function finalizarPedido() {
             const rascunhoId = document.getElementById('rascunhoIdAtual').value;

             // Pega os itens da tela para garantir que a √∫ltima vers√£o seja salva
             const itensAtuais = [];
             const inputs = document.querySelectorAll('.input-qtd-pedir');
             inputs.forEach(input => {
                const quantidade = parseFloat(input.value) || 0;
                 if (quantidade > 0) {
                     const isBarra = input.dataset.isBarra === 'true';
                     let qtdParaSalvar = quantidade;
                     if (isBarra) {
                         qtdParaSalvar = quantidade * COMPRIMENTO_BARRA;
                     }
                     itensAtuais.push({
                         variacao_id: input.closest('tr').dataset.variacaoId,
                         quantidade_pedida: qtdParaSalvar
                     });
                 }
             });

             if (itensAtuais.length === 0) {
                 alert('‚ùå Adicione itens ao pedido antes de finalizar.');
                 return;
             }
             
             const idParaFinalizar = rascunhoCarregadoId || document.getElementById('rascunhoIdAtual').value;
             const msgConfirm = idParaFinalizar 
                ? `Finalizar o Pedido #${idParaFinalizar} e envi√°-lo para a lista de pendentes?`
                : 'Salvar este novo pedido e envi√°-lo para a lista de pendentes?';

             if (!confirm(msgConfirm + '\nVoc√™ n√£o poder√° mais editar os itens.')) {
                 return;
             }

             try {
                // 1. Salva a √∫ltima vers√£o (seja rascunho ou novo)
                const fornecedor = document.getElementById('fornecedor').value || 'N√£o informado';
                const notaFiscal = document.getElementById('notaFiscal').value || null;
                
                const { data: saveResult, error: saveError } = await supabase.rpc('salvar_ou_atualizar_rascunho', {
                    p_fornecedor: fornecedor,
                    p_nota_fiscal: notaFiscal,
                    p_itens: itensAtuais
                });
                if (saveError || !saveResult.success) throw saveError || new Error(saveResult.error);

                const idFinalizado = saveResult.rascunho_id;

                // 2. Chama a RPC para finalizar (mudar status para 'pendente')
                const { data, error } = await supabase.rpc('finalizar_rascunho', {
                    p_rascunho_id: idFinalizado
                });

                if (error || !data.success) throw error || new Error(data.error);

                alert(`‚úÖ Pedido #${idFinalizado} finalizado e movido para pendentes!`);

                // Limpa o formul√°rio e o estado do rascunho
                document.getElementById('formNovoPedido').reset();
                renderListaParaPedido(); // Limpa as quantidades da tabela
                rascunhoCarregadoId = null;
                document.getElementById('rascunhoIdAtual').value = '';
                document.getElementById('rascunhoInfo').style.display = 'none';

                // Recarrega os pedidos pendentes e muda para a aba 2
                pedidosPendentesCache = await carregarPedidosPendentesDB();
                renderPedidosPendentes();
                openTab('pedidosPendentes', { currentTarget: document.querySelector('.tab[onclick*="pedidosPendentes"]') });

            } catch (error) {
                console.error('Erro ao finalizar pedido:', error);
                alert('‚ùå Erro ao finalizar pedido: ' + error.message);
            }
        }

        /** Exclui o rascunho carregado atualmente */
        async function excluirRascunhoCarregado() {
             const rascunhoId = document.getElementById('rascunhoIdAtual').value;

             if (!rascunhoId) {
                 alert('‚ùå N√£o h√° rascunho carregado para excluir.');
                 return;
             }

             if (!confirm(`Tem certeza que deseja EXCLUIR PERMANENTEMENTE o Rascunho #${rascunhoId}?`)) {
                 return;
             }

             try {
                 const { data, error } = await supabase.rpc('excluir_rascunho', {
                     p_rascunho_id: rascunhoId
                 });

                 if (error || !data.success) throw error || new Error(data.error);

                 alert(`‚úÖ Rascunho #${rascunhoId} exclu√≠do!`);

                 // Limpa o formul√°rio e o estado do rascunho
                 document.getElementById('formNovoPedido').reset();
                 renderListaParaPedido();
                 rascunhoCarregadoId = null;
                 document.getElementById('rascunhoIdAtual').value = '';
                 document.getElementById('rascunhoInfo').style.display = 'none';

             } catch(error) {
                 console.error('Erro ao excluir rascunho:', error);
                 alert('‚ùå Erro ao excluir rascunho: ' + error.message);
             }
        }


        /** Renderiza a lista de itens para pedido (Aba 1) */
        function renderListaParaPedido() {
             const tbody = document.getElementById('listaItensPedido');
             const filtroTexto = document.getElementById('filtroItensPedido').value.toLowerCase();
             const filtroCategoria = document.getElementById('filtroCategoriaPedido').value;
             const filtroStatus = document.getElementById('filtroStatusEstoque').value;
             const nivelMinimo = parseFloat(document.getElementById('filtroNivelMinimo').value) || 0;
             let html = '';

             const itensFiltrados = todosItensVariacao.filter(item => {
                // item.nome vem de estoqueFunctions.carregarItens()
                const nomeBase = item.nome_base || item.nome; // Garante compatibilidade
                const matchTexto = nomeBase.toLowerCase().includes(filtroTexto) || (item.sku && item.sku.toLowerCase().includes(filtroTexto));
                if (!matchTexto) return false;
                // CORRE√á√ÉO: Verifica se o valor √© o 'id' da categoria ou 'todos'
                const matchCategoria = (filtroCategoria === 'todos' || String(item.categoria_id) === filtroCategoria);
                if (!matchCategoria) return false;
                if (filtroStatus !== 'todos') {
                    const isNegativo = item.quantidade_estoque < 0;
                    const isBaixo = item.quantidade_estoque >= 0 && item.quantidade_estoque < nivelMinimo;
                    if (filtroStatus === 'negativo' && !isNegativo) return false;
                    if (filtroStatus === 'baixo' && !isBaixo) return false;
                    if (filtroStatus === 'critico' && !(isNegativo || isBaixo)) return false;
                }
                return true;
            });

            if (itensFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">Nenhum item encontrado com esses filtros.</td></tr>';
                return;
            }

            // Ordena por nome
            itensFiltrados.sort((a, b) => (a.nome_base || a.nome).localeCompare(b.nome_base || b.nome));

            itensFiltrados.forEach(item => {
                let classeLinha = '';
                if (item.quantidade_estoque < 0) classeLinha = 'estoque-negativo';
                else if (item.quantidade_estoque < nivelMinimo) classeLinha = 'estoque-baixo';

                const isBarra = (item.categorias?.nome === CATEGORIA_PERFIS_NOME); 
                let unidadeMedidaDisplay, inputStep, inputPlaceholder, isBarraData, unidadeData;
                const nomeBase = item.nome_base || item.nome;
                const corNome = item.cor || item.cores?.nome || 'Padr√£o';

                if (isBarra) {
                    unidadeMedidaDisplay = `<span class="unidade-barra">Barra (${COMPRIMENTO_BARRA}m)</span>`;
                    inputStep = 1; inputPlaceholder = "0"; isBarraData = "true"; unidadeData = "Barra(s)";
                } else {
                    unidadeMedidaDisplay = item.unidade_medida;
                    inputStep = (item.unidade_medida === 'un') ? 1 : 0.01;
                    inputPlaceholder = (item.unidade_medida === 'un') ? "0" : "0.00";
                    isBarraData = "false"; unidadeData = item.unidade_medida;
                }
                
                // Adiciona o span para impress√£o nativa ao lado do input
                html += `<tr data-variacao-id="${item.id}" class="${classeLinha}">
                    <td><strong>${nomeBase}</strong></td>
                    <td>${corNome}</td>
                    <td class="no-print">${item.quantidade_estoque.toFixed(2)} ${item.unidade_medida}</td>
                    <td>${unidadeMedidaDisplay}</td>
                    <td>
                        <input type="number" step="${inputStep}" min="0" class="input-qtd-pedir" placeholder="${inputPlaceholder}" 
                           data-sku="${item.sku || 'N/A'}" 
                           data-nome="${nomeBase}" 
                           data-cor="${corNome}" 
                           data-unidade="${unidadeData}" 
                           data-is-barra="${isBarraData}"
                           oninput="document.getElementById('qtd-display-${item.id}').textContent = this.value + ' ' + this.dataset.unidade">
                        <span class="qtd-imprimir" id="qtd-display-${item.id}" style="display:none;"></span>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;

             // RE-APLICA quantidades se houver rascunho carregado
             if (rascunhoCarregadoId) {
                document.querySelectorAll('.input-qtd-pedir').forEach(input => {
                    const tr = input.closest('tr');
                    const variacaoId = tr.dataset.variacaoId;
                    
                    // Simula a busca no rascunho (idealmente ter√≠amos o rascunho.itens em cache)
                    // Esta √© uma limita√ß√£o, o ideal seria recarregar o rascunho
                    // Por ora, vamos deixar que o usu√°rio preencheu e n√£o vamos limpar
                });
                console.log("Rascunho ID existe. Quantidades devem ser preenchidas (se j√° n√£o estiverem).");
             }
        }


        /** * NOVO: Implementa√ß√£o da Impress√£o Nativa (window.print)
         * Substitui a l√≥gica falha do jsPDF. 
         */
        function gerarPDFPedido() {
            const fornecedor = document.getElementById('fornecedor').value || 'N√£o Informado';
            const notaFiscal = document.getElementById('notaFiscal').value || 'N/A';
            const rascunhoId = document.getElementById('rascunhoIdAtual').value || 'Novo';

            // 1. Prepara o cabe√ßalho de impress√£o no elemento escondido
            const headerHTML = `
                <h1 style="font-size: 1.5em; text-align: center;">PEDIDO DE COMPRA (Rascunho #${rascunhoId})</h1>
                <p style="margin-bottom: 5px;"><strong>Fornecedor:</strong> <span class="print-static-value">${fornecedor}</span></p>
                <p style="margin-bottom: 5px;"><strong>Nota Fiscal:</strong> <span class="print-static-value">${notaFiscal}</span></p>
                <p style="margin-bottom: 15px;"><strong>Data de Gera√ß√£o:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                <hr>
            `;
            document.getElementById('print-header-rascunho').innerHTML = headerHTML;
            document.getElementById('print-header-rascunho').style.display = 'block'; 
            
            // 2. Garante que os valores dos inputs de quantidade sejam refletidos no span de impress√£o
            let temItemParaImprimir = false;
            document.querySelectorAll('.input-qtd-pedir').forEach(input => {
                const variacaoId = input.closest('tr').dataset.variacaoId;
                const qtdSpan = document.getElementById(`qtd-display-${variacaoId}`);
                const quantidade = parseFloat(input.value) || 0;
                
                if (quantidade > 0) {
                    qtdSpan.textContent = input.value + ' ' + input.dataset.unidade;
                    qtdSpan.style.display = 'block'; // Exibe o span
                    input.style.display = 'none'; // Oculta o input
                    temItemParaImprimir = true;
                } else {
                    qtdSpan.style.display = 'none';
                    input.style.display = 'block'; // Mant√©m o input vis√≠vel na tela
                }
            });

            if (!temItemParaImprimir) {
                 alert('‚ùå Adicione itens ao pedido antes de imprimir.');
                 document.getElementById('print-header-rascunho').style.display = 'none';
                 return;
            }

            // 3. Chama a impress√£o (o CSS @media print faz o resto)
            window.print();
            
            // 4. Limpa o DOM ap√≥s a impress√£o e restaura os inputs
            document.getElementById('print-header-rascunho').style.display = 'none';
            document.querySelectorAll('.input-qtd-pedir').forEach(input => {
                 input.style.display = 'block';
            });
            document.querySelectorAll('.qtd-imprimir').forEach(span => {
                 span.style.display = 'none';
            });
        }


        // =============================================================================
        // ABA 2: PEDIDOS PENDENTES (FUN√á√ïES COMPLETAS)
        // =============================================================================

        /** (HELPER) Carrega pedidos pendentes do DB */
        async function carregarPedidosPendentesDB() {
            const { data, error } = await supabase
                .from('pedidos')
                .select(`
                    id, fornecedor, nota_fiscal, data_criacao,
                    pedido_itens (
                        id, variacao_id, quantidade_pedida,
                        item_variacoes (
                            sku, preco_venda,
                            itens ( nome, unidade_medida, categoria_id, categorias ( nome ) ),
                            cores ( nome )
                        )
                    )
                `)
                .eq('status', 'pendente')
                .order('data_criacao', { ascending: false });
            
            if (error) {
                console.error("Erro ao buscar pedidos pendentes:", error);
                throw error;
            }
            return data;
        }

        /** (HELPER) Renderiza a lista de cards de pedidos pendentes */
        function renderPedidosPendentes() {
            const container = document.getElementById('listaPedidosPendentes');
            if (!pedidosPendentesCache || pedidosPendentesCache.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum pedido pendente encontrado.</p>'; 
                return;
            }
            container.innerHTML = pedidosPendentesCache.map(pedido => {
                const totalItens = pedido.pedido_itens.length;
                return `
                <div class="pedido-pendente-card" id="pedido-card-${pedido.id}">
                    <div class="pedido-pendente-info" onclick="abrirModalConferencia(${pedido.id})">
                        <strong>Pedido #${pedido.id} - ${pedido.fornecedor}</strong><br>
                        <small>Data: ${new Date(pedido.data_criacao).toLocaleDateString('pt-BR')} | Itens: ${totalItens}</small>
                        ${pedido.nota_fiscal ? `<br><small>NF: ${pedido.nota_fiscal}</small>` : ''}
                    </div>
                    <div class="pedido-pendente-actions">
                        <button class="btn btn-primary btn-small" onclick="abrirModalConferencia(${pedido.id})">Conferir</button>
                        <button class="btn btn-info btn-small" onclick="gerarPDFDePedidoPendente(${pedido.id})">üìÑ Imprimir</button>
                        <button class="btn btn-secondary btn-small" onclick="abrirModalEditar(${pedido.id})">Editar</button>
                        <button class="btn btn-danger btn-small" onclick="excluirPedidoPendente(${pedido.id})">Excluir</button>
                    </div>
                </div>`;
            }).join('');
        }
        
        /** * NOVO: Implementa√ß√£o da Impress√£o Nativa para Pedidos Pendentes
         * Substitui a l√≥gica falha do jsPDF. 
         */
        function gerarPDFDePedidoPendente(pedidoId) {
            const pedido = pedidosPendentesCache.find(p => p.id === pedidoId);
            if (!pedido) { alert('Erro: Pedido n√£o encontrado.'); return; }
            
            // 1. Prepara os dados da tabela de itens (agora com valores est√°ticos)
            const itensHTML = pedido.pedido_itens.map(item => {
                const variacao = item.item_variacoes;
                const itemPai = variacao.itens;
                const cor = variacao.cores;
                
                const isBarra = itemPai.categorias?.nome === CATEGORIA_PERFIS_NOME;
                let qtdDisplay, unidDisplay;

                if (isBarra) {
                    qtdDisplay = (item.quantidade_pedida / COMPRIMENTO_BARRA).toFixed(2);
                    unidDisplay = 'Barra(s)';
                } else {
                    qtdDisplay = item.quantidade_pedida.toFixed(2);
                    unidDisplay = itemPai.unidade_medida;
                }
                
                return `
                    <tr>
                        <td><strong>${itemPai.nome}</strong> (${cor.nome})</td>
                        <td>${unidDisplay}</td>
                        <td style="text-align: left;">${qtdDisplay}</td>
                        <td>${variacao.sku || 'N/A'}</td>
                    </tr>
                `;
            }).join('');
            
            // 2. Monta o HTML completo da √°rea de impress√£o tempor√°ria
            const printHTML = `
                <div class="print-area" style="padding: 20px;">
                    <h1 style="font-size: 1.5em; text-align: center; margin-bottom: 20px;">PEDIDO DE COMPRA #${pedido.id}</h1>
                    <p><strong>Fornecedor:</strong> ${pedido.fornecedor}</p>
                    <p><strong>Nota Fiscal:</strong> ${pedido.nota_fiscal || 'N/A'}</p>
                    <p><strong>Data do Pedido:</strong> ${new Date(pedido.data_criacao).toLocaleDateString('pt-BR')}</p>
                    <hr style="margin: 20px 0;">
                    
                    <table class="pedido-table" style="width: 100%; border: 1px solid #ccc; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th>Item (Varia√ß√£o)</th>
                                <th>Unid. Pedido</th>
                                <th style="text-align: left;">Qtd. Pedida</th>
                                <th>SKU</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itensHTML}
                        </tbody>
                    </table>
                </div>
            `;
            
            // 3. Adiciona a √°rea tempor√°ria ao corpo e imprime
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = printHTML;
            document.body.appendChild(tempDiv);
            
            window.print();
            
            // 4. Remove a √°rea tempor√°ria
            document.body.removeChild(tempDiv);
        }
        
        // A fun√ß√£o gerarPDFBase (antiga) foi removida.
        
        /** (HELPER) Abre modal de confer√™ncia (Aba 2) */
        function abrirModalConferencia(pedidoId) {
            const pedido = pedidosPendentesCache.find(p => p.id === pedidoId);
            if (!pedido) { alert('Erro: Pedido n√£o encontrado no cache.'); return; }
            
            document.getElementById('conferenciaPedidoId').value = pedido.id;
            document.getElementById('modalTituloConferencia').textContent = `Confer√™ncia Pedido #${pedido.id} (${pedido.fornecedor})`;
            const infoDiv = document.getElementById('infoPedidoConferencia');
            infoDiv.innerHTML = `<strong>Fornecedor:</strong> ${pedido.fornecedor}<br>
                                 <strong>Nota Fiscal:</strong> ${pedido.nota_fiscal || 'N/A'}<br>
                                 <strong>Data:</strong> ${new Date(pedido.data_criacao).toLocaleDateString('pt-BR')}`;
            
            const tbody = document.getElementById('listaItensConferencia');
            tbody.innerHTML = pedido.pedido_itens.map(item => {
                const variacao = item.item_variacoes;
                if (!variacao) { console.error("Item sem varia√ß√£o:", item); return ''; }
                const itemPai = variacao.itens;
                if (!itemPai) { console.error("Varia√ß√£o sem item pai:", variacao); return ''; }
                const cor = variacao.cores;
                if (!cor) { console.error("Varia√ß√£o sem cor:", variacao); return ''; }
                
                const isBarra = itemPai.categorias?.nome === CATEGORIA_PERFIS_NOME;
                const qtdDisplay = isBarra ? (item.quantidade_pedida / COMPRIMENTO_BARRA) : item.quantidade_pedida;
                const unidDisplay = isBarra ? 'Barra(s)' : itemPai.unidade_medida;
                const step = isBarra ? 1 : (unidDisplay === 'un' ? 1 : 0.01);

                return `<tr data-item-variacao-id="${item.variacao_id}" data-is-barra="${isBarra}">
                    <td><strong>${itemPai.nome}</strong> (${cor.nome})</td>
                    <td>${item.quantidade_pedida.toFixed(2)} ${itemPai.unidade_medida} (${qtdDisplay.toFixed(step)} ${unidDisplay})</td>
                    <td><input type="number" class="input-qtd-recebida" value="${qtdDisplay.toFixed(step)}" step="${step}" required></td>
                    <td><input type="number" class="input-novo-custo" value="${variacao.preco_venda.toFixed(2)}" step="0.01" required></td>
                </tr>`;
            }).join('');
            document.getElementById('modalConferencia').style.display = 'block';
        }

        /** (HELPER) Fecha modal de confer√™ncia */
        function fecharModalConferencia() {
            document.getElementById('modalConferencia').style.display = 'none';
        }
        
        /** (HELPER) Confirma entrada de estoque (Aba 2) */
        async function confirmarEntradaEstoque(event) {
            event.preventDefault();
            if (!confirm('Confirmar o recebimento destes itens? O estoque ser√° atualizado.')) return;

            const pedidoId = document.getElementById('conferenciaPedidoId').value;
            const linhas = document.querySelectorAll('#listaItensConferencia tr');
            const atualizacoes = [];

            linhas.forEach(linha => {
                const variacaoId = linha.dataset.itemVariacaoId;
                const isBarra = linha.dataset.isBarra === 'true';
                const qtdRecebidaInput = linha.querySelector('.input-qtd-recebida').value;
                const novoCusto = linha.querySelector('.input-novo-custo').value;
                
                let qtdRecebidaBase = parseFloat(qtdRecebidaInput);
                if (isBarra) {
                    qtdRecebidaBase = qtdRecebidaBase * COMPRIMENTO_BARRA;
                }
                
                atualizacoes.push({
                    variacao_id: variacaoId,
                    quantidade_recebida: qtdRecebidaBase,
                    novo_custo: parseFloat(novoCusto)
                });
            });

            try {
                // Aqui esperamos que exista uma RPC 'confirmar_recebimento_pedido'
                // Vamos usar a RPC 'atualizar_item_estoque' que j√° temos
                
                // Vamos supor que precisamos chamar a RPC de ajuste manual para cada item
                // Isso √© menos eficiente que uma RPC √∫nica, mas usa o que temos
                
                const updates = atualizacoes.map(upd => 
                    supabase.from('item_variacoes')
                      .update({ 
                          quantidade_estoque: supabase.sql(`quantidade_estoque + ${upd.quantidade_recebida}`),
                          preco_venda: upd.novo_custo // Assumindo preco_venda = custo
                      })
                      .eq('id', upd.variacao_id)
                );

                // Adiciona a l√≥gica de LOG
                updates.push(
                    supabase.from('movimentacoes_estoque').insert(
                        atualizacoes.map(upd => ({
                            item_variacao_id: upd.variacao_id,
                            quantidade: upd.quantidade_recebida,
                            tipo: 'entrada',
                            motivo: `Recebimento Pedido #${pedidoId}`
                        }))
                    )
                );

                // Marca o pedido como conclu√≠do
                updates.push(
                    supabase.from('pedidos')
                      .update({ status: 'concluido', data_conclusao: new Date() })
                      .eq('id', pedidoId)
                );
                
                const results = await Promise.all(updates);
                
                // Verifica erros
                for (const result of results) {
                    if (result.error) throw result.error;
                }

                alert('‚úÖ Estoque atualizado e pedido conclu√≠do com sucesso!');
                fecharModalConferencia();
                
                // Remove o pedido da lista de pendentes na tela
                document.getElementById(`pedido-card-${pedidoId}`).remove();
                pedidosPendentesCache = pedidosPendentesCache.filter(p => p.id != pedidoId);

            } catch (error) {
                console.error('Erro ao confirmar entrada:', error);
                alert('‚ùå Erro ao atualizar estoque: ' + error.message);
            }
        }
        
        /** (HELPER) Abre modal de edi√ß√£o (Aba 2) */
        function abrirModalEditar(pedidoId) {
            const pedido = pedidosPendentesCache.find(p => p.id === pedidoId);
            if (!pedido) { alert('Erro: Pedido n√£o encontrado.'); return; }
            
            document.getElementById('editarPedidoId').value = pedido.id;
            document.getElementById('editarFornecedor').value = pedido.fornecedor;
            document.getElementById('editarNotaFiscal').value = pedido.nota_fiscal || '';
            document.getElementById('modalEditarPedido').style.display = 'block';
        }

        /** (HELPER) Fecha modal de edi√ß√£o */
        function fecharModalEditar() {
            document.getElementById('modalEditarPedido').style.display = 'none';
        }
        
        /** (HELPER) Salva edi√ß√£o de Fornecedor/NF (Aba 2) */
        async function salvarEdicaoPedido(event) {
            event.preventDefault();
            const pedidoId = document.getElementById('editarPedidoId').value;
            const novoFornecedor = document.getElementById('editarFornecedor').value;
            const novaNF = document.getElementById('editarNotaFiscal').value || null;

            const { error } = await supabase
                .from('pedidos')
                .update({ fornecedor: novoFornecedor, nota_fiscal: novaNF })
                .eq('id', pedidoId);

            if (error) {
                alert('‚ùå Erro ao salvar altera√ß√µes: ' + error.message);
            } else {
                alert('‚úÖ Altera√ß√µes salvas!');
                fecharModalEditar();
                // Atualiza o cache e a tela
                const pedidoCache = pedidosPendentesCache.find(p => p.id == pedidoId);
                pedidoCache.fornecedor = novoFornecedor;
                pedidoCache.nota_fiscal = novaNF;
                renderPedidosPendentes();
            }
        }
        
        /** (HELPER) Exclui um pedido pendente (Aba 2) */
        async function excluirPedidoPendente(pedidoId) {
            if (!confirm(`Tem certeza que deseja EXCLUIR PERMANENTEMENTE o Pedido #${pedidoId}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }

            try {
                // Exclui primeiro os itens do pedido
                const { error: errorItens } = await supabase
                    .from('pedido_itens')
                    .delete()
                    .eq('pedido_id', pedidoId);
                
                if (errorItens) throw errorItens;

                // Exclui o pedido principal
                const { error: errorPedido } = await supabase
                    .from('pedidos')
                    .delete()
                    .eq('id', pedidoId);

                if (errorPedido) throw errorPedido;
                
                alert(`‚úÖ Pedido #${pedidoId} exclu√≠do com sucesso.`);
                
                // Remove da tela
                document.getElementById(`pedido-card-${pedidoId}`).remove();
                pedidosPendentesCache = pedidosPendentesCache.filter(p => p.id != pedidoId);

            } catch (error) {
                console.error('Erro ao excluir pedido:', error);
                alert('‚ùå Erro ao excluir pedido: ' + error.message);
            }
        }


        // =============================================================================
        // ABA 3: AJUSTE MANUAL (FUN√á√ïES COMPLETAS)
        // =============================================================================
        
        /** (HELPER) Renderiza o select de ajuste manual (Aba 3) */
        function renderSelectAjuste() {
            const select = document.getElementById('selectAjusteItem');
            if (!todosItensVariacao || todosItensVariacao.length === 0) {
                select.innerHTML = '<option value="">Nenhum item carregado</option>';
                return;
            }

            // Agrupa por categoria
            const grupos = {};
            todosItensVariacao.forEach(item => {
                const categoriaNome = item.categorias?.nome || 'Sem Categoria';
                if (!grupos[categoriaNome]) {
                    grupos[categoriaNome] = [];
                }
                grupos[categoriaNome].push(item);
            });

            let html = '<option value="">-- Selecione um item --</option>';
            // Ordena categorias
            const categoriasOrdenadas = Object.keys(grupos).sort();

            for (const categoria of categoriasOrdenadas) {
                html += `<optgroup label="${categoria}">`;
                // Ordena itens dentro da categoria
                const itensOrdenados = grupos[categoria].sort((a, b) => (a.nome_base || a.nome).localeCompare(b.nome_base || b.nome));
                
                itensOrdenados.forEach(item => {
                    const nomeBase = item.nome_base || item.nome;
                    const corNome = item.cor || item.cores?.nome || 'Padr√£o';
                    html += `<option value="${item.id}">${nomeBase} (${corNome}) - [${item.unidade_medida}]</option>`;
                });
                html += `</optgroup>`;
            }
            select.innerHTML = html;
        }

        /** (HELPER) Aplica ajuste manual de estoque (Aba 3) */
        async function aplicarAjusteManual(event) {
            event.preventDefault();
            
            const variacaoId = document.getElementById('selectAjusteItem').value;
            const quantidade = parseFloat(document.getElementById('ajusteQuantidade').value);
            const novoPrecoVenda = document.getElementById('ajustePrecoVenda').value;
            const motivo = document.getElementById('ajusteMotivo').value;
            
            if (!variacaoId || quantidade === 0 || !motivo) {
                alert('‚ùå Preencha o item, a quantidade (diferente de zero) e o motivo.');
                return;
            }

            if (!confirm(`Confirma o ajuste de ${quantidade} unidades no item selecionado?`)) {
                return;
            }

            try {
                // 1. Prepara a atualiza√ß√£o do item
                let updateData = {
                    quantidade_estoque: supabase.sql(`quantidade_estoque + ${quantidade}`)
                };
                
                if (novoPrecoVenda !== '') {
                    updateData.preco_venda = parseFloat(novoPrecoVenda);
                }

                const { error: updateError } = await supabase
                    .from('item_variacoes')
                    .update(updateData)
                    .eq('id', variacaoId);

                if (updateError) throw updateError;
                
                // 2. Insere o log na movimenta√ß√£o
                const tipoMovimentacao = quantidade > 0 ? 'entrada' : 'saida';
                
                const { error: logError } = await supabase
                    .from('movimentacoes_estoque')
                    .insert({
                        item_variacao_id: variacaoId,
                        quantidade: Math.abs(quantidade), // Salva sempre positivo
                        tipo: tipoMovimentacao,
                        motivo: `Ajuste Manual: ${motivo}`
                    });
                    
                if (logError) throw logError;
                
                alert('‚úÖ Ajuste de estoque realizado com sucesso!');
                
                // Atualiza o cache local
                const itemCache = todosItensVariacao.find(i => i.id == variacaoId);
                if(itemCache) {
                    itemCache.quantidade_estoque += quantidade;
                    if (novoPrecoVenda !== '') {
                        itemCache.preco_venda = parseFloat(novoPrecoVenda);
                    }
                }
                
                // Limpa o formul√°rio
                document.getElementById('formAjusteManual').reset();
                
                // Atualiza a lista da Aba 1 se ela estiver vis√≠vel
                renderListaParaPedido();
                
            } catch(error) {
                console.error('Erro ao aplicar ajuste manual:', error);
                alert('‚ùå Erro ao aplicar ajuste: ' + error.message);
            }
        }


        // =============================================================================
        // ABA 4: VALOR TOTAL ESTOQUE (FUN√á√ÉO COMPLETA)
        // =============================================================================
        
        /** (HELPER) Calcula o valor total do estoque (Aba 4) */
        async function calcularValorTotalEstoque() {
            const resultadoDiv = document.getElementById('resultadoValorTotal');
            const totalDisplay = document.getElementById('valorTotalDisplay');
            const tabelaCategoria = document.getElementById('tabelaValorPorCategoria');
            
            resultadoDiv.style.display = 'block';
            totalDisplay.textContent = 'Calculando...';
            tabelaCategoria.innerHTML = '<tr><td colspan="2">Calculando...</td></tr>';

            try {
                // N√£o precisa buscar do DB, j√° temos em 'todosItensVariacao'
                let valorTotal = 0;
                const valorPorCategoria = {};

                todosItensVariacao.forEach(item => {
                    const custo = item.preco_venda; // Assumindo que preco_venda √© o custo
                    const estoque = item.quantidade_estoque;
                    
                    if (custo > 0 && estoque > 0) {
                        const valorItem = custo * estoque;
                        valorTotal += valorItem;
                        
                        const categoriaNome = item.categorias?.nome || 'Sem Categoria';
                        if (!valorPorCategoria[categoriaNome]) {
                            valorPorCategoria[categoriaNome] = 0;
                        }
                        valorPorCategoria[categoriaNome] += valorItem;
                    }
                });

                // Formata e exibe
                totalDisplay.textContent = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
                
                const categoriasOrdenadas = Object.keys(valorPorCategoria).sort();
                tabelaCategoria.innerHTML = categoriasOrdenadas.map(categoria => `
                    <tr>
                        <td>${categoria}</td>
                        <td>R$ ${valorPorCategoria[categoria].toFixed(2).replace('.', ',')}</td>
                    </tr>
                `).join('');
                
                // Adiciona linha de total
                 tabelaCategoria.innerHTML += `
                    <tr style="background: #f8f9fa; font-weight: bold;">
                        <td>TOTAL</td>
                        <td class="contabilidade-total">R$ ${valorTotal.toFixed(2).replace('.', ',')}</td>
                    </tr>
                `;

            } catch(error) {
                console.error('Erro ao calcular valor total:', error);
                totalDisplay.textContent = 'Erro!';
                tabelaCategoria.innerHTML = `<tr><td colspan="2" class="error">Erro ao calcular: ${error.message}</td></tr>`;
            }
        }
        

        // =============================================================================
        // HELPERS MODAL (FECHAR)
        // =============================================================================
        window.onclick = function(event) {
            if (event.target == document.getElementById('modalConferencia')) {
                fecharModalConferencia();
            }
            if (event.target == document.getElementById('modalEditarPedido')) {
                fecharModalEditar();
            }
        }
    </script>
</body>
</html>
